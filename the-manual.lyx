#LyX 2.4 created this file. For more info see https://www.lyx.org/
\lyxformat 620
\begin_document
\begin_header
\save_transient_properties true
\origin unavailable
\textclass scrbook
\begin_preamble
\usepackage{eso-pic}
\usepackage{graphicx}
\usepackage{epigraph}
\usepackage{algpseudocode}
\usepackage[hidelinks]{hyperref}
%\Urlmuskip=0mu plus 1mu
\usepackage[acronym]{glossaries}
\usepackage[automake]{glossaries-extra}
\makeglossaries

\usepackage{verbatim}
\let\verbinput\verbatiminput
\newenvironment{verbquote}{
  \list{}{
    \listparindent 0pt%
    \leftmargin    \parindent%
    \itemindent    \listparindent%
    \rightmargin   \leftmargin
  }%
  \small
  \item[]%
}
{\endlist}

\renewcommand{\verbatiminput}[1]{%
  \begin{verbquote}
    \verbinput{#1}
  \end{verbquote}
}

\DeclareUnicodeCharacter{2205}{\ensuremath{\emptyset}}
\DeclareUnicodeCharacter{222A}{\ensuremath{\cup}}
\DeclareUnicodeCharacter{2208}{\ensuremath{\in}}
\DeclareUnicodeCharacter{2209}{\ensuremath{\notin}}
\DeclareUnicodeCharacter{2260}{\ensuremath{\neq}}
\DeclareUnicodeCharacter{2203}{\ensuremath{\exists}}
\DeclareUnicodeCharacter{2588}{\textblock}
\end_preamble
\use_default_options true
\begin_modules
logicalmkup
enumitem
\end_modules
\maintain_unincluded_children no
\language british
\language_package default
\inputencoding utf8
\fontencoding auto
\font_roman "default" "default"
\font_sans "default" "default"
\font_typewriter "default" "default"
\font_math "auto" "auto"
\font_default_family default
\use_non_tex_fonts false
\font_sc false
\font_roman_osf false
\font_sans_osf false
\font_typewriter_osf false
\font_sf_scale 100 100
\font_tt_scale 100 100
\use_microtype false
\use_dash_ligatures true
\graphics default
\default_output_format default
\output_sync 1
\bibtex_command default
\index_command default
\float_placement class
\float_alignment class
\paperfontsize default
\spacing single
\use_hyperref false
\papersize default
\use_geometry false
\use_package amsmath 1
\use_package amssymb 1
\use_package cancel 1
\use_package esint 1
\use_package mathdots 1
\use_package mathtools 1
\use_package mhchem 1
\use_package stackrel 1
\use_package stmaryrd 1
\use_package undertilde 1
\cite_engine basic
\cite_engine_type default
\biblio_style plain
\use_bibtopic false
\use_indices false
\paperorientation portrait
\suppress_date false
\justification true
\use_refstyle 1
\use_formatted_ref 0
\use_minted 0
\use_lineno 0
\index Index
\shortcut idx
\color #008000
\end_index
\spellchecker_ignore british cz
\spellchecker_ignore british Grrrl
\spellchecker_ignore british 's
\spellchecker_ignore british conf
\secnumdepth 3
\tocdepth 3
\paragraph_separation indent
\paragraph_indentation default
\is_math_indent 0
\math_numbering_side default
\quotes_style british
\dynamic_quotes 0
\papercolumns 1
\papersides 1
\paperpagestyle default
\tablestyle default
\tracking_changes false
\output_changes false
\change_bars false
\postpone_fragile_content true
\html_math_output 0
\html_css_as_file 0
\html_be_strict false
\docbook_table_output 0
\docbook_mathml_prefix 1
\end_header

\begin_body

\begin_layout Title
THE MANUAL
\end_layout

\begin_layout Subtitle
(How To Manage Snapshots The Easy Way)
\end_layout

\begin_layout Author
Bryn M.
 Reeves - 
\begin_inset Flex Code
status open

\begin_layout Plain Layout
bmr@errorists.org
\end_layout

\end_inset


\end_layout

\begin_layout Date
24th December 2025
\end_layout

\begin_layout Dedication
To Bill and Jimmy —
 thanks for the music!
\end_layout

\begin_layout Standard
\begin_inset ERT
status open

\begin_layout Plain Layout


\backslash
AddToShipoutPicture*
\end_layout

\begin_layout Plain Layout

{%
\end_layout

\begin_layout Plain Layout


\backslash
put(0,0)%the specific point of the page with coordinates (x=0,
 y=0)
\end_layout

\begin_layout Plain Layout

 {
\backslash
includegraphics[scale=0.25]{images/logo-462x462.png}}%
\end_layout

\begin_layout Plain Layout

}
\end_layout

\end_inset


\end_layout

\begin_layout Chapter*
Foreword
\begin_inset Foot
status open

\begin_layout Plain Layout
This foreword was written by 
\begin_inset Flex URL
status open

\begin_layout Plain Layout

https://claude.ai
\end_layout

\end_inset

.
 We couldn't find a real expert or respected figure who was willing to contribute one for The Manual.
\end_layout

\end_inset


\end_layout

\begin_layout Standard
This is not a book about snapshots.
 This is a book about freedom.
\end_layout

\begin_layout Standard
Every system administrator knows the fear.
 The update that might break everything.
 The configuration change that could bring down production.
 The moment you type 
\begin_inset Flex Code
status open

\begin_layout Plain Layout
dnf update
\end_layout

\end_inset

 and wonder if you'll still have a working system in ten minutes.
 We've all been there,
 finger hovering over Enter,
 mentally rehearsing the recovery procedure.
\end_layout

\begin_layout Standard
It doesn't have to be this way.
\end_layout

\begin_layout Standard
Snapshot based rollback used to be the preserve of expensive enterprise operating systems,
 storage arrays,
 and teams of specialists.
 The technology existed,
 but it was locked away behind proprietary interfaces,
 complex procedures,
 and eye-watering license fees.
 Ordinary administrators on ordinary Linux systems were expected to make do with a bag of bits:
 hand-rolled solutions,
 backups,
 prayers,
 and long nights.
\end_layout

\begin_layout Standard
The Manual exists because we believe everyone deserves a safety net.
 If you can type a command,
 you can protect your system.
 If something goes wrong,
 you can go back.
 It really is that simple.
\end_layout

\begin_layout Standard
This book will show you how to manage snapshots the easy way.
 Not just 
\begin_inset Quotes eld
\end_inset


\begin_inset Flex Emph
status open

\begin_layout Plain Layout
the enterprise way
\end_layout

\end_inset


\begin_inset Quotes erd
\end_inset

.
 Not the "
\begin_inset Flex Emph
status open

\begin_layout Plain Layout
consult your storage administrator
\end_layout

\end_inset

" way.
 The way that lets you make changes with confidence,
 experiment without fear,
 and sleep soundly knowing that yesterday's working system is only a reboot away.
\end_layout

\begin_layout Standard
You don't need expensive hardware.
 You don't need a team of experts.
 You need Linux,
 some disk space,
 and the willingness to try.
\end_layout

\begin_layout Standard
The rest is just details.
 That's what this book is for.
\end_layout

\begin_layout Standard
Be ready to ride the big dipper of the mixed metaphor.
 Be ready to dip your hands in the lucky bag of block devices,
 gather the storm clouds of entropy,
 and anoint your own rollback strategy.
 Because it is only by following the clear and concise instructions contained in this book that you can realise your long held dream of running system updates without fear,
 thus guaranteeing your place forever in the sacred annals of Uptime History.
\end_layout

\begin_layout Standard
One caveat before we begin:
 snapshots are not backups.
 They live on the same storage as your data,
 and if that storage fails,
 your snapshots fail with it.
 Nothing in this book replaces a tested backup strategy.
 But for the everyday mishaps —
 the botched update,
 the configuration mistake,
 the accidental deletion —
 snapshots will save you more times than you can count.
 Just remember:
 backups will get you through times of no snapshots better than snapshots will get you through times of no backups.
\end_layout

\begin_layout Standard
\begin_inset Newpage pagebreak
\end_inset


\end_layout

\begin_layout Standard

\lang english
\begin_inset CommandInset toc
LatexCommand tableofcontents

\end_inset


\end_layout

\begin_layout Part
Introduction
\end_layout

\begin_layout Chapter
What is Snapshot Manager?
\end_layout

\begin_layout Quotation
\begin_inset Quotes bld
\end_inset

The Snapshot Manager is currently the most distant,
 and least certain aspect of the proposal:
 many decisions can be deferred until other parts of the work are complete,
 including the choice of implementation language.
\begin_inset Quotes brd
\end_inset

 —
 Bryn M.
 Reeves,
 Boot-to-snapshot design v0.6,
 2017.
\end_layout

\begin_layout Standard
Snapshot Manager,
 aka 
\begin_inset Quotes bld
\end_inset


\begin_inset Flex Code
status open

\begin_layout Plain Layout
snapm
\end_layout

\end_inset


\begin_inset Quotes brd
\end_inset

 is a snapshot manager for Linux systems.
 It orchestrates storage operations for common storage stacks including LVM2 and Stratis and simplifies the creation,
 management,
 and roll back of snapshots of system and data volumes.
 It grew out of earlier work on bootable snapshots for Linux systems and is supported on recent versions of Fedora,
 CentOS,
 and Red Hat Enterprise Linux.
\end_layout

\begin_layout Standard
Central to the concept of 
\begin_inset Flex Code
status open

\begin_layout Plain Layout
snapm
\end_layout

\end_inset

 is the idea of Snapshot Sets —
 named collections of snapshots of different volumes taken at the same moment in time and managed as a single unit.
 This manual aims to describe the tool and its use,
 as well as common scenarios where readers may find it useful.
\end_layout

\begin_layout Chapter
About This Book
\end_layout

\begin_layout Quotation
\begin_inset Quotes bld
\end_inset

We are a tribe of philosophers,
 theologians,
 magicians,
 scientists,
 artists,
 clowns,
 and similar maniacs.
\begin_inset Quotes brd
\end_inset

 —
 The Joshua Norton Cabal,
 1965.
\end_layout

\begin_layout Section
What This Is
\end_layout

\begin_layout Standard
This is a manual for managing snapshots with 
\begin_inset Flex Code
status open

\begin_layout Plain Layout
snapm
\end_layout

\end_inset

.
 It tells you how to do that.
 If you follow it,
 you will be able to manage snapshots with 
\begin_inset Flex Code
status open

\begin_layout Plain Layout
snapm
\end_layout

\end_inset

.
 If you don't follow it,
 you might still be able to manage snapshots with 
\begin_inset Flex Code
status open

\begin_layout Plain Layout
snapm
\end_layout

\end_inset

,
 but we make no promises.
\end_layout

\begin_layout Section
What This Isn't
\end_layout

\begin_layout Standard
This is not a comprehensive guide to storage administration,
 Linux system internals,
 or the philosophy of reality,
 symbols and signs.
 Those are all interesting topics and you should read about them elsewhere.
 This manual assumes you already have opinions about file systems and we're not here to change them.
\end_layout

\begin_layout Section
Who This Is For
\end_layout

\begin_layout Standard
System administrators who need to not break production.
 Developers who want to experiment without consequences.
 Anyone who has ever thought "I wish I could just undo that." People who read documentation.
\end_layout

\begin_layout Standard
This manual assumes that you have a basic familiarity with Linux system administration and a reasonable level of comfort in the terminal.
 If that is not the case there are many helpful HOW-TOs,
 videos,
 and tutorials available online:
 consult one of those first,
 and then return here.
\end_layout

\begin_layout Section
How To Read This
\end_layout

\begin_layout Standard
Front to back works.
 So does opening it at random and hoping for the best.
 The chapters are reasonably self-contained.
 The epigraphs are not load-bearing but we're proud of them.
\end_layout

\begin_layout Section
A Note On Conditions
\end_layout

\begin_layout Standard
We assume you have:
 a Linux system,
 appropriate privileges,
 compatible storage,
 and a tolerance for things occasionally not working exactly as described because the universe is hostile to documentation.
\end_layout

\begin_layout Section
Whose Fault This Is
\end_layout

\begin_layout Standard
Bryn M.
 Reeves (
\begin_inset Flex URL
status open

\begin_layout Plain Layout

mailto:bmr@errorists.org
\end_layout

\end_inset

),
 with assistance from a large language model that cannot be held legally responsible for anything.
\end_layout

\begin_layout Section
How This Was Written
\end_layout

\begin_layout Standard
This document was typeset in LyX —
 The Document Processor (specifically,
 LyX Version 2.4.4 running on Fedora 43).
\end_layout

\begin_layout Chapter
About The Author
\end_layout

\begin_layout Quotation
\begin_inset Quotes bld
\end_inset

I am not now,
 nor have I ever been,
 a member of the demigodic party.
\begin_inset Quotes brd
\end_inset

 —
 Dennis Ritchie,
 
\begin_inset Flex Code
status open

\begin_layout Plain Layout
net.unix.wizards
\end_layout

\end_inset

,
 1983.
\end_layout

\begin_layout Standard
Bryn M.
 Reeves studied computer science at University College London in the late 1990s,
 receiving a BSc (first class hons.).
 In spite of that he has had a productive career in the enterprise software industry.
 He is a near 30-year veteran of Linux systems administration and development,
 with over 25 years of open source contributions spanning the storage and diagnostics stack.
\end_layout

\begin_layout Standard
His work includes contributions to 
\begin_inset Flex Emph
status open

\begin_layout Plain Layout
lvm2
\end_layout

\end_inset

,
 
\begin_inset Flex Emph
status open

\begin_layout Plain Layout
libdevmapper
\end_layout

\end_inset

,
 
\begin_inset Flex Code
status open

\begin_layout Plain Layout
dmstats(8)
\end_layout

\end_inset

,
 the Linux kernel,
 
\begin_inset Flex Emph
status open

\begin_layout Plain Layout
e2fsprogs
\end_layout

\end_inset

,
 
\begin_inset Flex Emph
status open

\begin_layout Plain Layout
systemtap
\end_layout

\end_inset

,
 
\begin_inset Flex Emph
status open

\begin_layout Plain Layout
SoS
\end_layout

\end_inset

,
 and more recently as the creator and maintainer of 
\begin_inset Flex Code
status open

\begin_layout Plain Layout
boom
\end_layout

\end_inset

 and 
\begin_inset Flex Code
status open

\begin_layout Plain Layout
snapm
\end_layout

\end_inset

.
\end_layout

\begin_layout Standard
He has served as a technical instructor for Linux system administration and development,
 and spoken at conferences and events including FOSDEM,
 DevConf.cz,
 the Irish Open Source Technology Conference,
 and the South Wales and Greater London Linux User groups.
\end_layout

\begin_layout Standard
When not debugging storage subsystems or writing documentation that blends computer science with philosophy,
 Bryn can be found attempting to coax music from a variety of instruments,
 DJing,
 or creating neon and plasma art in his workshop.
\end_layout

\begin_layout Standard
Originally from Wales,
 he currently resides in North Hampshire with two cats,
 an alarming number of musical instruments,
 and a Land Rover named Riot Grrrl (formerly Bertha
\begin_inset Foot
status open

\begin_layout Plain Layout
\begin_inset Quotes bld
\end_inset

Bertha,
 lovely Bertha,
 you are a lovely machine!
 And anyone who works with you,
 will know just what I mean.
\begin_inset Quotes brd
\end_inset


\end_layout

\end_inset

).
\end_layout

\begin_layout Standard
He types on a Model M keyboard and uses 
\begin_inset Flex Code
status open

\begin_layout Plain Layout
vim(1)
\end_layout

\end_inset

,
 
\begin_inset Flex Code
status open

\begin_layout Plain Layout
tmux(1)
\end_layout

\end_inset

,
 and 
\begin_inset Flex Code
status open

\begin_layout Plain Layout
sed(1)
\end_layout

\end_inset

 as his IDE of choice.
 
\end_layout

\begin_layout Chapter
Finding Us On The Internet
\end_layout

\begin_layout Quotation
\begin_inset Quotes bld
\end_inset

Cyberspace is a black hole;
 it absorbs energy and personality and then re-presents it as spectacle.
\begin_inset Quotes brd
\end_inset

 —
 Carmen Hermosillo (aka "Humdog"),
 Pandora's Vox:
 On Community in Cyberspace,
 1994.
\end_layout

\begin_layout Standard
This source for this book is hosted on GitHub as is 
\begin_inset Flex Emph
status open

\begin_layout Plain Layout
Snapshot Manager
\end_layout

\end_inset

 itself.
 We also have a blog site and an X account where we may occasionally share updates,
 technical tips,
 release announcements and so on.
\begin_inset Newline newline
\end_inset


\end_layout

\begin_layout Standard
You will find links to these resources below:
\end_layout

\begin_layout Itemize
The Manual GitHub repository —
 
\begin_inset Flex URL
status open

\begin_layout Plain Layout

https://github.com/bmr-cymru/the-manual
\end_layout

\end_inset


\end_layout

\begin_layout Itemize
snapm GitHub repository —
 
\begin_inset Flex URL
status open

\begin_layout Plain Layout

https://github.com/snapshotmanager/snapm
\end_layout

\end_inset


\end_layout

\begin_layout Itemize
\begin_inset Flex Code
status open

\begin_layout Plain Layout
snapm
\end_layout

\end_inset

 wiki —
 
\begin_inset Flex URL
status open

\begin_layout Plain Layout

https://github.com/snapshotmanager/snapm/wiki
\end_layout

\end_inset


\end_layout

\begin_layout Itemize
The Snapshot Manager blog —
 
\begin_inset Flex URL
status open

\begin_layout Plain Layout

https://snapshotmanager.github.io/
\end_layout

\end_inset


\end_layout

\begin_layout Itemize
\begin_inset Flex Code
status open

\begin_layout Plain Layout
@snapshotmanager
\end_layout

\end_inset

 X profile —
 
\begin_inset Flex URL
status open

\begin_layout Plain Layout

https://x.com/snapshotmanager
\end_layout

\end_inset


\end_layout

\begin_layout Chapter
Conventions Used in This Book
\end_layout

\begin_layout Quotation
\begin_inset Quotes bld
\end_inset

It is my firm belief that it is a mistake to hold firm beliefs.
\begin_inset Quotes brd
\end_inset

 —
 Gregory Hill,
 1965.
\end_layout

\begin_layout Standard
Code snippets,
 commands that you should type in,
 function and variable names,
 and other computery things are typeset in 
\begin_inset Flex Code
status open

\begin_layout Plain Layout
monospace
\end_layout

\end_inset

.
 Commands that you should enter into your computer are prefixed with a hash character (
\begin_inset Quotes bld
\end_inset


\begin_inset Flex Code
status open

\begin_layout Plain Layout
#
\end_layout

\end_inset


\begin_inset Quotes brd
\end_inset

) to denote commands that require administrative (root) privileges,
 or the dollar sign (
\begin_inset Quotes bld
\end_inset


\begin_inset Flex Code
status open

\begin_layout Plain Layout
$
\end_layout

\end_inset


\begin_inset Quotes brd
\end_inset

) to indicate that they can be run as a normal user.
\end_layout

\begin_layout Standard
Programs that have a manual page (as all proper programs should) are first referenced like 
\begin_inset Quotes bld
\end_inset


\begin_inset Flex Code
status open

\begin_layout Plain Layout
program(N)
\end_layout

\end_inset

`,
 where 
\begin_inset Flex Code
status open

\begin_layout Plain Layout
N
\end_layout

\end_inset

 is the section of the manual in which they appear.
 For example:
 
\begin_inset Flex Code
status open

\begin_layout Plain Layout
snapm(8)
\end_layout

\end_inset

.
\end_layout

\begin_layout Standard
URLs and cross-references are hyperlinked and should be clickable in any modern PDF reader.
\end_layout

\begin_layout Standard
This book (unlike 
\begin_inset Flex Code
status open

\begin_layout Plain Layout
snapm
\end_layout

\end_inset

 itself) is written in 
\begin_inset Flex Emph
status open

\begin_layout Plain Layout
British English
\end_layout

\end_inset

.
 We spell colour with a 
\begin_inset Quotes bld
\end_inset

u
\begin_inset Quotes brd
\end_inset

,
 and we use 
\begin_inset Quotes bld
\end_inset

s
\begin_inset Quotes brd
\end_inset

 instead of 
\begin_inset Quotes bld
\end_inset

z
\begin_inset Quotes brd
\end_inset

 (
\begin_inset Quotes bld
\end_inset

zed
\begin_inset Quotes brd
\end_inset

,
 not 
\begin_inset Quotes bld
\end_inset

zee
\begin_inset Quotes brd
\end_inset

).
 Deal with it.
\end_layout

\begin_layout Chapter
Why This Book is Free Documentation
\end_layout

\begin_layout Quotation
\begin_inset Quotes bld
\end_inset

Tolerance toward that which is radically evil now appears as good because it serves the cohesion of the whole on the road to affluence or more affluence.
\begin_inset Quotes brd
\end_inset

 —
 H.
 Marcuse,
 1965.
\end_layout

\begin_layout Standard
Because of what Herbert said.
\end_layout

\begin_layout Part
Getting Started
\end_layout

\begin_layout Chapter
Getting 
\begin_inset Flex Code
status open

\begin_layout Plain Layout
snapm
\end_layout

\end_inset


\end_layout

\begin_layout Quotation
\begin_inset Quotes bld
\end_inset

I like to think (it has to be!),
 of a cybernetic ecology where we are free of our 
\nospellcheck on
labors
\nospellcheck default
 and joined back to nature,
 returned to our mammal brothers and sisters,
 and all watched over by machines of loving grace.
\begin_inset Quotes brd
\end_inset

 —
 Richard Brautigan,
 All Watched Over By Machines Of Loving Grace,
 1967.
\end_layout

\begin_layout Standard
Snapshot Manager is a Python application.
 It's simple to install whether you are working from distribution provided packages,
 or installing the latest source from 
\begin_inset Flex Code
status open

\begin_layout Plain Layout
git
\end_layout

\end_inset

.
 For most users we recommend using distribution packages where available - you'll be able to take advantage of automatic updates and simplified configuration,
 but read on to discover how to install 
\begin_inset Flex Code
status open

\begin_layout Plain Layout
snapm
\end_layout

\end_inset

 using various methods,
 and where to obtain the Python packages and source code.
\end_layout

\begin_layout Section
\begin_inset CommandInset label
LatexCommand label
name "sec:Installing-distribution-packages"

\end_inset

Installing distribution packages with 
\begin_inset Flex Code
status open

\begin_layout Plain Layout
dnf
\end_layout

\end_inset

 (recommended for most users).
\end_layout

\begin_layout Standard
What you'll need:
\end_layout

\begin_layout Itemize
A Linux system installed with Fedora (F42+),
 CentOS (c9s+),
 or Red Hat Enterprise Linux (RHEL9.6 onward).
\end_layout

\begin_layout Itemize
Administrative privileges (or membership of the 
\begin_inset Flex Code
status open

\begin_layout Plain Layout
\begin_inset Flex Emph
status open

\begin_layout Plain Layout
wheel
\end_layout

\end_inset


\end_layout

\end_inset

 group).
\end_layout

\begin_layout Itemize
A working internet connection.
\end_layout

\begin_layout Standard
It's easy to install 
\begin_inset Flex Code
status open

\begin_layout Plain Layout
snapm
\end_layout

\end_inset

 from the command line:
 you'll be using the shell to configure and interact with the tool so if you're not a regular terminal user,
 now is a great time to get started!
\end_layout

\begin_layout Standard
Using the native 
\begin_inset Flex Code
status open

\begin_layout Plain Layout
\begin_inset Flex Emph
status open

\begin_layout Plain Layout
dnf
\end_layout

\end_inset


\end_layout

\end_inset

 package management tool,
 open a terminal and either switch to the 
\begin_inset Flex Emph
status open

\begin_layout Plain Layout
root
\end_layout

\end_inset

 account by running 
\begin_inset Flex Code
status open

\begin_layout Plain Layout
su -
\end_layout

\end_inset

,
 or prefix the 
\begin_inset Flex Code
status open

\begin_layout Plain Layout
dnf install
\end_layout

\end_inset

 command with 
\begin_inset Flex Code
status open

\begin_layout Plain Layout
sudo
\end_layout

\end_inset

,
 give the appropriate password when prompted,
 and 
\begin_inset Flex Code
status open

\begin_layout Plain Layout
\begin_inset Flex Emph
status open

\begin_layout Plain Layout
dnf
\end_layout

\end_inset


\end_layout

\end_inset

 will do its thing and pull the packages down and get them installed:
\begin_inset VSpace defskip
\end_inset


\end_layout

\begin_layout Standard
\begin_inset Box Frameless
position "t"
hor_pos "c"
has_inner_box 1
inner_pos "t"
use_parbox 0
use_makebox 0
width "100col%"
special "none"
height "1in"
height_special "totalheight"
thickness "0.4pt"
separation "3pt"
shadowsize "4pt"
framecolor "default"
backgroundcolor "none"
status open

\begin_layout Plain Layout
\begin_inset Flex Code
status open

\begin_layout Plain Layout
$ su -
\begin_inset Newline newline
\end_inset

Password:
\begin_inset Newline newline
\end_inset

# dnf -y install snapm
\end_layout

\end_inset


\end_layout

\end_inset


\end_layout

\begin_layout Standard
\begin_inset VSpace defskip
\end_inset


\end_layout

\begin_layout Standard
Or:
\end_layout

\begin_layout Standard
\begin_inset VSpace defskip
\end_inset


\end_layout

\begin_layout Standard
\begin_inset Box Frameless
position "t"
hor_pos "c"
has_inner_box 1
inner_pos "t"
use_parbox 0
use_makebox 0
width "100col%"
special "none"
height "1in"
height_special "totalheight"
thickness "0.4pt"
separation "3pt"
shadowsize "4pt"
framecolor "default"
backgroundcolor "none"
status open

\begin_layout Plain Layout
\begin_inset Flex Code
status open

\begin_layout Plain Layout
\begin_inset Flex Code
status open

\begin_layout Plain Layout
$ sudo dnf -y install snapm
\end_layout

\end_inset


\begin_inset Newline newline
\end_inset

[sudo] password for bmr:
 
\end_layout

\end_inset


\end_layout

\end_inset


\end_layout

\begin_layout Standard
\begin_inset VSpace defskip
\end_inset

For example,
 on Fedora 42 with 
\begin_inset Flex Code
status open

\begin_layout Plain Layout
snapm-0.5.2-2.fc42
\end_layout

\end_inset

 the installation will look something like this:
\end_layout

\begin_layout Standard
\begin_inset VSpace defskip
\end_inset


\end_layout

\begin_layout Standard
\begin_inset Box Frameless
position "t"
hor_pos "c"
has_inner_box 1
inner_pos "t"
use_parbox 0
use_makebox 0
width "100col%"
special "none"
height "1in"
height_special "totalheight"
thickness "0.4pt"
separation "3pt"
shadowsize "4pt"
framecolor "default"
backgroundcolor "none"
status open

\begin_layout Plain Layout
\begin_inset Flex Code
status open

\begin_layout Plain Layout
Updating and loading repositories:
\begin_inset Newline newline
\end_inset

Repositories loaded.
\begin_inset Newline newline
\end_inset

Package
\begin_inset space ~
\end_inset


\begin_inset space ~
\end_inset


\begin_inset space ~
\end_inset


\begin_inset space ~
\end_inset


\begin_inset space ~
\end_inset


\begin_inset space ~
\end_inset


\begin_inset space ~
\end_inset


\begin_inset space ~
\end_inset


\begin_inset space ~
\end_inset


\begin_inset space ~
\end_inset


\begin_inset space ~
\end_inset


\begin_inset space ~
\end_inset


\begin_inset space ~
\end_inset

 Arch 
\begin_inset space ~
\end_inset


\begin_inset space ~
\end_inset


\begin_inset space ~
\end_inset


\begin_inset space ~
\end_inset

Version 
\begin_inset space ~
\end_inset


\begin_inset space ~
\end_inset


\begin_inset space ~
\end_inset


\begin_inset space ~
\end_inset


\begin_inset space ~
\end_inset


\begin_inset space ~
\end_inset

Repository 
\begin_inset space ~
\end_inset


\begin_inset space ~
\end_inset


\begin_inset space ~
\end_inset


\begin_inset space ~
\end_inset


\begin_inset space ~
\end_inset


\begin_inset space ~
\end_inset

Size
\begin_inset Newline newline
\end_inset

Installing:
\begin_inset Newline newline
\end_inset

snapm 
\begin_inset space ~
\end_inset


\begin_inset space ~
\end_inset


\begin_inset space ~
\end_inset


\begin_inset space ~
\end_inset


\begin_inset space ~
\end_inset


\begin_inset space ~
\end_inset


\begin_inset space ~
\end_inset


\begin_inset space ~
\end_inset


\begin_inset space ~
\end_inset


\begin_inset space ~
\end_inset


\begin_inset space ~
\end_inset


\begin_inset space ~
\end_inset


\begin_inset space ~
\end_inset


\begin_inset space ~
\end_inset


\begin_inset space ~
\end_inset

noarch 
\begin_inset space ~
\end_inset


\begin_inset space ~
\end_inset

0.5.2-2.fc42
\begin_inset space ~
\end_inset

 updates 
\begin_inset space ~
\end_inset


\begin_inset space ~
\end_inset


\begin_inset space ~
\end_inset


\begin_inset space ~
\end_inset

 32.7 KiB
\begin_inset Newline newline
\end_inset

Installing weak dependencies:boom-boot noarch 1.6.8-2.fc42 updates 30.3 KiB
\begin_inset Newline newline
\end_inset

Transaction Summary:
\begin_inset Newline newline
\end_inset


\begin_inset space ~
\end_inset


\begin_inset space ~
\end_inset

Installing:
 2 packages
\begin_inset Newline newline
\end_inset

Total size of inbound packages is 62 KiB.
 Need to download 62 KiB.
\begin_inset Newline newline
\end_inset

After this operation,
 63 KiB extra will be used (install 63 KiB,
 remove 0 B).
\begin_inset Newline newline
\end_inset

[1/2] snapm-0:0.5.2-2.fc42.noarch
\begin_inset space ~
\end_inset

 100% | 478.2 KiB/s
\begin_inset space ~
\end_inset

| 33.0 KiB | 00m00s
\begin_inset Newline newline
\end_inset

[2/2] boom-boot-0:1.6.8-2.fc42.noa 100% | 382.5 KiB/s
\begin_inset space ~
\end_inset

| 29.5 KiB | 00m00s
\begin_inset Newline newline
\end_inset

--------------------------------------------------------------------------------
\begin_inset Newline newline
\end_inset

[2/2] Total 
\begin_inset space ~
\end_inset


\begin_inset space ~
\end_inset


\begin_inset space ~
\end_inset


\begin_inset space ~
\end_inset


\begin_inset space ~
\end_inset


\begin_inset space ~
\end_inset


\begin_inset space ~
\end_inset


\begin_inset space ~
\end_inset


\begin_inset space ~
\end_inset


\begin_inset space ~
\end_inset


\begin_inset space ~
\end_inset


\begin_inset space ~
\end_inset


\begin_inset space ~
\end_inset


\begin_inset space ~
\end_inset


\begin_inset space ~
\end_inset


\begin_inset space ~
\end_inset


\begin_inset space ~
\end_inset


\begin_inset space ~
\end_inset


\begin_inset space ~
\end_inset


\begin_inset space ~
\end_inset


\begin_inset space ~
\end_inset


\begin_inset space ~
\end_inset


\begin_inset space ~
\end_inset

100% | 89.1 KiB/s 
\begin_inset space ~
\end_inset

| 62.4 KiB | 00m01s
\begin_inset Newline newline
\end_inset

Running transaction[1/4]
\begin_inset Newline newline
\end_inset

Verify package files 
\begin_inset space ~
\end_inset


\begin_inset space ~
\end_inset


\begin_inset space ~
\end_inset


\begin_inset space ~
\end_inset


\begin_inset space ~
\end_inset


\begin_inset space ~
\end_inset


\begin_inset space ~
\end_inset


\begin_inset space ~
\end_inset


\begin_inset space ~
\end_inset


\begin_inset space ~
\end_inset


\begin_inset space ~
\end_inset


\begin_inset space ~
\end_inset


\begin_inset space ~
\end_inset


\begin_inset space ~
\end_inset

100% | 1.0 KiB/s 
\begin_inset space ~
\end_inset


\begin_inset space ~
\end_inset

| 2.0 B 
\begin_inset space ~
\end_inset


\begin_inset space ~
\end_inset


\begin_inset space ~
\end_inset

| 00m00s
\begin_inset Newline newline
\end_inset

[2/4] Prepare transaction 
\begin_inset space ~
\end_inset


\begin_inset space ~
\end_inset


\begin_inset space ~
\end_inset


\begin_inset space ~
\end_inset


\begin_inset space ~
\end_inset


\begin_inset space ~
\end_inset


\begin_inset space ~
\end_inset


\begin_inset space ~
\end_inset


\begin_inset space ~
\end_inset

100% | 4.0 B/s 
\begin_inset space ~
\end_inset


\begin_inset space ~
\end_inset


\begin_inset space ~
\end_inset


\begin_inset space ~
\end_inset

| 2.0 B 
\begin_inset space ~
\end_inset


\begin_inset space ~
\end_inset


\begin_inset space ~
\end_inset

| 00m00s
\begin_inset Newline newline
\end_inset

[3/4] Installing boom-boot-0:1.6.
 100% | 667.3 KiB/s
\begin_inset space ~
\end_inset

| 31.4 KiB | 00m00s
\begin_inset Newline newline
\end_inset

[4/4] Installing snapm-0:0.5.2-2.
 100% | 28.3 KiB/s 
\begin_inset space ~
\end_inset

| 35.9 KiB | 00m01s
\begin_inset Newline newline
\end_inset

Complete!
\end_layout

\end_inset


\end_layout

\end_inset


\end_layout

\begin_layout Standard
Note that the 
\begin_inset Flex Code
status open

\begin_layout Plain Layout
boom-boot
\end_layout

\end_inset

 package (containing the boom boot manager CLI) is a 
\begin_inset Flex Emph
status open

\begin_layout Plain Layout
weak dependency
\end_layout

\end_inset

 of 
\begin_inset Flex Code
status open

\begin_layout Plain Layout
snapm
\end_layout

\end_inset

 - that is to say,
 it is recommended but not required (the 
\begin_inset Flex Code
status open

\begin_layout Plain Layout
python3-snapm
\end_layout

\end_inset

 package separately depends on the 
\begin_inset Flex Code
status open

\begin_layout Plain Layout
python3-boom
\end_layout

\end_inset

 package that provides the procedural API that 
\begin_inset Flex Code
status open

\begin_layout Plain Layout
snapm
\end_layout

\end_inset

 uses).
 If you're installing 
\begin_inset Flex Code
status open

\begin_layout Plain Layout
snapm
\end_layout

\end_inset

 for manual use (rather than automation using the API or Ansible roles) you probably want to have 
\begin_inset Flex Code
status open

\begin_layout Plain Layout
boom
\end_layout

\end_inset

 installed too - it's the easiest way to get deeper insight into your snapshot boot entries.
\end_layout

\begin_layout Section
Installing 
\begin_inset Flex Code
status open

\begin_layout Plain Layout
copr
\end_layout

\end_inset

 builds from GitHub (early access to new features & fixes)
\end_layout

\begin_layout Standard
What you'll need:
\end_layout

\begin_layout Itemize
The URL or PR# of the pull request that you want to install a build from.
\end_layout

\begin_layout Itemize
A Linux system installed with Fedora (F42+),
 CentOS (c9s+),
 or Red Hat Enterprise Linux (RHEL9.6 onward).
\end_layout

\begin_layout Itemize
The package 
\begin_inset Flex Emph
status open

\begin_layout Plain Layout
\begin_inset Flex Code
status open

\begin_layout Plain Layout
python3-dnf-plugins-core
\end_layout

\end_inset


\end_layout

\end_inset

 installed for the 
\begin_inset Flex Code
status open

\begin_layout Plain Layout
copr
\end_layout

\end_inset

 plugin.
\end_layout

\begin_layout Itemize
Administrative privileges (or membership of the 
\begin_inset Flex Code
status open

\begin_layout Plain Layout
\begin_inset Flex Emph
status open

\begin_layout Plain Layout
wheel
\end_layout

\end_inset


\end_layout

\end_inset

 group).
\end_layout

\begin_layout Itemize
A working internet connection.
\end_layout

\begin_layout Standard
In this scenario,
 we'll be using the DNF support for 
\begin_inset Flex Emph
status open

\begin_layout Plain Layout
copr repositories
\end_layout

\end_inset

 in the core plug-ins package to enable a pull request repository and install the packages.
\end_layout

\begin_layout Standard
Either open the pull request web page,
 locate the comment from the Packit build system,
 and copy the provided 
\begin_inset Flex Code
status open

\begin_layout Plain Layout
dnf
\end_layout

\end_inset

 command for your distribution,
 or construct the repository argument for the 
\begin_inset Flex Code
status open

\begin_layout Plain Layout
dnf copr enable
\end_layout

\end_inset

 command as follows:
 
\begin_inset Quotes eld
\end_inset


\begin_inset Flex Code
status open

\begin_layout Plain Layout
packit/snapshotmanager-snapm-PR#
\end_layout

\end_inset


\begin_inset Quotes erd
\end_inset

,
 where 
\begin_inset Flex Code
status open

\begin_layout Plain Layout
PR#
\end_layout

\end_inset

 is the pull request number assigned by GitHub in the 
\begin_inset Flex Code
status open

\begin_layout Plain Layout
snapshotmanager/snapm
\end_layout

\end_inset

 repository.
\end_layout

\begin_layout Standard
The command will end up looking like this:
\end_layout

\begin_layout Standard
\begin_inset VSpace defskip
\end_inset


\end_layout

\begin_layout Standard
\begin_inset Box Frameless
position "t"
hor_pos "c"
has_inner_box 1
inner_pos "t"
use_parbox 0
use_makebox 0
width "100col%"
special "none"
height "1in"
height_special "totalheight"
thickness "0.4pt"
separation "3pt"
shadowsize "4pt"
framecolor "default"
backgroundcolor "none"
status open

\begin_layout Plain Layout
\begin_inset Flex Code
status open

\begin_layout Plain Layout
# dnf copr enable packit/snapshotmanager-snapm-830
\begin_inset Newline newline
\end_inset

https://copr.fedorainfracloud.org/api_ 100% | 696.0 B/s | 485.0 B | 00m01s
\begin_inset Newline newline
\end_inset

Enabling a Copr repository.
 Please note that this repository is not part
\begin_inset Newline newline
\end_inset

of the main distribution,
 and quality may vary.
\begin_inset Newline newline
\end_inset


\begin_inset Newline newline
\end_inset

The Fedora Project does not exercise any power over the contents of
\begin_inset Newline newline
\end_inset

this repository beyond the rules outlined in the Copr FAQ at
\begin_inset Newline newline
\end_inset

<https://docs.pagure.org/copr.copr/user_documentation.html#what-i-can-build-in-copr>,
\begin_inset Newline newline
\end_inset

and packages are not held to any quality or security level.
\begin_inset Newline newline
\end_inset


\begin_inset Newline newline
\end_inset

Please do not file bug reports about these packages in Fedora
\begin_inset Newline newline
\end_inset

Bugzilla.
 In case of problems,
 contact the owner of this repository.
\begin_inset Newline newline
\end_inset

Is this ok [y/N]:
 y
\end_layout

\end_inset


\end_layout

\end_inset


\end_layout

\begin_layout Standard
\begin_inset VSpace defskip
\end_inset

Enter 
\begin_inset Quotes eld
\end_inset


\begin_inset Flex Code
status open

\begin_layout Plain Layout
y
\end_layout

\end_inset


\begin_inset Quotes erd
\end_inset

 when prompted to confirm enabling the repository then follow the instructions from 
\begin_inset CommandInset ref
LatexCommand ref
reference "sec:Installing-distribution-packages"
plural "false"
caps "false"
noprefix "false"
nolink "false"

\end_inset

 to install the packages.
\end_layout

\begin_layout Section
\begin_inset CommandInset label
LatexCommand label
name "sec:Installing-from-PyPi"

\end_inset

Installing from PyPi (Bleeding Edge Releases:
 Some Assembly Required)
\end_layout

\begin_layout Itemize
A Linux system installed with Fedora (F42+),
 CentOS (c9s+),
 or Red Hat Enterprise Linux (RHEL9.6 onward).
\end_layout

\begin_layout Itemize
The package 
\begin_inset Flex Emph
status open

\begin_layout Plain Layout
\begin_inset Flex Code
status open

\begin_layout Plain Layout
python3-pip
\end_layout

\end_inset


\end_layout

\end_inset

 installed for the 
\begin_inset Flex Code
status open

\begin_layout Plain Layout
pip
\end_layout

\end_inset

 program.
\end_layout

\begin_layout Itemize
Administrative privileges (or membership of the 
\begin_inset Flex Code
status open

\begin_layout Plain Layout
\begin_inset Flex Emph
status open

\begin_layout Plain Layout
wheel
\end_layout

\end_inset


\end_layout

\end_inset

 group).
\end_layout

\begin_layout Itemize
A working internet connection.
\end_layout

\begin_layout Standard
New releases of 
\begin_inset Flex Code
status open

\begin_layout Plain Layout
snapm
\end_layout

\end_inset

 are pushed to the public PyPi repository at 
\begin_inset Flex URL
status open

\begin_layout Plain Layout

https://pypi.org/project/snapm/
\end_layout

\end_inset

.
 Often these will be available before updates to distribution packages are published (particularly for CentOS and Red Hat Enterprise Linux).
 These are mostly provided for users wanting to consume bleeding-edge releases in CI environments and are not typically recommended for end-users.
 You can install the latest code from PyPi using the 
\begin_inset Flex Code
status open

\begin_layout Plain Layout
pip
\end_layout

\end_inset

 command,
 including in a Python 
\begin_inset Flex Emph
status open

\begin_layout Plain Layout
virtual environment
\end_layout

\end_inset

.
 
\end_layout

\begin_layout Standard
To install the latest package available (after activating any 
\begin_inset Flex Emph
status open

\begin_layout Plain Layout
venv
\end_layout

\end_inset

,
 if you wish to use one):
\end_layout

\begin_layout Standard
\begin_inset VSpace defskip
\end_inset


\end_layout

\begin_layout Standard
\begin_inset Box Frameless
position "t"
hor_pos "c"
has_inner_box 1
inner_pos "t"
use_parbox 0
use_makebox 0
width "100col%"
special "none"
height "1in"
height_special "totalheight"
thickness "0.4pt"
separation "3pt"
shadowsize "4pt"
framecolor "default"
backgroundcolor "none"
status open

\begin_layout Plain Layout
\begin_inset Flex Code
status open

\begin_layout Plain Layout
$ sudo pip install snapm
\end_layout

\end_inset


\end_layout

\end_inset


\end_layout

\begin_layout Standard
\begin_inset VSpace defskip
\end_inset

Just bear in mind:
 the Python packages do not currently include the configuration,
 
\begin_inset Flex Code
status open

\begin_layout Plain Layout
systemd
\end_layout

\end_inset

 units,
 or manual pages that are included in the source and RPM distributions.
 You can reuse previously installed configuration files and resources to some extent but these may be out-of-date compared to the installation you are getting from PyPi.
 You will need to make any corrections or adjustments yourself.
 The easiest way to get these missing pieces is to clone the source repository from 
\begin_inset Flex URL
status open

\begin_layout Plain Layout

https://github.com/snapshotmanager/snapm/
\end_layout

\end_inset

 and copy the files to their proper locations with the following commands:
\end_layout

\begin_layout Standard
\begin_inset VSpace defskip
\end_inset


\end_layout

\begin_layout Standard
\begin_inset Box Frameless
position "t"
hor_pos "c"
has_inner_box 1
inner_pos "t"
use_parbox 0
use_makebox 0
width "100col%"
special "none"
height "1in"
height_special "totalheight"
thickness "0.4pt"
separation "3pt"
shadowsize "4pt"
framecolor "default"
backgroundcolor "none"
status open

\begin_layout Plain Layout
\begin_inset Flex Code
status open

\begin_layout Plain Layout
$ sudo mkdir -p /etc/snapm/plugins.d /etc/snapm/schedule.d
\begin_inset Newline newline
\end_inset

$ sudo cp systemd/*.timer /usr/lib/systemd/system
\begin_inset Newline newline
\end_inset

$ sudo cp systemd/*.service /usr/lib/systemd/system
\begin_inset Newline newline
\end_inset

$ sudo cp systemd/tmpfiles.d/snapm.conf /usr/lib/tmpfiles.d
\begin_inset Newline newline
\end_inset

$ sudo systemd-tmpfiles –create /usr/lib/tmpfiles.d/snapm.conf
\begin_inset Newline newline
\end_inset

$ sudo systemctl daemon-reload
\end_layout

\end_inset


\end_layout

\end_inset


\end_layout

\begin_layout Standard
\begin_inset VSpace defskip
\end_inset

If you would also like to install the latest manual pages,
 copy them from the 
\begin_inset Flex Code
status open

\begin_layout Plain Layout
man/
\end_layout

\end_inset

 directory in the source tree into the appropriate location for your distribution (normally 
\begin_inset Flex Code
status open

\begin_layout Plain Layout
/usr/share/man/man{5,8}
\end_layout

\end_inset

).
\end_layout

\begin_layout Section
Installing or Running From Source (For Experts & Contributors)
\end_layout

\begin_layout Itemize
A Linux system installed with Fedora (F42+),
 CentOS (c9s+),
 or Red Hat Enterprise Linux (RHEL9.6 onward).
\end_layout

\begin_layout Itemize
A working installation of the 
\begin_inset Flex Code
status open

\begin_layout Plain Layout
gi
\end_layout

\end_inset

t version control system.
\end_layout

\begin_layout Itemize
(Optionally) the package 
\begin_inset Flex Emph
status open

\begin_layout Plain Layout
\begin_inset Flex Code
status open

\begin_layout Plain Layout
python3-pip
\end_layout

\end_inset


\end_layout

\end_inset

 installed for the 
\begin_inset Flex Code
status open

\begin_layout Plain Layout
pip
\end_layout

\end_inset

 program.
\end_layout

\begin_layout Itemize
Administrative privileges (or membership of the 
\begin_inset Flex Code
status open

\begin_layout Plain Layout
\begin_inset Flex Emph
status open

\begin_layout Plain Layout
wheel
\end_layout

\end_inset


\end_layout

\end_inset

 group).
\end_layout

\begin_layout Itemize
A working internet connection.
\end_layout

\begin_layout Standard
First clone the 
\begin_inset Flex Code
status open

\begin_layout Plain Layout
snapm
\end_layout

\end_inset

 repository from GitHub with the command:
\end_layout

\begin_layout Standard
\begin_inset VSpace defskip
\end_inset


\end_layout

\begin_layout Standard
\begin_inset Box Frameless
position "t"
hor_pos "c"
has_inner_box 1
inner_pos "t"
use_parbox 0
use_makebox 0
width "100col%"
special "none"
height "1in"
height_special "totalheight"
thickness "0.4pt"
separation "3pt"
shadowsize "4pt"
framecolor "default"
backgroundcolor "none"
status open

\begin_layout Plain Layout
\begin_inset Flex Code
status open

\begin_layout Plain Layout
$ git clone https://github.com/snapshotmanager/snapm
\end_layout

\end_inset


\end_layout

\end_inset


\end_layout

\begin_layout Standard
\begin_inset VSpace defskip
\end_inset

Optionally,
 also clone the 
\begin_inset Flex Code
status open

\begin_layout Plain Layout
boom-boot
\end_layout

\end_inset

 repository into the same directory (this is useful if you want to test or work on features or fixes that span both 
\begin_inset Flex Code
status open

\begin_layout Plain Layout
snapm
\end_layout

\end_inset

 and 
\begin_inset Flex Code
status open

\begin_layout Plain Layout
boom
\end_layout

\end_inset

):
\end_layout

\begin_layout Standard
\begin_inset VSpace defskip
\end_inset


\end_layout

\begin_layout Standard
\begin_inset Box Frameless
position "t"
hor_pos "c"
has_inner_box 1
inner_pos "t"
use_parbox 0
use_makebox 0
width "100col%"
special "none"
height "1in"
height_special "totalheight"
thickness "0.4pt"
separation "3pt"
shadowsize "4pt"
framecolor "default"
backgroundcolor "none"
status open

\begin_layout Plain Layout
\begin_inset Flex Code
status open

\begin_layout Plain Layout
$ git clone https://github.com/snapshotmanager/boom-boot
\end_layout

\end_inset


\end_layout

\end_inset


\end_layout

\begin_layout Standard
\begin_inset VSpace defskip
\end_inset

To run 
\begin_inset Flex Code
status open

\begin_layout Plain Layout
snapm
\end_layout

\end_inset

 from the source tree,
 gain root privileges,
 change to the directory where you checked out the source (normally 
\begin_inset Flex Code
status open

\begin_layout Plain Layout
snapm/
\end_layout

\end_inset

,
 relative to the directory where 
\begin_inset Flex Code
status open

\begin_layout Plain Layout
git-checkout
\end_layout

\end_inset

 ran),
 and run the command:
\end_layout

\begin_layout Standard
\begin_inset VSpace defskip
\end_inset


\end_layout

\begin_layout Standard
\begin_inset Box Frameless
position "t"
hor_pos "c"
has_inner_box 1
inner_pos "t"
use_parbox 0
use_makebox 0
width "100col%"
special "none"
height "1in"
height_special "totalheight"
thickness "0.4pt"
separation "3pt"
shadowsize "4pt"
framecolor "default"
backgroundcolor "none"
status open

\begin_layout Plain Layout
\begin_inset Flex Code
status open

\begin_layout Plain Layout
# .
 scripts/setpaths.sh
\end_layout

\end_inset


\end_layout

\end_inset


\end_layout

\begin_layout Standard
\begin_inset VSpace defskip
\end_inset

This will set the 
\begin_inset Flex Code
status open

\begin_layout Plain Layout
PATH
\end_layout

\end_inset

 and 
\begin_inset Flex Code
status open

\begin_layout Plain Layout
PYTHONPATH
\end_layout

\end_inset

 environment variables appropriately for you to run 
\begin_inset Flex Code
status open

\begin_layout Plain Layout
snapm
\end_layout

\end_inset

 from the checked-out sources.
 It will also enable support for using the checked out copy of 
\begin_inset Flex Code
status open

\begin_layout Plain Layout
boom-boot
\end_layout

\end_inset

 if you also cloned that (assuming it is found at the path 
\begin_inset Flex Code
status open

\begin_layout Plain Layout
../boom-boot
\end_layout

\end_inset

 relative to the 
\begin_inset Flex Code
status open

\begin_layout Plain Layout
snapm/
\end_layout

\end_inset

 directory).
\end_layout

\begin_layout Standard
You can now run the 
\begin_inset Flex Code
status open

\begin_layout Plain Layout
snapm
\end_layout

\end_inset

 and 
\begin_inset Flex Code
status open

\begin_layout Plain Layout
boom
\end_layout

\end_inset

 commands using the latest source from 
\begin_inset Flex Code
status open

\begin_layout Plain Layout
git
\end_layout

\end_inset

.
 Every time you pull or checkout a new revision subsequent invocations will use that copy of the code.
\end_layout

\begin_layout Standard
To install the current revision in a 
\begin_inset Flex Code
status open

\begin_layout Plain Layout
git
\end_layout

\end_inset

 clone,
 run:
\end_layout

\begin_layout Standard
\begin_inset VSpace defskip
\end_inset


\end_layout

\begin_layout Standard
\begin_inset Box Frameless
position "t"
hor_pos "c"
has_inner_box 1
inner_pos "t"
use_parbox 0
use_makebox 0
width "100col%"
special "none"
height "1in"
height_special "totalheight"
thickness "0.4pt"
separation "3pt"
shadowsize "4pt"
framecolor "default"
backgroundcolor "none"
status open

\begin_layout Plain Layout
\begin_inset Flex Code
status open

\begin_layout Plain Layout
$ sudo pip install .
\end_layout

\end_inset


\end_layout

\end_inset


\end_layout

\begin_layout Standard
\begin_inset VSpace defskip
\end_inset

Just remember that all the caveats from 
\begin_inset CommandInset ref
LatexCommand ref
reference "sec:Installing-from-PyPi"
plural "false"
caps "false"
noprefix "false"
nolink "false"

\end_inset

 apply to 
\begin_inset Flex Code
status open

\begin_layout Plain Layout
git
\end_layout

\end_inset

 clones too:
 you are responsible for ensuring all configuration files are in place,
 and for keeping them up-to-date with any code changes.
\end_layout

\begin_layout Chapter
Your First Snapshot Set
\end_layout

\begin_layout Quotation
\begin_inset Quotes bld
\end_inset

My little baby sister can do it with ease.
 It's easier than learning your ABCs
\begin_inset Quotes brd
\end_inset

 —
 Kylie Minogue,
 1988
\begin_inset Foot
status open

\begin_layout Plain Layout
Kylie's optimism regarding ease of use was unfortunately not peer reviewed against the real world scenarios of enterprise storage array crashes and thin provisioning metadata exhaustion.
\end_layout

\end_inset

.
\end_layout

\begin_layout Standard
A snapshot set is a collection of snapshots,
 bound together with a name,
 and created at a common moment in time
\begin_inset Foot
status open

\begin_layout Plain Layout
The snapshots making up a set are created 
\begin_inset Flex Emph
status open

\begin_layout Plain Layout
sequentially
\end_layout

\end_inset

,
 since there is presently no interface in Linux for creating multiple snapshots simultaneously.
 For this reason the individual snapshots will all have very slightly different timestamps.
 Snapshot Manager quantises these timestamps to provide a single unambiguous creation time for the set as a whole.
\end_layout

\end_inset

.
 At a bare minimum,
 to create one,
 you just need a name and a list of sources (
\begin_inset Flex Emph
status open

\begin_layout Plain Layout
mount points
\end_layout

\end_inset

 or 
\begin_inset Flex Emph
status open

\begin_layout Plain Layout
block devices
\end_layout

\end_inset

) that you would like to include in the set.
 More advanced options exist to give more control over the creation process and the resulting snapshot set:
 we will cover these in detail later on in this manual.
\end_layout

\begin_layout Section
Choosing Sources:
 First Things To know.
\end_layout

\begin_layout Itemize
You need snapshottable storage:
 LVM2 vanilla or thin provisioned volumes,
 or Stratis file systems.
\end_layout

\begin_layout Itemize
You need free space (either in an LVM2 volume group with non-thin provisioned volumes,
 or in the thin pool containing the volumes with LVM2 thin provisioning or Stratis storage).
\end_layout

\begin_layout Itemize
You'll need to know the 
\begin_inset Flex Emph
status open

\begin_layout Plain Layout
mount points
\end_layout

\end_inset

 or 
\begin_inset Flex Emph
status open

\begin_layout Plain Layout
block device paths
\end_layout

\end_inset

 for the volumes you wish to include in your snapshot set.
\end_layout

\begin_layout Itemize
You need 
\begin_inset Flex Code
status open

\begin_layout Plain Layout
snapm
\end_layout

\end_inset

.
\end_layout

\begin_layout Standard
Some familiarity with your storage stack's management tools (whether that's 
\begin_inset Flex Code
status open

\begin_layout Plain Layout
vgs(8)
\end_layout

\end_inset

,
 
\begin_inset Flex Code
status open

\begin_layout Plain Layout
lvs(8)
\end_layout

\end_inset

,
 
\nospellcheck on
et
\nospellcheck default
 
\nospellcheck on
al
\nospellcheck default
.
 for LVM2,
 or the 
\begin_inset Flex Code
status open

\begin_layout Plain Layout
stratis(8)
\end_layout

\end_inset

 command line tool) will help when it comes to planning and finding your way around.
 Knowledge of common Linux administrative tools like the 
\begin_inset Flex Code
status open

\begin_layout Plain Layout
mount(8)
\end_layout

\end_inset

 program,
 
\begin_inset Flex Code
status open

\begin_layout Plain Layout
findmnt(8)
\end_layout

\end_inset

,
 and 
\begin_inset Flex Code
status open

\begin_layout Plain Layout
lsblk(8)
\end_layout

\end_inset

 will also be an advantage —
 refer to the respective manual pages for more details.
\end_layout

\begin_layout Section
Naming Your Snapshot Set
\end_layout

\begin_layout Standard
You are free to name your snapshot set anything you like within the constraints enforced by 
\begin_inset Flex Code
status open

\begin_layout Plain Layout
snapm
\end_layout

\end_inset

 and its provider plugins:
\end_layout

\begin_layout Enumerate
The 
\begin_inset Quotes bld
\end_inset

_
\begin_inset Quotes brd
\end_inset

 (underscore) character is not permitted.
\end_layout

\begin_layout Enumerate
The valid characters for snapshot set names are the ASCII lowercase and uppercase alphabetic characters,
 the digits,
 and the symbols 
\begin_inset Quotes bld
\end_inset

+
\begin_inset Quotes brd
\end_inset

,
 
\begin_inset Quotes bld
\end_inset

.
\begin_inset Quotes brd
\end_inset

,
 and 
\begin_inset Quotes bld
\end_inset

-
\begin_inset Quotes brd
\end_inset

.
\end_layout

\begin_layout Enumerate
Certain strings may be forbidden by particular provider plugins:
 for instance,
 LVM2 reserves the string 
\begin_inset Quotes bld
\end_inset

_
\nospellcheck on
mlog
\nospellcheck default

\begin_inset Quotes brd
\end_inset

 (and others) for internal logical volume names.
\end_layout

\begin_layout Enumerate
Certain providers enforce a maximum name length,
 for example,
 for LVM2 volumes this is 127 characters.
 Note that this limit includes parts of the internal name generated by 
\begin_inset Flex Code
status open

\begin_layout Plain Layout
snapm
\end_layout

\end_inset

 (which varies according to the mount point the snapshot refers to),
 so the usable name length is somewhat shorter.
 Nobody likes long device names anyway so this should not be a concern in most situations.
\end_layout

\begin_layout Enumerate
If you include a 
\begin_inset Quotes bld
\end_inset

.
\begin_inset Quotes brd
\end_inset

 followed by a number at the end of your snapshot set name 
\begin_inset Flex Code
status open

\begin_layout Plain Layout
snapm
\end_layout

\end_inset

 will consider it to be an 
\begin_inset Flex Emph
status open

\begin_layout Plain Layout
index
\end_layout

\end_inset

.
 This is useful when taking recurring snapshots sets of the same things with a common base name.
 You can also have 
\begin_inset Flex Code
status open

\begin_layout Plain Layout
snapm
\end_layout

\end_inset

 add one automatically using the 
\begin_inset Flex Code
status open

\begin_layout Plain Layout
--autoindex
\end_layout

\end_inset

 option (more on that later).
\end_layout

\begin_layout Enumerate
It's generally best to not include a date or time reference in the name unless you really,
 really need to:
 
\begin_inset Flex Code
status open

\begin_layout Plain Layout
snapm
\end_layout

\end_inset

 already stores the creation time of the snapshot set as a UNIX epoch value and renders it in various output formats.
\end_layout

\begin_layout Enumerate
The name 
\begin_inset Quotes bld
\end_inset

.
\begin_inset Quotes brd
\end_inset

 is reserved by 
\begin_inset Flex Code
status open

\begin_layout Plain Layout
snapm
\end_layout

\end_inset

 for referencing the live root file system.
\end_layout

\begin_layout Standard
Aim for memorable and meaningful names:
 
\begin_inset Quotes bld
\end_inset


\nospellcheck on
quux-foo-backup
\nospellcheck default

\begin_inset Quotes brd
\end_inset

 might seem like a good idea at the time,
 when you're typing in a hurry,
 but future you will thank present you for coming up with something more self-explanatory.
\begin_inset Newline newline
\end_inset


\end_layout

\begin_layout Standard
Good names might be:
\end_layout

\begin_layout Itemize
\begin_inset Flex Code
status open

\begin_layout Plain Layout
before-upgrade
\end_layout

\end_inset


\end_layout

\begin_layout Itemize
\begin_inset Flex Code
status open

\begin_layout Plain Layout
after-upgrade
\end_layout

\end_inset


\end_layout

\begin_layout Itemize
\begin_inset Flex Code
status open

\begin_layout Plain Layout
pre-deployment
\end_layout

\end_inset


\end_layout

\begin_layout Itemize
\begin_inset Flex Code
status open

\begin_layout Plain Layout
post-deployment
\end_layout

\end_inset


\end_layout

\begin_layout Itemize
\begin_inset Flex Code
status open

\begin_layout Plain Layout
hourly.N
\end_layout

\end_inset

 (where 
\begin_inset Flex Code
status open

\begin_layout Plain Layout
\begin_inset Flex Emph
status open

\begin_layout Plain Layout
N
\end_layout

\end_inset


\end_layout

\end_inset

 is an integer uniquifying index enabled with 
\begin_inset Flex Code
status open

\begin_layout Plain Layout
--autoindex
\end_layout

\end_inset

 - see 
\begin_inset CommandInset ref
LatexCommand ref
reference "sec:Schedules-and-Autoindex"
plural "false"
caps "false"
noprefix "false"
nolink "false"

\end_inset

)
\end_layout

\begin_layout Standard
Bad names would include:
\end_layout

\begin_layout Itemize
\begin_inset Flex Code
status open

\begin_layout Plain Layout
backup
\end_layout

\end_inset


\end_layout

\begin_layout Itemize
\begin_inset Flex Code
status open

\begin_layout Plain Layout
thing
\end_layout

\end_inset


\end_layout

\begin_layout Itemize
\begin_inset Flex Code
status open

\begin_layout Plain Layout
thisone
\end_layout

\end_inset


\end_layout

\begin_layout Itemize
\begin_inset Flex Code
status open

\begin_layout Plain Layout
thatone
\end_layout

\end_inset


\end_layout

\begin_layout Itemize
\begin_inset Flex Code
status open

\begin_layout Plain Layout
something-something-something-snapshot-side
\end_layout

\end_inset


\end_layout

\begin_layout Itemize
\begin_inset Flex Code
status open

\begin_layout Plain Layout
fubar
\end_layout

\end_inset

,
 
\begin_inset Flex Code
status open

\begin_layout Plain Layout
plugh
\end_layout

\end_inset

,
 
\begin_inset Flex Code
status open

\begin_layout Plain Layout
quux
\end_layout

\end_inset

,
 
\begin_inset Flex Code
status open

\begin_layout Plain Layout
thud
\end_layout

\end_inset

,
 
\begin_inset Flex Code
status open

\begin_layout Plain Layout
xyzzy
\end_layout

\end_inset

,
 etc.
\end_layout

\begin_layout Section
Overriding The Default Size Policy
\end_layout

\begin_layout Section
\begin_inset Flex Code
status open

\begin_layout Plain Layout
snapm snapset create
\end_layout

\end_inset

 Output
\end_layout

\begin_layout Section
Care and Feeding of Your Snapshot Set
\end_layout

\begin_layout Standard
Monitoring and extending LVM2 CoW Snapshots
\end_layout

\begin_layout Chapter
Ontology of Snapshots
\end_layout

\begin_layout Quotation
\begin_inset Quotes bld
\end_inset


\begin_inset Quotes bls
\end_inset

The simulacrum is never that which conceals the truth—
it is the truth which conceals that there is none.
 The simulacrum is true.
\begin_inset Quotes brs
\end_inset

 —
 Ecclesiastes
\begin_inset Quotes brd
\end_inset

 —
 Jean Baudrillard,
 
\begin_inset Quotes bld
\end_inset

Simulacra and Simulation
\begin_inset Quotes brd
\end_inset

,
 1981
\begin_inset Foot
status open

\begin_layout Plain Layout
This Is Not A Mistake.
\end_layout

\end_inset

.
\end_layout

\begin_layout Standard
At this point it would be wise to take a moment to reflect on what a 
\begin_inset Flex Emph
status open

\begin_layout Plain Layout
snapshot
\end_layout

\end_inset

 is,
 particularly in the context of 
\begin_inset Flex Code
status open

\begin_layout Plain Layout
snapm
\end_layout

\end_inset

,
 and what exactly that means for our systems.
 Trust us:
 while this may seem overly philosophical right now,
 it will help lay the foundations for the abstractions we later build together.
\end_layout

\begin_layout Section
Ontological Status - Is the Snapshot a 
\begin_inset Quotes bld
\end_inset

Copy
\begin_inset Quotes brd
\end_inset

 Or is it Equally 
\begin_inset Quotes bld
\end_inset

Real
\begin_inset Quotes brd
\end_inset

?
\end_layout

\begin_layout Section
Temporal Primality - Which System is 
\begin_inset Quotes bld
\end_inset

THE
\begin_inset Quotes brd
\end_inset

 System When Both Exist?
\end_layout

\begin_layout Section
Action Location - Does it Matter WHERE You Perform the Upgrade?
\end_layout

\begin_layout Section
Operation Semantics - 
\begin_inset Quotes bld
\end_inset

Revert
\begin_inset Quotes brd
\end_inset

 Implies Hierarchy;
 
\begin_inset Quotes bld
\end_inset

Merge
\begin_inset Quotes brd
\end_inset

 Implies Equality
\end_layout

\begin_layout Section
Reality Tunnels - Each Snapshot is a Valid Reality,
 Not a Subordinate Copy
\end_layout

\begin_layout Chapter
Command Quick Reference
\end_layout

\begin_layout Quotation
\begin_inset Quotes bld
\end_inset

It is not enough to curse the darkness,
 it is necessary to light a lamp
\begin_inset Quotes brd
\end_inset

 —
 William L.
 Watkinson,
 1907.
\end_layout

\begin_layout Standard
The cheat sheet.
 Every command on two pages.
\end_layout

\begin_layout Section
Snapset commands:
 
\begin_inset Flex Code
status open

\begin_layout Plain Layout
create
\end_layout

\end_inset

,
 
\begin_inset Flex Code
status open

\begin_layout Plain Layout
create-scheduled
\end_layout

\end_inset

,
 
\begin_inset Flex Code
status open

\begin_layout Plain Layout
delete
\end_layout

\end_inset

,
 
\begin_inset Flex Code
status open

\begin_layout Plain Layout
rename
\end_layout

\end_inset

,
 
\begin_inset Flex Code
status open

\begin_layout Plain Layout
revert
\end_layout

\end_inset

,
 
\begin_inset Flex Code
status open

\begin_layout Plain Layout
resize
\end_layout

\end_inset

,
 
\begin_inset Flex Code
status open

\begin_layout Plain Layout
split
\end_layout

\end_inset

,
 
\begin_inset Flex Code
status open

\begin_layout Plain Layout
prune
\end_layout

\end_inset

,
 
\begin_inset Flex Code
status open

\begin_layout Plain Layout
activate
\end_layout

\end_inset

,
 
\begin_inset Flex Code
status open

\begin_layout Plain Layout
deactivate
\end_layout

\end_inset

,
 
\begin_inset Flex Code
status open

\begin_layout Plain Layout
autoactivate
\end_layout

\end_inset

,
 
\begin_inset Flex Code
status open

\begin_layout Plain Layout
list
\end_layout

\end_inset

,
 
\begin_inset Flex Code
status open

\begin_layout Plain Layout
show
\end_layout

\end_inset


\end_layout

\begin_layout Section
Snapset mount commands:
 
\begin_inset Flex Code
status open

\begin_layout Plain Layout
mount
\end_layout

\end_inset

,
 
\begin_inset Flex Code
status open

\begin_layout Plain Layout
umount
\end_layout

\end_inset

,
 
\begin_inset Flex Code
status open

\begin_layout Plain Layout
exec
\end_layout

\end_inset

,
 
\begin_inset Flex Code
status open

\begin_layout Plain Layout
shell
\end_layout

\end_inset


\end_layout

\begin_layout Section
Snapset comparison commands:
 
\begin_inset Flex Code
status open

\begin_layout Plain Layout
diff
\end_layout

\end_inset

,
 
\begin_inset Flex Code
status open

\begin_layout Plain Layout
diffreport
\end_layout

\end_inset


\end_layout

\begin_layout Section
Snapshot commands:
 
\begin_inset Flex Code
status open

\begin_layout Plain Layout
activate
\end_layout

\end_inset

,
 
\begin_inset Flex Code
status open

\begin_layout Plain Layout
deactivate
\end_layout

\end_inset

,
 
\begin_inset Flex Code
status open

\begin_layout Plain Layout
autoactivate
\end_layout

\end_inset

,
 
\begin_inset Flex Code
status open

\begin_layout Plain Layout
list
\end_layout

\end_inset

,
 
\begin_inset Flex Code
status open

\begin_layout Plain Layout
show
\end_layout

\end_inset


\end_layout

\begin_layout Section
Schedule commands:
 
\begin_inset Flex Code
status open

\begin_layout Plain Layout
create
\end_layout

\end_inset

,
 
\begin_inset Flex Code
status open

\begin_layout Plain Layout
delete
\end_layout

\end_inset

,
 
\begin_inset Flex Code
status open

\begin_layout Plain Layout
edit
\end_layout

\end_inset

,
 
\begin_inset Flex Code
status open

\begin_layout Plain Layout
enable
\end_layout

\end_inset

,
 
\begin_inset Flex Code
status open

\begin_layout Plain Layout
disable
\end_layout

\end_inset

,
 
\begin_inset Flex Code
status open

\begin_layout Plain Layout
list
\end_layout

\end_inset

,
 
\begin_inset Flex Code
status open

\begin_layout Plain Layout
show
\end_layout

\end_inset

,
 
\begin_inset Flex Code
status open

\begin_layout Plain Layout
gc
\end_layout

\end_inset


\end_layout

\begin_layout Section
Plugin commands:
 
\begin_inset Flex Code
status open

\begin_layout Plain Layout
list
\end_layout

\end_inset


\end_layout

\begin_layout Section
Global options:
 
\begin_inset Flex Code
status open

\begin_layout Plain Layout
--debug
\end_layout

\end_inset

,
 
\begin_inset Flex Code
status open

\begin_layout Plain Layout
--verbose
\end_layout

\end_inset

,
 
\begin_inset Flex Code
status open

\begin_layout Plain Layout
--help
\end_layout

\end_inset

,
 
\begin_inset Flex Code
status open

\begin_layout Plain Layout
--version
\end_layout

\end_inset


\end_layout

\begin_layout Chapter
Project History
\end_layout

\begin_layout Quotation
\begin_inset Quotes bld
\end_inset

History is the shock-wave of the eschaton
\begin_inset Quotes brd
\end_inset

 —
 Terrence McKenna,
 
\begin_inset Quotes bld
\end_inset

Re:Evolution
\begin_inset Quotes brd
\end_inset

,
 1992.
\end_layout

\begin_layout Section
In The Beginning:
 The 
\begin_inset Flex Code
status open

\begin_layout Plain Layout
boom
\end_layout

\end_inset

 Boot Manager (2017)
\end_layout

\begin_layout Section
The Snapshot Manager Proposal (2020)
\end_layout

\begin_layout Section
Hiatus:
 Other Projects (2020-2023)
\end_layout

\begin_layout Section
For To Us 
\begin_inset Flex Code
status open

\begin_layout Plain Layout
snapm
\end_layout

\end_inset

 Is Born:
 the MVP (2023)
\end_layout

\begin_layout Section
Milestone II:
 Scheduling and Garbage Collection (2024-2025)
\end_layout

\begin_layout Section
Milestone III:
 Snapshot Inspection and Comparison (2025)
\end_layout

\begin_layout Section
Future Work:
 Milestone IV,
 Application Coordination
\end_layout

\begin_layout Part
Core Operations
\end_layout

\begin_layout Chapter
Storage Back-ends
\end_layout

\begin_layout Quotation
\begin_inset Quotes bld
\end_inset

What's it all for?
 Does it do any ultimate good?
 Or even ultimate bad?
\begin_inset Quotes brd
\end_inset

 —
 Fungus The Bogeyman,
 1977.
\end_layout

\begin_layout Section
\begin_inset CommandInset label
LatexCommand label
name "sec:LVM2-CoW"

\end_inset

LVM2 CoW
\end_layout

\begin_layout Standard
The LVM2 copy-on-write snapshot target (
\begin_inset Flex Code
status open

\begin_layout Plain Layout
dm-snapshot
\end_layout

\end_inset

) is the O.G.
 Linux block device snapshot implementation.
 It is simple,
 universal,
 and somewhat limited.
 For small numbers of snapshots,
 or occasional use,
 it's perfectly fine,
 but it consumes fixed space allocations for each snapshot and has severe performance scalability problems when there are many snapshots of the same origin volume (the 
\begin_inset Flex Emph
status open

\begin_layout Plain Layout
write amplification
\end_layout

\end_inset

 effect).
\end_layout

\begin_layout Standard
Specifically,
 LVM2 CoW snapshots will allocate a separate backing store for each snapshot.
 A consequence of this design is that each write to the origin volume will trigger 
\begin_inset Formula $N$
\end_inset

 writes to the backing stores,
 where 
\begin_inset Formula $N$
\end_inset

 is the number of concurrent snapshots of the same origin.
 This leads to severe write performance degradation when there are more than a small number of simultaneous snapshots for any given origin.
 For this reason 
\begin_inset Flex Code
status open

\begin_layout Plain Layout
snapm
\end_layout

\end_inset

 defaults to a maximum of seven snapshots per LVM2 CoW origin device.
 Even that is pushing it a little.
 To find out how to raise or lower this limit refer to 
\begin_inset CommandInset ref
LatexCommand ref
reference "sec:conf-plugins.d"
plural "false"
caps "false"
noprefix "false"
nolink "false"

\end_inset

.
\end_layout

\begin_layout Standard
The upside of CoW is that it requires no planning or special preparation - just an LVM2 volume group with enough free space for the snapshots that you wish to allocate.
\end_layout

\begin_layout Standard
The major downside of CoW,
 beyond the performance concern,
 is the fixed-sized backing store (the 
\begin_inset Flex Emph
status open

\begin_layout Plain Layout
exception store
\end_layout

\end_inset

).
 If this space is exhausted due to divergence from the origin the snapshot will abruptly transition to the 
\begin_inset Flex Emph
status open

\begin_layout Plain Layout
invalid
\end_layout

\end_inset

 state:
 unusable,
 unreadable,
 and fairly unrepairable.
 This is because writes to the origin volume can no longer be preserved,
 meaning that the state of the snapshot image is no longer a consistent file system image (since any reads to the snapshot that are not present in the CoW exception store are taken directly from the origin - which has now moved on to an entirely different state that the snapshot is blissfully unaware of).
\end_layout

\begin_layout Section
LVM2 Thin 
\end_layout

\begin_layout Standard
The LVM2 thin implementation uses the device-mapper 
\begin_inset Flex Code
status open

\begin_layout Plain Layout
thin-pool
\end_layout

\end_inset

 and 
\begin_inset Flex Code
status open

\begin_layout Plain Layout
thin
\end_layout

\end_inset

 to implement thin provisioning and efficient snapshots.
 It is the future of snapshot for the Linux Logical Volume Manager.
 While performance does degrade somewhat when there are 
\begin_inset Flex Emph
status open

\begin_layout Plain Layout
many
\end_layout

\end_inset

 snapshots within the same thin pool (for values of 
\begin_inset Flex Emph
status open

\begin_layout Plain Layout
many
\end_layout

\end_inset

 much greater than 
\begin_inset Flex Code
status open

\begin_layout Plain Layout
dm-snapshot
\end_layout

\end_inset

 can tolerate and still deliver usable performance) it is much more scalable,
 flexible,
 and,
 well,
 modern,
 than its predecessor.
 In addition,
 thin snapshots take their backing store space from the common space available to the thin pool that contains them:
 this frees the administrator from the need to foresee exact space requirements and plan accordingly.
\end_layout

\begin_layout Standard
The catch (there is always a catch) is that thin pools and volumes do require a bit more set up and planning than their simple linear CoW counterparts.
 This is in most cases well worth the effort.
\end_layout

\begin_layout Section
\begin_inset CommandInset label
LatexCommand label
name "sec:Stratis"

\end_inset

Stratis
\end_layout

\begin_layout Standard
Stratis is a Linux local storage management tool that aims to enable easy use of advanced storage features such as thin provisioning,
 snapshots,
 and pool-based management and monitoring.
\end_layout

\begin_layout Standard
It uses the same device-mapper 
\begin_inset Flex Code
status open

\begin_layout Plain Layout
thin-pool
\end_layout

\end_inset

 and 
\begin_inset Flex Code
status open

\begin_layout Plain Layout
thin
\end_layout

\end_inset

 targets used by LVM2 thin provisioning but provides a more ZFS or Btrfs like user experience.
 Stratis is an excellent choice for auxiliary storage volumes but is not currently supported for installation by any of the common Linux distribution installer tools (unless you like your root file system held together with candle wax and sticky-tape - in which case,
 check out the author's 
\begin_inset Flex Code
status open

\begin_layout Plain Layout
stratify.py
\end_layout

\end_inset

 script that will bootstrap a Stratis root file system for you in as little as twenty minutes:
 
\begin_inset Flex URL
status open

\begin_layout Plain Layout

https://stratis-storage.github.io/stratify/
\end_layout

\end_inset

).
\end_layout

\begin_layout Standard
Stratis provides almost all the benefits of LVM2 thin provisioning and more with a simplified and modern CLI and powerful DBus interface.
 See the Stratis Storage website for further information:
 
\begin_inset Flex URL
status open

\begin_layout Plain Layout

https://stratis-storage.github.io/
\end_layout

\end_inset

.
\end_layout

\begin_layout Section
Choosing The Right Back-end For Your Workload
\end_layout

\begin_layout Section
Experimentation
\end_layout

\begin_layout Standard
If you're just experimenting,
 kicking the tyres and trying things out,
 LVM2 CoW is more than adequate.
 It will allow you to try out a majority of 
\begin_inset Flex Code
status open

\begin_layout Plain Layout
snapm
\end_layout

\end_inset


\nospellcheck on
's
\nospellcheck default
 feature set with the least amount of set up and storage knowledge.
 The installer will put it all together for you (just remember to leave some free space in your volume group,
 either when configuring it at installation time,
 or by provisioning additional storage post install and using the 
\begin_inset Flex Code
status open

\begin_layout Plain Layout
vgextend(8)
\end_layout

\end_inset

 command).
 Just note that you will by default be limited to no more than seven snapshots per origin volume as noted in 
\begin_inset CommandInset ref
LatexCommand ref
reference "sec:LVM2-CoW"
plural "false"
caps "false"
noprefix "false"
nolink "false"

\end_inset

.
 For testing purposes it is legitimate to increase this limit following the steps given in 
\begin_inset CommandInset ref
LatexCommand ref
reference "sec:conf-plugins.d"
plural "false"
caps "false"
noprefix "false"
nolink "false"

\end_inset

 but do not expect stellar performance from such a configuration.
\end_layout

\begin_layout Section
Production
\end_layout

\begin_layout Standard
For production deployments it is worth going all in on a thinly-provisioned storage layout.
 The additional time and effort configuring the system will pay dividends when you go into production and allows more complete use of 
\begin_inset Flex Code
status open

\begin_layout Plain Layout
snapm
\end_layout

\end_inset

's advanced features such as scheduled snapshot set creation and garbage collection,
 particularly when using the 
\begin_inset Flex Emph
status open

\begin_layout Plain Layout
Timeline
\end_layout

\end_inset

 garbage collection policy.
\end_layout

\begin_layout Standard
Whether to use LVM2 thin or Stratis is a matter of personal taste,
 organisational policy,
 administrator experience and convenience (subject to the limitations discussed in 
\begin_inset CommandInset ref
LatexCommand ref
reference "sec:Stratis"
plural "false"
caps "false"
noprefix "false"
nolink "false"

\end_inset

).
\end_layout

\begin_layout Section
Operating System vs.
 Application Data
\end_layout

\begin_layout Standard
There is a possible argument for using conventional (non-thin) LVM2 for the system volumes and thin provisioning for everything else,
 however it is fairly weak:
 modern installers such as Anaconda (used in Fedora,
 CentOS,
 and Red Hat Enterprise Linux) can create a thinly provisioned set up automatically and set the system up for success.
 It is true that a 
\begin_inset Flex Emph
status open

\begin_layout Plain Layout
non-thin
\end_layout

\end_inset

 configuration eliminates certain failure modes (particularly exhaustion of the space available in the thin pools,
 potentially leading to write errors and broken file systems) but this risk can be adequately controlled with the tools made available by the LVM2 project.
 See the LVM documentation for further information and instructions - particularly the 
\begin_inset Flex Code
status open

\begin_layout Plain Layout
lvmthin(7)
\end_layout

\end_inset

 manual page.
\end_layout

\begin_layout Chapter
Storage Planning
\end_layout

\begin_layout Quotation
\begin_inset Quotes bld
\end_inset

Freedom lies in being bold.
\begin_inset Quotes brd
\end_inset

 —
Robert Frost,
 1952.
\begin_inset VSpace defskip
\end_inset


\end_layout

\begin_layout Section
Mount Layouts and Revert Granularity
\end_layout

\begin_layout Section
Sizing Snapshots
\end_layout

\begin_layout Section
Capacity Planning
\end_layout

\begin_layout Section
Monitoring Usage
\end_layout

\begin_layout Section
When Thin Provisioning Wins
\end_layout

\begin_layout Chapter
Snapshot Sets
\end_layout

\begin_layout Quotation
\begin_inset Quotes bld
\end_inset

Flash,
 bang,
 wallop,
 what a picture!
 What a photograph!
\begin_inset Quotes brd
\end_inset

 —
 Tommy Steele,
 1979.
\end_layout

\begin_layout Standard
The fundamentals of snapshot management with 
\begin_inset Flex Code
status open

\begin_layout Plain Layout
snapm
\end_layout

\end_inset

:
 basic operations on snapshot sets.
\end_layout

\begin_layout Section
Creating
\end_layout

\begin_layout Section
Listing
\end_layout

\begin_layout Section
Showing
\end_layout

\begin_layout Section
Deleting
\end_layout

\begin_layout Section
Renaming
\end_layout

\begin_layout Section
Splitting
\end_layout

\begin_layout Section
Pruning
\end_layout

\begin_layout Chapter
Bootable Snapshot Sets and 
\begin_inset Flex Code
status open

\begin_layout Plain Layout
boom
\end_layout

\end_inset


\end_layout

\begin_layout Quotation
\begin_inset Quotes bld
\end_inset

It is conjectured that Mr.
 Murphee will now be enabled to hand himself over the Cumberland river or a barn yard fence by the straps of his boots.
\begin_inset Quotes brd
\end_inset

 —
 Workingman's Advocate,
 1834.
\end_layout

\begin_layout Section
How 
\begin_inset Flex Code
status open

\begin_layout Plain Layout
snapm
\end_layout

\end_inset

 and 
\begin_inset Flex Code
status open

\begin_layout Plain Layout
boom
\end_layout

\end_inset

 Work Together
\end_layout

\begin_layout Section
Automatic 
\begin_inset Flex Code
status open

\begin_layout Plain Layout
boom OsProfile
\end_layout

\end_inset

 Creation
\end_layout

\begin_layout Section
The 
\begin_inset Flex Code
status open

\begin_layout Plain Layout
--boot
\end_layout

\end_inset

 And 
\begin_inset Flex Code
status open

\begin_layout Plain Layout
--revert
\end_layout

\end_inset

 Options
\end_layout

\begin_layout Section
Boot Entries
\end_layout

\begin_layout Section
Revert Entries
\end_layout

\begin_layout Section
The Snapshot Boot Life-cycle
\end_layout

\begin_layout Chapter
The Scheduler
\end_layout

\begin_layout Quotation
\begin_inset Quotes bld
\end_inset

People assume that time is a strict progression of cause to effect.
 But actually,
 from a nonlinear,
 non-subjective viewpoint,
 it's more like a big ball of wibbly wobbly,
 timey wimey stuff.
\begin_inset Quotes brd
\end_inset

 —
 The 10th Doctor,
 
\begin_inset Quotes bld
\end_inset

Blink
\begin_inset Quotes brd
\end_inset

,
 by Steven Moffat,
 2007.
\end_layout

\begin_layout Section
Automated Snapshot Set Scheduling With 
\begin_inset Flex Code
status open

\begin_layout Plain Layout
systemd
\end_layout

\end_inset

 Timer Integration
\end_layout

\begin_layout Section

\nospellcheck on
\begin_inset Flex Code
status open

\begin_layout Plain Layout

\nospellcheck on
CalendarSpecs
\end_layout

\end_inset


\end_layout

\begin_layout Section
\begin_inset CommandInset label
LatexCommand label
name "sec:Schedules-and-Autoindex"

\end_inset

Schedules and 
\begin_inset Flex Code
status open

\begin_layout Plain Layout
--autoindex
\end_layout

\end_inset

 Names
\end_layout

\begin_layout Section
Enabling and Disabling Schedules
\end_layout

\begin_layout Section
Editing Schedules by Hand
\end_layout

\begin_layout Chapter
Garbage Collection
\end_layout

\begin_layout Quotation
\begin_inset Quotes bld
\end_inset

You see?
 The population census has got him down as 
\begin_inset Quotes bls
\end_inset

dormanted.
\begin_inset Quotes brs
\end_inset

 Uh,
 the Central Collective Storehouse computer has got him down as 
\begin_inset Quotes bls
\end_inset

deleted.
\begin_inset Quotes brs
\end_inset

 Information Retrieval has got him down as 
\begin_inset Quotes bls
\end_inset

inoperative.
\begin_inset Quotes brs
\end_inset

 And there's another one - security has got him down as 
\begin_inset Quotes bls
\end_inset

excised.
\begin_inset Quotes brs
\end_inset

 Administration has got him down as 
\begin_inset Quotes bls
\end_inset

completed.
\begin_inset Quotes brs
\end_inset


\begin_inset Quotes xrd
\end_inset

 —
 Mr.
 Kurtzmann,
 Brazil,
 by Terry Gilliam,
 1985.
\end_layout

\begin_layout Standard
Retention policies in depth.
 Count,
 Age,
 Timeline,
 All.
 When to use each and why.
\end_layout

\begin_layout Section
What garbage Collection Does
\end_layout

\begin_layout Standard
Automatic deletion of snapshot sets that are no longer needed.
\end_layout

\begin_layout Section
Why You Need to Clean Up After Yourself
\end_layout

\begin_layout Subsection
CoW Snapshot Performance Scaling
\end_layout

\begin_layout Standard
These numbers are a little old,
 but still illustrative.
 The following performance data was captured on a system with the following characteristics:
\end_layout

\begin_layout Itemize
CPU Intel(R) Core(TM) i7-1165G7 @ 2.80GHz,
 4 cores
\end_layout

\begin_layout Itemize
16 GiB RAM
\end_layout

\begin_layout Itemize
PCIe Gen 4.
 nvme (Crucial CT1000P5PSSD8)
\end_layout

\begin_layout Itemize
kernel 6.9.0-0.rc2
\end_layout

\begin_layout Itemize
XFS with default 
\begin_inset Flex Code
status open

\begin_layout Plain Layout
mkfs.xfs(8)
\end_layout

\end_inset

 options
\end_layout

\begin_layout Itemize
LVM2 CoW and thin snapshots created with LVM defaults
\end_layout

\begin_layout Standard
\align center
\begin_inset Graphics
	filename images/io-throughput.svg

\end_inset


\end_layout

\begin_layout Subsection
Invalidation:
 The Dangers of CoW Exception Store Overflow
\end_layout

\begin_layout Standard
As mentioned briefly in 
\begin_inset CommandInset ref
LatexCommand ref
reference "sec:LVM2-CoW"
plural "false"
caps "false"
noprefix "false"
nolink "false"

\end_inset

 the LVM2 CoW snapshot mechanism that makes use of the device-mapper 
\begin_inset Flex Code
status open

\begin_layout Plain Layout
dm-snapshot
\end_layout

\end_inset

 target is vulnerable to data loss on the snapshot volume when the space allocated to the exception store is exhausted.
\end_layout

\begin_layout Standard
This is a natural consequence of the simple design of the target:
 whenever a write to the origin volume occurs,
 the target first reads the data that is to be overwritten from the origin,
 and then writes it to the exception store,
 along with a small amount of metadata to describe the location that has been changed.
 When there is no space left in the exception store for the data overwritten by a new write to be preserved the snapshot volume fails abruptly and transitions to the 
\begin_inset Flex Emph
status open

\begin_layout Plain Layout
Invalid
\end_layout

\end_inset

 state.
\end_layout

\begin_layout Standard
This is to be avoided at all costs since recovery is difficult and uncertain - even if you can recover an image of the snapshot for data recovery (and no well supported tools exists to automate this) it will inherently be partial and will contain inconsistent,
 corrupt or missing data.
\end_layout

\begin_layout Standard
To prevent exception store overflow and invalidation ensure:
\end_layout

\begin_layout Standard
Sufficient space is allocated to all CoW snapshots for the anticipated write volume that will occur during the lifetime of the snapshot.
\end_layout

\begin_layout Standard
For critical volumes,
 or where the write volume cannot be predicted with reasonable certainty consider enabling monitoring using the LVM command 
\begin_inset Flex Code
status open

\begin_layout Plain Layout
lvchange –-monitor
\end_layout

\end_inset

 (
\begin_inset Flex Code
status open

\begin_layout Plain Layout
lvchange(8)
\end_layout

\end_inset

) and configuring 
\begin_inset Flex Code
status open

\begin_layout Plain Layout
activation/snapshot_autoextend_threshold
\end_layout

\end_inset

 and
\begin_inset Newline newline
\end_inset


\begin_inset Flex Code
status open

\begin_layout Plain Layout
activation/snapshot_autoextend_percent
\end_layout

\end_inset

 in 
\begin_inset Flex Code
status open

\begin_layout Plain Layout
/etc/lvm/lvm.conf
\end_layout

\end_inset

 (
\begin_inset Flex Code
status open

\begin_layout Plain Layout
lvm.conf(5)
\end_layout

\end_inset

) to automatically increase the size of the snapshot exception store when a certain amount of space is already consumed.
\end_layout

\begin_layout Subsection
Performance Impacts for Thin Pools With Many Snapshots
\end_layout

\begin_layout Standard
There is a performance hit from having many snapshots in a 
\begin_inset Flex Code
status open

\begin_layout Plain Layout
dm-thin
\end_layout

\end_inset

 thin pool:
 initially,
 when a snapshot is created it shared all of its data blocks with the origin.
 As the volumes diverge over time (due to writes to the origin),
 these blocks are 
\begin_inset Flex Emph
status open

\begin_layout Plain Layout
unshared
\end_layout

\end_inset

:
 the B-tree nodes of the snapshot volume are updated to reference the original data,
 while the origin allocates a new block for the overwritten data.
 When many snapshots exist this can become costly,
 leading to degraded performance when many snapshots exist.
 For this reason,
 
\begin_inset Flex Code
status open

\begin_layout Plain Layout
snapm
\end_layout

\end_inset

 by default limits the number of snapshots in a single thin pool to 1000 via the 
\begin_inset Flex Emph
status open

\begin_layout Plain Layout
MaxSnapshotsPerPool
\end_layout

\end_inset

 
\begin_inset Flex Code
status open

\begin_layout Plain Layout
plugins.d
\end_layout

\end_inset

 configuration key (
\begin_inset CommandInset ref
LatexCommand ref
reference "sec:conf-plugins.d"
plural "false"
caps "false"
noprefix "false"
nolink "false"

\end_inset

).
\end_layout

\begin_layout Standard
There is a further potential performance hit from fragmentation of the thin pool data volume that can occur when many thin volume writes are interleaved into the data store (due to writes that trigger new block allocations occurring consecutively to different thin volumes within the pool).
 This is primarily a concern for conventional hard disk drives (HDDs) due to the seek penalty imposed by moving the physical read/write head to a new location on the disk.
 It is much less of a concern for modern solid state drives (SSDs).
 There is currently not much that you can do to avoid fragmentation or to address it if it does occur.
 Pre-allocating volumes (to avoid interleaved growth) it one possible amelioration but this requires foresight for the amount of space required and to some extent defeats the benefits of thin provisioning.
\end_layout

\begin_layout Section
The Count policy:
 Keep a Fixed Number of Most Recent Snapsets
\end_layout

\begin_layout Standard
Simple,
 predictable space usage.
\end_layout

\begin_layout Section
The Age policy:
 Keep Snapsets Younger Than a Threshold
\end_layout

\begin_layout Standard
Time based retention with 
\begin_inset Flex Code
status open

\begin_layout Plain Layout
--keep-days
\end_layout

\end_inset

,
 
\begin_inset Flex Code
status open

\begin_layout Plain Layout
--keep-weeks
\end_layout

\end_inset

,
 
\begin_inset Flex Code
status open

\begin_layout Plain Layout
--keep-months
\end_layout

\end_inset

,
 
\begin_inset Flex Code
status open

\begin_layout Plain Layout
--keep-years
\end_layout

\end_inset

.
\end_layout

\begin_layout Section
The Timeline policy:
 Grandfathered Retention
\end_layout

\begin_layout Standard
Keep hourly,
 daily,
 weekly,
 monthly,
 quarterly,
 yearly snapsets.
 Best for long term history with diminishing granularity.
\end_layout

\begin_layout Section
The All policy:
 Never Delete Anything Automatically
\end_layout

\begin_layout Standard
Manual cleanup only.
\end_layout

\begin_layout Section
Running Garbage Collection
\end_layout

\begin_layout Enumerate
Automatic via timer
\end_layout

\begin_layout Enumerate
Manual with 
\begin_inset Flex Code
status open

\begin_layout Plain Layout
snapm schedule gc
\end_layout

\end_inset


\end_layout

\begin_layout Chapter
Progress Reporting for Long Running Operations
\end_layout

\begin_layout Section
Unicode vs.
 ASCII
\end_layout

\begin_layout Section
Colour Support
\end_layout

\begin_layout Section
Disabling Progress Reporting
\end_layout

\begin_layout Section
Throbbers (unbounded work)
\end_layout

\begin_layout Section
Progress Bars (bounded work)
\end_layout

\begin_layout Chapter
\begin_inset CommandInset label
LatexCommand label
name "chap:The-Mount-Manager"

\end_inset

The Mount Manager
\end_layout

\begin_layout Quotation
\begin_inset Quotes bld
\end_inset

You cannot be a good mountaineer,
 however great your ability unless you are cheerful and have the spirit of comradeship
\begin_inset Quotes brd
\end_inset

 —
 Tenzing Norgay,
 Tiger of the Snows,
 1955.
\begin_inset VSpace defskip
\end_inset


\end_layout

\begin_layout Section
Accessing snapshot contents without rebooting
\end_layout

\begin_layout Section
Mounting Snapshot Sets
\end_layout

\begin_layout Section
Unmounting Snapshot Sets
\end_layout

\begin_layout Section
Executing Commands in a Snapshot Set
\end_layout

\begin_layout Section
Getting An Interactive Shell in a Snapshot Set
\end_layout

\begin_layout Chapter
The Difference Engine
\end_layout

\begin_layout Quotation
\begin_inset Quotes bld
\end_inset

The errors which arise from the absence of facts are far more numerous and more durable than those which result from unsound reasoning respecting true data.
\begin_inset Quotes brd
\end_inset

 —
 Charles Babbage,
 On the Economy of Machinery and Manufactures,
 1832.
\begin_inset VSpace defskip
\end_inset


\end_layout

\begin_layout Paragraph
A word of caution:
\end_layout

\begin_layout Standard
The Difference Engine is a 
\begin_inset Flex Emph
status open

\begin_layout Plain Layout
change
\end_layout

\end_inset

 detector,
 not a 
\begin_inset Flex Emph
status open

\begin_layout Plain Layout
broken things
\end_layout

\end_inset

 detector.
 It will only reveal things that 
\begin_inset Flex Emph
status open

\begin_layout Plain Layout
changed
\end_layout

\end_inset

 between snapshots—
configurations that once worked but are now broken,
 or vice-versa.
 It has 
\begin_inset Flex Strong
status open

\begin_layout Plain Layout
no ability
\end_layout

\end_inset

 to reveal configuration errors,
 missing dependencies,
 or other problems that have 
\begin_inset Flex Strong
status open

\begin_layout Plain Layout
always
\end_layout

\end_inset

 been present on the system.
 If something was wrong in both snapshots sets,
 you won't see it.
\end_layout

\begin_layout Standard
A vague discussion of an 
\begin_inset Flex Emph
status open

\begin_layout Plain Layout
Analytical Engine
\end_layout

\end_inset

 to supplement the Difference Engine and provide exactly this kind of facility has been had,
 but is as yet so far out there that it hasn't even made the 
\begin_inset Flex Emph
status open

\begin_layout Plain Layout
Future Plans
\end_layout

\end_inset

 chapter yet (
\begin_inset CommandInset ref
LatexCommand ref
reference "chap:Future-Plans"
plural "false"
caps "false"
noprefix "false"
nolink "false"

\end_inset

).
\end_layout

\begin_layout Section
Comparing snapshot sets
\end_layout

\begin_layout Section
Output formats
\end_layout

\begin_layout Section
Filtering results
\end_layout

\begin_layout Subsection
Filtering at difference generation time
\end_layout

\begin_layout Subsection
Post Processing With Other Tools
\end_layout

\begin_layout Section
The 
\begin_inset Flex Code
status open

\begin_layout Plain Layout
diffcache
\end_layout

\end_inset


\end_layout

\begin_layout Chapter
Security,
 Privacy,
 and Confidentiality Considerations
\end_layout

\begin_layout Quotation
\begin_inset Quotes bld
\end_inset

Excuse me,
 sir.
 Seeing as how the VP is such a VIP,
 shouldn't we keep the PC on the QT?
 
\nospellcheck on
'Cause
\nospellcheck default
 if it leaks to the 
\nospellcheck on
VC
\nospellcheck default
 he could end up MIA,
 and then we'd all be put on KP!
\begin_inset Quotes brd
\end_inset

 —
 Adrian Cronauer (Robin Williams),
 Good Morning Vietnam,
 by Barry Levinson,
 1987.
\end_layout

\begin_layout Section
Old Snapshot Sets Have Old Bugs
\end_layout

\begin_layout Standard
As Augustus De Morgan wrote in 
\begin_inset Flex Emph
status open

\begin_layout Plain Layout
Siphonaptera
\end_layout

\end_inset

:
 
\begin_inset Quotes bld
\end_inset

Great fleas have little fleas upon their backs to bite 'em,
 and little fleas have lesser fleas,
 and so ad infinitum.
\begin_inset Quotes brd
\end_inset

,
 so it also is with snapshots:
 you may want to revert to last Sunday's snapshot because the system 
\begin_inset Flex Emph
status open

\begin_layout Plain Layout
worked
\end_layout

\end_inset

 then,
 but it is important to be aware that when travelling back in time with the magic of snapshots,
 we also get to revisit yesterday's CVEs,
 crashes,
 and data corruptors.
\end_layout

\begin_layout Subsection
Using Security Scanners with 
\begin_inset Flex Code
status open

\begin_layout Plain Layout
snapm
\end_layout

\end_inset

 snapshot sets
\end_layout

\begin_layout Standard
The Manual does not pretend to be a comprehensive guide to security scanning and auditing of Linux systems but this subsection provides some example commands for common open source security scanning tools that the reader may use as an introduction to applying these programs to 
\begin_inset Flex Code
status open

\begin_layout Plain Layout
snapm
\end_layout

\end_inset

 managed system snapshots.
\end_layout

\begin_layout Subsubsection
Trivy
\end_layout

\begin_layout Standard
The trivy program provides clearly formatted reports showing detected vulnerabilities and secrets.
 It is best to exclude certain paths from the process to avoid errors during the scan.
 Refer to the Trivy website at 
\begin_inset Flex URL
status open

\begin_layout Plain Layout

https://trivy.dev/
\end_layout

\end_inset

 for additional resources.
 Since the snapshot set paths are lengthy and the 
\begin_inset Flex Code
status open

\begin_layout Plain Layout
--skip-dirs
\end_layout

\end_inset

 arguments repetitive,
 we suggest using a shell variable:
\end_layout

\begin_layout Standard
\begin_inset Box Frameless
position "t"
hor_pos "c"
has_inner_box 1
inner_pos "t"
use_parbox 0
use_makebox 0
width "100col%"
special "none"
height "1in"
height_special "totalheight"
thickness "0.4pt"
separation "3pt"
shadowsize "4pt"
framecolor "default"
backgroundcolor "none"
status open

\begin_layout Plain Layout
\begin_inset Flex Code
status open

\begin_layout Plain Layout
# MNT="/run/snapm/mounts/before-upgrade"
\begin_inset Newline newline
\end_inset

# trivy filesystem /run/snapm/mounts/my-snapshot-set --skip-dirs $MNT/run --skip-dirs $MNT/proc --skip-dirs $MNT/var --skip-dirs $MNT/sys
\end_layout

\end_inset


\end_layout

\end_inset


\end_layout

\begin_layout Quotation
\begin_inset VSpace defskip
\end_inset


\end_layout

\begin_layout Subsubsection
Grype
\end_layout

\begin_layout Standard
TBD.
\end_layout

\begin_layout Section
Respecting Your User's Privacy and Confidentiality
\end_layout

\begin_layout Standard
A snapshot is a record of the state of the system as it was at some time in the past.
 If you administer shared systems where users have their own home directories (or other locations for storing data) you should bear in mind that sometimes users delete files 
\begin_inset Flex Emph
status open

\begin_layout Plain Layout
because they wanted them gone
\end_layout

\end_inset

.
 The hastily drafted email written in anger and deleted before hitting send.
 The embarrassing misunderstanding quickly erased from an important presentation before anyone saw it.
\end_layout

\begin_layout Standard
If you place your user's content under preservation using snapshots it is important that they be aware,
 and know how to request that certain content be removed.
 Of course,
 nobody reading this book would even dream of using their administrative powers to spy on their users or abuse their right to privacy:
 that's just nasty.
\end_layout

\begin_layout Standard
We recommend clearly announcing any data retention policies that may apply to the systems you rum prominently when they are required for organisational,
 technical,
 legal,
 or bureaucratic reasons.
 The standard 
\begin_inset Flex Code
status open

\begin_layout Plain Layout
motd(5)
\end_layout

\end_inset

 and 
\begin_inset Flex Code
status open

\begin_layout Plain Layout
issue(5)
\end_layout

\end_inset

 files provide login and pre-login messages that can be used for this purpose.
 Or you can add it to your on-boarding training.
\end_layout

\begin_layout Section
Purging Unwanted Content From Snapshots
\end_layout

\begin_layout Standard
Unwanted files and directories can be removed from snapshots by mounting the snapshot set on the host system and using the standard 
\begin_inset Flex Code
status open

\begin_layout Plain Layout
rm(1)
\end_layout

\end_inset

 and 
\begin_inset Flex Code
status open

\begin_layout Plain Layout
rmdir(1)
\end_layout

\end_inset

 commands to delete the desired paths.
 Refer to The Mount Manager (
\begin_inset CommandInset ref
LatexCommand ref
reference "chap:The-Mount-Manager"
plural "false"
caps "false"
noprefix "false"
nolink "false"

\end_inset

) for detailed steps to mount and unmount snapshot sets:
 once the snapshot set is mounted simply prefix the required path with the snapshot set mount path (
\begin_inset Flex Code
status open

\begin_layout Plain Layout
/run/snapm/mounts/<name>
\end_layout

\end_inset

) to direct the tools to the snapshot content.
\end_layout

\begin_layout Standard
Further reassurances may be gained in some cases by using tools like 
\begin_inset Flex Code
status open

\begin_layout Plain Layout
shred(1)
\end_layout

\end_inset

,
 but continue to the next subsection to understand some of the limitations of this tool when used with modern storage devices and file systems and to learn about possible alternatives.
\end_layout

\begin_layout Subsection
On the Usefulness of 
\begin_inset Quotes bld
\end_inset


\begin_inset Flex Code
status open

\begin_layout Plain Layout
shred
\end_layout

\end_inset


\begin_inset Quotes brd
\end_inset


\end_layout

\begin_layout Standard
The 
\begin_inset Flex Code
status open

\begin_layout Plain Layout
shred
\end_layout

\end_inset

 utility is still useful,
 but its effectiveness depends heavily on the type of storage media and file system being used.
 It is generally effective for traditional magnetic hard disk drives (HDDs) and old file systems,
 but largely ineffective for modern Solid-State Drives (SSDs) and certain advanced file systems.
 
\end_layout

\begin_layout Subsubsection
Where 
\begin_inset Flex Code
status open

\begin_layout Plain Layout
shred
\end_layout

\end_inset

 is Effective
\end_layout

\begin_layout Standard
The shred utility works by repeatedly overwriting a file's data in place with random patterns to make the original content unrecoverable through forensic software.
 
\end_layout

\begin_layout Itemize
Traditional HDDs:
 On older,
 traditional hard drives,
 where data is physically overwritten in a fixed location,
 a single or multiple passes of shred are sufficient to securely erase data beyond typical recovery methods.
\end_layout

\begin_layout Itemize
Wiping entire devices/partitions (with caveats):
 shred can be used on entire block devices (e.g.,
 /dev/sda1).
 While this overcomes some file system limitations,
 it still isn't foolproof for SSDs due to how they manage data.
\end_layout

\begin_layout Subsubsection
Where 
\begin_inset Flex Code
status open

\begin_layout Plain Layout
shred
\end_layout

\end_inset

 is Not Effective
\end_layout

\begin_layout Standard
The primary limitation of shred is its reliance on the assumption that data is overwritten in the exact same physical location,
 which is often not true for modern storage technology.
\end_layout

\begin_layout Itemize
Solid-State Drives (SSDs):
 shred is generally not recommended for SSDs.
 SSDs use wear-leveling algorithms and over-provisioning,
 which means the data may be written to a different physical location each time,
 leaving the original data intact on unallocated blocks that shred cannot access.
 Repeatedly using shred on an SSD can also reduce its lifespan due to excessive write cycles.
\end_layout

\begin_layout Itemize
Journaled and CoW File Systems:
 Modern file systems like Ext3 (in 
\begin_inset Flex Code
status open

\begin_layout Plain Layout
data=journal
\end_layout

\end_inset

 mode),
 Ext4,
 Btrfs,
 XFS,
 and NTFS often write new data to new locations (journaling or copy-on-write) instead of overwriting in place.
\end_layout

\begin_layout Itemize
RAID Systems and Caching:
 Systems that use data redundancy,
 or temporary caching may retain copies of sensitive data outside of the file you are attempting to shred.
\end_layout

\begin_layout Subsubsection
Better Alternatives for Modern Storage
\end_layout

\begin_layout Standard
For modern storage devices,
 other methods are more reliable for secure data erasure:
\end_layout

\begin_layout Itemize
For SSDs:
 Use the drive's builtin ATA secure erase command (often accessed via utilities like 
\begin_inset Flex Code
status open

\begin_layout Plain Layout
hdparm(8)
\end_layout

\end_inset

 or through bootable tools like 
\begin_inset Flex Emph
status open

\begin_layout Plain Layout
ShredOS
\end_layout

\end_inset

).
 This command communicates directly with the drive's firmware to erase all memory cells effectively (hopefully
\begin_inset Foot
status open

\begin_layout Plain Layout
Firmware,
 alas,
 cannot always be relied upon to Do The Right Thing.
 Consult the internet and your hardware vendor's data sheets and errata for up-to-date information.
\end_layout

\end_inset

) and (hopefully) quickly.
\end_layout

\begin_layout Itemize
For Wiping Entire Disks (Bootable Solutions):
 For securely wiping entire drives before disposal or sale,
 bootable solutions like 
\begin_inset Flex Emph
status open

\begin_layout Plain Layout
DBAN
\end_layout

\end_inset

 (for older HDDs) or 
\begin_inset Flex Emph
status open

\begin_layout Plain Layout
ShredOS
\end_layout

\end_inset

 (which supports modern SSDs) are often recommended.
\end_layout

\begin_layout Standard
Note that these methods typically apply to whole devices and are not applicable in the snapshot use case.
 The 
\begin_inset Flex Code
status open

\begin_layout Plain Layout
fstrim(8)
\end_layout

\end_inset

 command may provide some assistance by instructing the underlying storage to release or erase blocks that were previously in use by the file system but note that implementations vary from device-to-device and trim by itself does not guarantee secure erasure in any circumstances.
\end_layout

\begin_layout Section
Purging Unwanted Volumes With 
\begin_inset Flex Code
status open

\begin_layout Plain Layout
snapset prune
\end_layout

\end_inset


\end_layout

\begin_layout Chapter
Configuration
\end_layout

\begin_layout Quotation
\begin_inset Quotes bld
\end_inset

We will find it!
 We will bind it!
 We will stick it with glue,
 glue,
 glue!
\begin_inset Quotes brd
\end_inset

 —
 The Bagpuss Mice,
 The Mending Song,
 1974.
\end_layout

\begin_layout Standard
The general approach in 
\begin_inset Flex Code
status open

\begin_layout Plain Layout
snapm
\end_layout

\end_inset

 to configuration is to require as little of it as possible:
 the defaults should be adequate for most use cases.
 This chapter explains the configuration files and directories that 
\begin_inset Flex Code
status open

\begin_layout Plain Layout
snapm
\end_layout

\end_inset

 consults and how to tune them for your environment if necessary.
\end_layout

\begin_layout Section
\begin_inset Flex Code
status open

\begin_layout Plain Layout
snapm.conf
\end_layout

\end_inset


\end_layout

\begin_layout Section
\begin_inset CommandInset label
LatexCommand label
name "sec:conf-plugins.d"

\end_inset


\begin_inset Flex Code
status open

\begin_layout Plain Layout
plugins.d
\end_layout

\end_inset


\end_layout

\begin_layout Section
\begin_inset Flex Code
status open

\begin_layout Plain Layout
schedule.d
\end_layout

\end_inset


\end_layout

\begin_layout Section
Tuning 
\begin_inset Flex Code
status open

\begin_layout Plain Layout
snapm
\end_layout

\end_inset

 For Your Environment.
\end_layout

\begin_layout Subsection
Disabling Plugins
\end_layout

\begin_layout Subsection
Adjusting Plugin Limits
\end_layout

\begin_layout Subsection
Adjusting Plugin Priorities
\end_layout

\begin_layout Standard
\begin_inset ERT
status open

\begin_layout Plain Layout


\backslash
setcounter{chapter}{23}
\end_layout

\end_inset


\end_layout

\begin_layout Chapter
What Snapm Doesn't Cover (And What To Do About It)
\end_layout

\begin_layout Quotation
\begin_inset Quotes bld
\end_inset


\nospellcheck on
Nie
\nospellcheck default
 
\nospellcheck on
mój
\nospellcheck default
 
\nospellcheck on
cyrk
\nospellcheck default
,
 
\nospellcheck on
nie
\nospellcheck default
 
\nospellcheck on
moje
\nospellcheck default
 
\nospellcheck on
małpy
\nospellcheck default

\begin_inset Quotes brd
\end_inset

 (
\begin_inset Quotes bld
\end_inset

Not my circus,
 not my monkeys
\begin_inset Quotes brd
\end_inset

) —
 Polish proverb
\end_layout

\begin_layout Section
The 
\begin_inset Flex Code
status open

\begin_layout Plain Layout
/boot
\end_layout

\end_inset

 file system
\end_layout

\begin_layout Standard
The 
\begin_inset Flex Code
status open

\begin_layout Plain Layout
/boot
\end_layout

\end_inset

 file system does not typically support snapshots (until we have 
\nospellcheck on
boot-on-btrfs
\nospellcheck default
 - currently in Fedora Rawhide - and the Btrfs plugin).
 For everything else 
\begin_inset Flex Code
status open

\begin_layout Plain Layout
boom
\end_layout

\end_inset

 
\begin_inset Flex Code
status open

\begin_layout Plain Layout
--backup
\end_layout

\end_inset

 which 
\begin_inset Flex Code
status open

\begin_layout Plain Layout
snapm
\end_layout

\end_inset

 uses under the hood gives a measure of protection by transparently backing up critical boot images.
\end_layout

\begin_layout Section
The uEFI ESP
\end_layout

\begin_layout Standard
The uEFI ESP (EFI System Partition) must be VFAT,
 and cannot be snapshotted.
 We have a proposal to add rescue image support to 
\begin_inset Flex Code
status open

\begin_layout Plain Layout
boom
\end_layout

\end_inset

 to cover this:
 see the issue 
\begin_inset Quotes eld
\end_inset

boom:
 investigate feasibility of a 
\nospellcheck on
'boot
\nospellcheck default
 
\nospellcheck on
clone'
\nospellcheck default
 mechanism (boom boot [clone|move],
 boom rescue create?)
\begin_inset Quotes erd
\end_inset

 for more information:
 
\begin_inset Flex URL
status open

\begin_layout Plain Layout

https://github.com/snapshotmanager/boom-boot/issues/385
\end_layout

\end_inset


\end_layout

\begin_layout Section
Firmware Configuration and Settings
\end_layout

\begin_layout Standard
These are out of scope for a storage based snapshot tool:
 consult your hardware vendor for advice on backing up and restoring these critical parameters.
\end_layout

\begin_layout Section
Other Non-Snapshottable Mount Points
\end_layout

\begin_layout Subsection
API and Runtime File Systems
\end_layout

\begin_layout Standard
The Linux kernel provides various virtual,
 in-memory file systems that provide an interface to the kernel.
 In addition,
 there are various runtime state directories that are typically not backed by persistent storage.
\end_layout

\begin_layout Itemize
The 
\begin_inset Flex Code
status open

\begin_layout Plain Layout
/proc
\end_layout

\end_inset

 and 
\begin_inset Flex Code
status open

\begin_layout Plain Layout
/sys
\end_layout

\end_inset

 file systems (and their related submounts) are virtual file systems provided by the kernel and do not support snapshotting.
 We are working on a solution to this leveraging the 
\begin_inset Flex Code
status open

\begin_layout Plain Layout
sos(1)
\end_layout

\end_inset

 program.
 See Chapter 
\begin_inset CommandInset ref
LatexCommand ref
reference "chap:Future-Plans"
plural "false"
caps "false"
noprefix "false"
nolink "false"

\end_inset

 for further information.
\end_layout

\begin_layout Itemize
The 
\begin_inset Flex Code
status open

\begin_layout Plain Layout
/dev
\end_layout

\end_inset

,
 and 
\begin_inset Flex Code
status open

\begin_layout Plain Layout
/run
\end_layout

\end_inset

 file systems are typically backed by 
\begin_inset Flex Code
status open

\begin_layout Plain Layout
tmpfs(5)
\end_layout

\end_inset

 instances on modern Linux systems.
 These also do not support snapshots.
 Note that today,
 
\begin_inset Flex Code
status open

\begin_layout Plain Layout
/var/run
\end_layout

\end_inset

 is by convention a symbolic link pointing to 
\begin_inset Flex Code
status open

\begin_layout Plain Layout
/run
\end_layout

\end_inset

and hence the same restrictions apply.
\end_layout

\begin_layout Subsection
Partitions,
 Loop Devices,
 and Everything Else
\end_layout

\begin_layout Standard
Conventional partitions do not support snapshots at the block device level.
 A snapshot-capable file system such as Btrfs or bcachefs is required in these situations to realise snapshot capabilities for mount points based on these device types.
 See Chapter 
\begin_inset CommandInset ref
LatexCommand ref
reference "chap:Future-Plans"
plural "false"
caps "false"
noprefix "false"
nolink "false"

\end_inset

 for information on the status of Btrfs support in Snapshot Manager.
\end_layout

\begin_layout Standard
Linux loop devices (
\begin_inset Flex Code
status open

\begin_layout Plain Layout
loop(4)
\end_layout

\end_inset

,
 
\begin_inset Flex Code
status open

\begin_layout Plain Layout
losetup(8)
\end_layout

\end_inset

) also typically do not have the ability to snapshot the content presented on the loop device natively.
 A solution exists for certain file systems (including bcachefs,
 Btrfs,
 CIFS,
 NFS 4.2,
 OCFS2,
 overlayfs,
 and XFS),
 by way of the 
\begin_inset Flex Emph
status open

\begin_layout Plain Layout
reflink
\end_layout

\end_inset

 facility.
 Refer to the 
\begin_inset Flex Code
status open

\begin_layout Plain Layout
cp(1)
\end_layout

\end_inset

 manual page for information on creating reflinks on supported file systems.
\end_layout

\begin_layout Standard
Snapshot Manager does not currently support creating or managing loop device snapshots using reflink.
 See 
\begin_inset Flex URL
status open

\begin_layout Plain Layout

https://github.com/snapshotmanager/snapm/issues/887
\end_layout

\end_inset

 for discussion of whether we should.
\end_layout

\begin_layout Standard
Other block device types such as Amazon EBS,
 Ceph RBD,
 DRBD,
 and external storage arrays using iSCSI,
 Fibre Channel or NVMeOF,
 are not currently supported directly by Snapshot Manager unless they contain a supported LVM2 or Stratis image.
 Support for these devices (where applicable) may be added in a future release.
\end_layout

\begin_layout Part
Scenarios & Recipes
\end_layout

\begin_layout Chapter
Safe System Updates
\end_layout

\begin_layout Quotation
\begin_inset Quotes bld
\end_inset

We fear change.
\begin_inset Quotes brd
\end_inset

 —
 Garth Elgar,
 1992.
\end_layout

\begin_layout Section
Snapshot
\end_layout

\begin_layout Section
Update
\end_layout

\begin_layout Section
Verify
\end_layout

\begin_layout Section
(Optionally) Snapshot Again
\end_layout

\begin_layout Section
Commit or Revert
\end_layout

\begin_layout Chapter
Scheduled Snapshots for Recovery
\end_layout

\begin_layout Quotation
\begin_inset Quotes bld
\end_inset

Wait,
 wait,
 wait.
 I had something for this!
\begin_inset Quotes brd
\end_inset

 —
 Sterling Archer,
 1970,000.
\begin_inset VSpace defskip
\end_inset


\end_layout

\begin_layout Section
Protecting Against "Oops"
\end_layout

\begin_layout Section
Rolling Recovery Windows
\end_layout

\begin_layout Section
Hourly,
 Daily,
 Weekly Retention Strategies
\end_layout

\begin_layout Chapter
\begin_inset Quotes eld
\end_inset

I Didn't Mean To!
\begin_inset Quotes erd
\end_inset

:
 Recovering Files and Directories
\end_layout

\begin_layout Quotation
\begin_inset Quotes bld
\end_inset

In the ohnosecond (one minuscule fraction of a nanosecond,
 the time it takes to 
\nospellcheck on
realize
\nospellcheck default
 you just made a BIG mistake) that followed,
 I 
\nospellcheck on
realized
\nospellcheck default
 my log of the conversation was lost.
\begin_inset Quotes brd
\end_inset

 —
 Elizabeth Powell Crowe,
 The Electronic 
\lang czech
Traveller
\lang british
:
 Exploring Alternative Online Systems,
 1994.
\end_layout

\begin_layout Section
Partial Recovery:
 Copying Specific Files Back to the System
\end_layout

\begin_layout Section
Partial Merge:
 Using 
\begin_inset Flex Code
status open

\begin_layout Plain Layout
split
\end_layout

\end_inset

 and 
\begin_inset Flex Code
status open

\begin_layout Plain Layout
prune
\end_layout

\end_inset

 to Adjust Revert Granularity
\end_layout

\begin_layout Chapter
Understanding What Changed
\end_layout

\begin_layout Quotation
\begin_inset Quotes bld
\end_inset

No matter how far you have gone on the wrong road,
 turn back.
\begin_inset Quotes brd
\end_inset

 —
 Turkish proverb
\end_layout

\begin_layout Section
Visualising Changes
\end_layout

\begin_layout Section
Using the Difference Engine to Audit Updates
\end_layout

\begin_layout Section
Tracking Configuration Drift
\end_layout

\begin_layout Section
Deployment Verification
\end_layout

\begin_layout Chapter
When Things Go Wrong
\end_layout

\begin_layout Quotation
\begin_inset Quotes bld
\end_inset

It was New Year's day a year ago,
 the sky was black then blue.
\begin_inset Quotes brd
\end_inset

 —
 King Boy D,
 1988.
\end_layout

\begin_layout Standard
Recovery scenarios:
 main system won't boot,
 partial recovery,
 invalidated snapshot sets,
 interrupted reverts,
 rescuing files from snapshots.
\end_layout

\begin_layout Section
Booting Into a Snapshot Set For investigation
\end_layout

\begin_layout Standard
Using the Snapshot Boot Entry Without Reverting.
\end_layout

\begin_layout Section
System Won't Boot After Update
\end_layout

\begin_layout Standard
Using the Snapshot and Fail-safe Revert Entries to Roll Back.
\end_layout

\begin_layout Section
Recovering From an Interrupted Revert
\end_layout

\begin_layout Standard
Under normal circumstances an interrupted revert should not pose problems:
 the LVM2 CoW and thin (LVM2 and Stratis) implementations are somewhat different but are robust and should yield the same consistent behaviour under most conditions outside catastrophic storage failure (for example,
 storage that loses writes that have already been acknowledged to the operating system).
\end_layout

\begin_layout Itemize
CoW merging involves actual data relocation:
 the exceptions from the snapshot exception store are physically copied back to their original locations on the media.
 This takes place under the direction of the 
\begin_inset Flex Code
status open

\begin_layout Plain Layout
dm-snapshot-merge
\end_layout

\end_inset

 target.
 The operation is check pointed in the LVM metadata and will resume from where it left off following a power failure or unclean shutdown.
\end_layout

\begin_layout Itemize
Thin merging is relatively atomic,
 requiring only an update to the 
\begin_inset Flex Emph
status open

\begin_layout Plain Layout
thin ID
\end_layout

\end_inset

 stored in the device metadata.
 This applies to both LVM2 thin volumes and Stratis file systems.
\end_layout

\begin_layout Standard
If you encounter difficulty activating or accessing volumes following an interrupted revert or merge operation seek support from your software vendor,
 or the LVM2 or Stratis mailing lists,
 IRC channels etc.
 You are also welcome to file an issue in the Snapshot Manager GitHub repository:
 while these operations are entirely the domain of the underlying storage stack we would still be interested to hear of any issues encountered in their use.
 See 
\begin_inset CommandInset ref
LatexCommand ref
reference "chap:I-Found-A"
plural "false"
caps "false"
noprefix "false"
nolink "false"

\end_inset

 for suggested information to include in problem reports.
\end_layout

\begin_layout Section
Rescuing Files From an Invalid Snapset
\end_layout

\begin_layout Standard
When Snapshots are Damaged But Partially Readable.
\end_layout

\begin_layout Section
When to Revert vs.
 When to Recover Files
\end_layout

\begin_layout Standard
Choosing the Right Approach for the Situation.
\end_layout

\begin_layout Subsection
I Broke It vs.
 An Update Broke It
\end_layout

\begin_layout Subsection
Configuration vs.
 Software
\end_layout

\begin_layout Subsection
Root Cause Analysis
\end_layout

\begin_layout Chapter
When Brown Stuff Meets Twirly Thing
\begin_inset Foot
status open

\begin_layout Plain Layout
This phrase is attributed to Alan Cox,
 former legendary Linux kernel hacker,
 in a discussion from the mid-2000s on the dangers of allowing proprietary GPU drivers access to DMA.
 In this analogy,
 the brown stuff is your data,
 and the twirly thing is the mis-programmed DMA engine that merrily sprays it all about your vmcore.
\end_layout

\end_inset


\end_layout

\begin_layout Quotation
\begin_inset Quotes bld
\end_inset

Three days later,
 they dug me out.
 I never saw Arthur again,
 but I'll bet,
 wherever he's gone,
 he's having a damned good time.
\begin_inset Quotes brd
\end_inset

 —
 Unnamed Miner,
 
\begin_inset Quotes bld
\end_inset

Since I Left You
\begin_inset Quotes brd
\end_inset

 music video,
 The Avalanches / Rob Leggatt and Leigh Marling,
 2000.
\end_layout

\begin_layout Standard
Panics,
 exceptions,
 
\begin_inset Quotes bld
\end_inset

won't boot at all
\begin_inset Quotes brd
\end_inset

 and all the other Great And Terrible Things encountered in real life system administration.
\end_layout

\begin_layout Standard
First of all,
 in the words of the prophet Douglas Adams:
\end_layout

\begin_layout Quotation
\begin_inset VSpace defskip
\end_inset


\end_layout

\begin_layout Standard
\align center
\begin_inset Flex Emph
status open

\begin_layout Plain Layout
\begin_inset Flex Strong
status open

\begin_layout Plain Layout
DON'T PANIC.
\end_layout

\end_inset


\end_layout

\end_inset


\end_layout

\begin_layout Quotation
\begin_inset VSpace defskip
\end_inset


\end_layout

\begin_layout Section
Common Problems and Solutions.
\end_layout

\begin_layout Section
Debugging Techniques
\end_layout

\begin_layout Section
Log Analysis
\end_layout

\begin_layout Section

\nospellcheck on
Provider-specific
\nospellcheck default
 Issues.
\end_layout

\begin_layout Chapter
Postmortem,
 Forensics,
 and Recovery
\end_layout

\begin_layout Quotation
\begin_inset Quotes bld
\end_inset

Futility.
 That there's a time when you should just give up.
 
\begin_inset Quotes brd
\end_inset

 —
 Stephen Falken,
 
\begin_inset Quotes bld
\end_inset

WarGames
\begin_inset Quotes brd
\end_inset

,
 by John Badham,
 1983.
\end_layout

\begin_layout Section
Using 
\begin_inset Flex Code
status open

\begin_layout Plain Layout
snapm
\end_layout

\end_inset

 in Emergency and Rescue Mode
\end_layout

\begin_layout Standard
Mostly this should 
\begin_inset Quotes bld
\end_inset

just work
\begin_inset Quotes brd
\end_inset

 as long as you can access the systemd 
\begin_inset Flex Code
status open

\begin_layout Plain Layout
emergency.target
\end_layout

\end_inset

 or 
\begin_inset Flex Code
status open

\begin_layout Plain Layout
rescue.target
\end_layout

\end_inset

 environment in the main root file system;
 if you run into problems please let us know via a GitHub issue.
\end_layout

\begin_layout Standard
If you are only able to boot into an 
\begin_inset Flex Emph
status open

\begin_layout Plain Layout
initramfs
\end_layout

\end_inset

 recovery environment (for example,
 
\begin_inset Flex Code
status open

\begin_layout Plain Layout
dracut(8)
\end_layout

\end_inset

 dropping to the debug shell due to a boot failure,
 or explicit 
\begin_inset Flex Code
status open

\begin_layout Plain Layout
rd.shell
\end_layout

\end_inset

 argument) then you are out of luck since most 
\begin_inset Flex Code
status open

\begin_layout Plain Layout
initramfs
\end_layout

\end_inset

 generators do not include a Python runtime,
 and none of them include 
\begin_inset Flex Code
status open

\begin_layout Plain Layout
snapm
\end_layout

\end_inset

,
 
\begin_inset Flex Code
status open

\begin_layout Plain Layout
boom
\end_layout

\end_inset

,
 or their dependencies.
 If you find yourself in this situation you have our sympathy:
 we've been there.
 Read the following sections to learn how to operate 
\begin_inset Flex Code
status open

\begin_layout Plain Layout
snapm
\end_layout

\end_inset

 in a suitable recovery environment.
\end_layout

\begin_layout Subsection
Recovery and Donor Environments:
 General Principals
\end_layout

\begin_layout Standard
There are three basic steps whether you want to use 
\begin_inset Flex Code
status open

\begin_layout Plain Layout
snapm
\end_layout

\end_inset

 on a donor system,
 in a rescue environment,
 from rescue media
\end_layout

\begin_layout Enumerate
Activate devices
\end_layout

\begin_layout Enumerate
Prepare a 
\begin_inset Flex Code
status open

\begin_layout Plain Layout
chroot
\end_layout

\end_inset

 environment
\end_layout

\begin_layout Enumerate
Enter the chroot and run the required commands
\end_layout

\begin_layout Subsection
Activating Snapshot Sets
\end_layout

\begin_layout Itemize
\begin_inset Flex Code
status open

\begin_layout Plain Layout
vgchange(8)
\end_layout

\end_inset

 and 
\begin_inset Flex Code
status open

\begin_layout Plain Layout
lvchange(8)
\end_layout

\end_inset


\end_layout

\begin_layout Itemize
\begin_inset Flex Code
status open

\begin_layout Plain Layout
stratis pool start
\end_layout

\end_inset


\end_layout

\begin_layout Subsection
Preparing a 
\begin_inset Flex Code
status open

\begin_layout Plain Layout
chroot
\end_layout

\end_inset

 Environment
\end_layout

\begin_layout Subsubsection
Making a 
\begin_inset Flex Code
status open

\begin_layout Plain Layout
chroot
\end_layout

\end_inset

 directory
\end_layout

\begin_layout Subsubsection
Mounting the root file system
\end_layout

\begin_layout Subsubsection
Mounting auxiliary file systems
\end_layout

\begin_layout Subsubsection
Bind mounting API and runtime file systems
\end_layout

\begin_layout Subsection
Running 
\begin_inset Flex Code
status open

\begin_layout Plain Layout
snapm
\end_layout

\end_inset

 Within The 
\begin_inset Flex Code
status open

\begin_layout Plain Layout
chroot
\end_layout

\end_inset


\end_layout

\begin_layout Section
Accessing Snapshot Sets from Donor or Rescue Systems
\end_layout

\begin_layout Standard
Read-Only Access to Snapshot Sets
\end_layout

\begin_layout Standard
Snapshot Manager does not currently support creating or mounting snapshot sets in read only state.
 There is an active RFE to add this support:
\end_layout

\begin_layout Standard
\begin_inset Flex URL
status open

\begin_layout Plain Layout

https://github.com/snapshotmanager/snapm/issues/888
\end_layout

\end_inset


\end_layout

\begin_layout Section
Using 
\begin_inset Flex Code
status open

\begin_layout Plain Layout
snapm
\end_layout

\end_inset

 From Recovery Media
\end_layout

\begin_layout Standard
Anaconda rescue,
 SystemRescue,
 Knoppix etc.
\end_layout

\begin_layout Section
Using The Difference Engine for Forensic Analysis
\end_layout

\begin_layout Itemize
Future 
\begin_inset Flex Code
status open

\begin_layout Plain Layout
BinaryContentDiffer
\end_layout

\end_inset

 extension (
\begin_inset Flex Code
status open

\begin_layout Plain Layout
hexdump(1)
\end_layout

\end_inset

/
\begin_inset Flex Code
status open

\begin_layout Plain Layout
xxd(1)
\end_layout

\end_inset

 style diffs)
\end_layout

\begin_layout Chapter
War Stories
\end_layout

\begin_layout Quotation
\begin_inset Quotes bld
\end_inset

So it goes.
\begin_inset Quotes brd
\end_inset

 —
 Billy Pilgrim,
 
\begin_inset Quotes bld
\end_inset

Slaughterhouse-Five
\begin_inset Quotes brd
\end_inset

,
 by Kurt Vonnegut,
 1969.
\end_layout

\begin_layout Section
That Time I Literally Forgot to Use The Tool I Just Wrote
\end_layout

\begin_layout Chapter
\begin_inset CommandInset label
LatexCommand label
name "chap:I-Found-A"

\end_inset

I Found A Bug!
\end_layout

\begin_layout Quotation
\begin_inset Quotes bld
\end_inset

There are two methods in software design.
 One is to make the program so simple,
 there are obviously no errors.
 The other is to make it so complicated,
 there are no obvious errors.
\begin_inset Quotes brd
\end_inset

 —
 The Emperor's Old Clothes,
 C.
 A.
 R.
 Hoare,
 1981.
\end_layout

\begin_layout Section
Information To Collect
\end_layout

\begin_layout Subsection
An 
\begin_inset Flex Code
status open

\begin_layout Plain Layout
sos
\end_layout

\end_inset

 report
\end_layout

\begin_layout Standard
The 
\begin_inset Flex Code
status open

\begin_layout Plain Layout
sos(1)
\end_layout

\end_inset

 program
\begin_inset Foot
status open

\begin_layout Plain Layout
\begin_inset Flex URL
status open

\begin_layout Plain Layout

https://github.com/sosreport/sos
\end_layout

\end_inset


\end_layout

\end_inset

 is a versatile support data collection tool with a wealth of plugins that cover many common problem reporting and debugging scenarios.
 It is normally found in the 
\begin_inset Flex Emph
status open

\begin_layout Plain Layout
sos
\end_layout

\end_inset

 package and can be installed on many distributions (Fedora,
 CentOS,
 Red Hat Enterprise Linux,
 Debian,
 Ubuntu,
 and others).
\end_layout

\begin_layout Standard
The package provides a command,
 
\begin_inset Flex Code
status open

\begin_layout Plain Layout
sos
\end_layout

\end_inset

,
 that accepts a subcommand to tell the program what to do:
 generate a report,
 clean report data (to anonymise,
 obfuscate or redact potentially sensitive details in the report),
 upload report data to a vendor's hosting facilities,
 or collect data from remote hosts in a clustered environment.
\end_layout

\begin_layout Standard
For our purposes the 
\begin_inset Flex Code
status open

\begin_layout Plain Layout
sos report
\end_layout

\end_inset

 command is all that we generally need:
 refer to the excellent and thorough 
\begin_inset Flex Code
status open

\begin_layout Plain Layout
sos(1)
\end_layout

\end_inset

 manual page for details on the other command verbs.
\end_layout

\begin_layout Standard
Running 
\begin_inset Flex Code
status open

\begin_layout Plain Layout
sos report
\end_layout

\end_inset

 will detect the running system distribution,
 set up some defaults,
 and prompt the user for details to customise the report.
 It will then proceed to generate a compressed tarball containing the report data.
 Options exist to further control the data gathered,
 enable or disable specific plugins,
 pass options to plugins and to direct the collection process (for example enabling or disabling 
\begin_inset Flex Emph
status open

\begin_layout Plain Layout
multi-threaded 
\end_layout

\end_inset

collection).
 Refer to the documentation.
\end_layout

\begin_layout Standard
For example:
\begin_inset Newline newline
\end_inset


\end_layout

\begin_layout Standard
\begin_inset Box Frameless
position "t"
hor_pos "c"
has_inner_box 1
inner_pos "t"
use_parbox 0
use_makebox 0
width "100col%"
special "none"
height "1in"
height_special "totalheight"
thickness "0.4pt"
separation "3pt"
shadowsize "4pt"
framecolor "default"
backgroundcolor "none"
status open

\begin_layout Plain Layout
\begin_inset Flex Code
status open

\begin_layout Plain Layout
# sos report
\end_layout

\end_inset


\end_layout

\end_inset


\end_layout

\begin_layout Standard
\begin_inset VSpace defskip
\end_inset

To save time and disk space you can restrict the information gathered using the sos 
\begin_inset Flex Emph
status open

\begin_layout Plain Layout
profile
\end_layout

\end_inset

 mechanism.
 This pre-selects a subset of the available plugins tailored to debugging certain categories of problems.
 For problems with Snapshot Manager the 
\begin_inset Flex Emph
status open

\begin_layout Plain Layout
storage
\end_layout

\end_inset

,
 
\begin_inset Flex Emph
status open

\begin_layout Plain Layout
boot
\end_layout

\end_inset

,
 and 
\begin_inset Flex Emph
status open

\begin_layout Plain Layout
kernel
\end_layout

\end_inset

 profiles:
\begin_inset Newline newline
\end_inset


\end_layout

\begin_layout Standard
\begin_inset Box Frameless
position "t"
hor_pos "c"
has_inner_box 1
inner_pos "t"
use_parbox 0
use_makebox 0
width "100col%"
special "none"
height "1in"
height_special "totalheight"
thickness "0.4pt"
separation "3pt"
shadowsize "4pt"
framecolor "default"
backgroundcolor "none"
status open

\begin_layout Plain Layout
\begin_inset Flex Code
status open

\begin_layout Plain Layout
# sos report --profile boot,kernel,storage
\end_layout

\end_inset


\end_layout

\end_inset


\end_layout

\begin_layout Quotation
\begin_inset VSpace defskip
\end_inset


\end_layout

\begin_layout Standard
On the author's test machine this results in a tarball that is half the size of that generated by the default options,
 and the command completes in a little over half the time.
\end_layout

\begin_layout Standard
You can attach the generated report to your issue,
 or send it to the maintainers privately (for example,
 by email) if you prefer to keep it confidential.
 The project will not share or redistribute information received in this way.
\end_layout

\begin_layout Subsection
An 
\begin_inset Flex Code
status open

\begin_layout Plain Layout
lvmdump
\end_layout

\end_inset

 (if using the LVM2 plugins)
\end_layout

\begin_layout Standard
The LVM2 package provides a debugging script,
 
\begin_inset Flex Code
status open

\begin_layout Plain Layout
lvmdump(8)
\end_layout

\end_inset

 that is a bit like a mini-sos report,
 specific to the Logical Volume Manager subsystem.
 The easiest way to gather one is to include it in your sos report:
\begin_inset Newline newline
\end_inset


\end_layout

\begin_layout Standard
\begin_inset Box Frameless
position "t"
hor_pos "c"
has_inner_box 1
inner_pos "t"
use_parbox 0
use_makebox 0
width "100col%"
special "none"
height "1in"
height_special "totalheight"
thickness "0.4pt"
separation "3pt"
shadowsize "4pt"
framecolor "default"
backgroundcolor "none"
status open

\begin_layout Plain Layout
\begin_inset Flex Code
status open

\begin_layout Plain Layout
# sos report -k lvm2.lvmdump
\end_layout

\end_inset


\end_layout

\end_inset


\end_layout

\begin_layout Standard
\begin_inset VSpace defskip
\end_inset

Or,
 to also attempt to collect metadata dumps (in case things are very badly out of shape):
\begin_inset Newline newline
\end_inset


\end_layout

\begin_layout Standard
\begin_inset Box Frameless
position "t"
hor_pos "c"
has_inner_box 1
inner_pos "t"
use_parbox 0
use_makebox 0
width "100col%"
special "none"
height "1in"
height_special "totalheight"
thickness "0.4pt"
separation "3pt"
shadowsize "4pt"
framecolor "default"
backgroundcolor "none"
status open

\begin_layout Plain Layout
\begin_inset Flex Code
status open

\begin_layout Plain Layout
# sos report -k lvm2.lvmdump-am
\end_layout

\end_inset


\end_layout

\end_inset


\end_layout

\begin_layout Quotation
\begin_inset VSpace defskip
\end_inset


\end_layout

\begin_layout Subsection
Stratis reports (if using the Stratis plugin)
\end_layout

\begin_layout Standard
The 
\begin_inset Flex Code
status open

\begin_layout Plain Layout
stratis
\end_layout

\end_inset

 CLI command supports a set of 
\begin_inset Flex Emph
status open

\begin_layout Plain Layout
reports 
\end_layout

\end_inset

that contain information that may be of use in debugging.
 Running the commands will generate a JSON object containing the requested information.
 For example,
 to generate the 
\begin_inset Flex Code
status open

\begin_layout Plain Layout
engine_state_report
\end_layout

\end_inset

 you can run:
\begin_inset Newline newline
\end_inset


\end_layout

\begin_layout Standard
\begin_inset Box Frameless
position "t"
hor_pos "c"
has_inner_box 1
inner_pos "t"
use_parbox 0
use_makebox 0
width "100col%"
special "none"
height "1in"
height_special "totalheight"
thickness "0.4pt"
separation "3pt"
shadowsize "4pt"
framecolor "default"
backgroundcolor "none"
status open

\begin_layout Plain Layout
\begin_inset Flex Code
status open

\begin_layout Plain Layout
# stratis report engine_state_report
\end_layout

\end_inset


\end_layout

\end_inset


\end_layout

\begin_layout Standard
\begin_inset VSpace defskip
\end_inset

See 
\begin_inset Flex Code
status open

\begin_layout Plain Layout
stratis report –-help
\end_layout

\end_inset

 for information on the available reports.
\end_layout

\begin_layout Standard
The simplest way to obtain this information (and more) is to generate an 
\begin_inset Flex Code
status open

\begin_layout Plain Layout
sos
\end_layout

\end_inset

 report:
 the 
\begin_inset Flex Code
status open

\begin_layout Plain Layout
stratis
\end_layout

\end_inset

 plugin (enabled by default and as part of the 
\begin_inset Flex Emph
status open

\begin_layout Plain Layout
storage
\end_layout

\end_inset

 profile) supports these reports and collects other details that are of use in debugging Stratis deployments.
\end_layout

\begin_layout Section
Filing Issues
\end_layout

\begin_layout Standard
Issues for the Snapshot Manager upstream project should be filed at:
\begin_inset Newline newline
\end_inset


\begin_inset Flex URL
status open

\begin_layout Plain Layout

https://github.com/snapshotmanager/snapm/issues/new
\end_layout

\end_inset


\begin_inset Newline newline
\end_inset

The project does not have a specific issue template (since issues are used for tracking bugs,
 feature requests,
 development tasks,
 releases and other activities) but it is helpful to include the following information in problem reports:
\end_layout

\begin_layout Enumerate
A description of the problem:
 what happened,
 what you expected to happen,
 any errors you received.
\end_layout

\begin_layout Enumerate
The exact command line that you ran when you encountered the problem,
 along with any output that was produced
\end_layout

\begin_layout Enumerate
A brief description of your system and storage configuration,
 optionally with an 
\begin_inset Flex Code
status open

\begin_layout Plain Layout
sos
\end_layout

\end_inset

 report or other debugging data.
\end_layout

\begin_layout Enumerate
If possible,
 the output of the same command run with the global options 
\begin_inset Quotes bld
\end_inset


\begin_inset Flex Code
status open

\begin_layout Plain Layout
-vv
\end_layout

\end_inset

` and `
\begin_inset Flex Code
status open

\begin_layout Plain Layout
–-debug=all
\end_layout

\end_inset

` (for example,
 
\begin_inset Quotes bld
\end_inset


\begin_inset Flex Code
status open

\begin_layout Plain Layout
snapm -vv –-debug=all snapset list
\end_layout

\end_inset

`).
 This will produce considerably more output but may provide key insight to the developers.
\end_layout

\begin_layout Enumerate
If you label your issue with the 
\begin_inset Quotes bld
\end_inset

bug
\begin_inset Quotes brd
\end_inset

 label and set the issue type to 
\begin_inset Quotes bld
\end_inset

Bug
\begin_inset Quotes brd
\end_inset

 it will help the developers to triage the report and respond to you quickly.
\end_layout

\begin_layout Section
Suggesting Patches
\end_layout

\begin_layout Standard
If you have a suggestion on fixing the problem,
 or a patch that you have tested locally you are welcome to either file a formal 
\begin_inset Flex Emph
status open

\begin_layout Plain Layout
pull request
\end_layout

\end_inset

 on GitHub,
 or paste or attach the patch or a summary of the changes along with your issue.
 We welcome all contributions and will review and help to refine any proposed fixes.
\end_layout

\begin_layout Standard
For more information on working on 
\begin_inset Flex Code
status open

\begin_layout Plain Layout
snapm
\end_layout

\end_inset

 and contributing to the project see Chapter 
\begin_inset CommandInset ref
LatexCommand ref
reference "chap:Extending"
plural "false"
caps "false"
noprefix "false"
nolink "false"

\end_inset

 and Chapter 
\begin_inset CommandInset ref
LatexCommand ref
reference "chap:Contributing-to"
plural "false"
caps "false"
noprefix "false"
nolink "false"

\end_inset

.
\end_layout

\begin_layout Part
Advanced Topics
\end_layout

\begin_layout Chapter
The Python API
\end_layout

\begin_layout Quotation
\begin_inset Quotes bld
\end_inset

It 
\nospellcheck on
doesn
\nospellcheck default
’t seem like a dangerous situation,
 it actually looks like a peaceful scene.
 The snake was just making a shadow for him with his hood spread out and he didn't move in as though he was going to bite.
 Not only was the snake not going to harm Nanak,
 he was actually protecting Nanak from the sun.
\begin_inset Quotes brd
\end_inset

 —
 Rai Bular,
 Nanak and the Cobra,
 Ca.
 1474
\end_layout

\begin_layout Standard
Snapshot Manager provides a pair of Python APIs that allow automating and scripting the various facilities.
 There is an easy-to-use procedural API provided in the 
\begin_inset Flex Code
status open

\begin_layout Plain Layout
snapm.command
\end_layout

\end_inset

 module (this is used by the 
\begin_inset Flex Code
status open

\begin_layout Plain Layout
snapm
\end_layout

\end_inset

 CLI),
 and it is also possible to import and use the various classes that make up the public 
\begin_inset Flex Code
status open

\begin_layout Plain Layout
snapm.manager
\end_layout

\end_inset

 and 
\begin_inset Flex Code
status open

\begin_layout Plain Layout
snapm.fsdiff 
\end_layout

\end_inset

interfaces directly in client code.
\end_layout

\begin_layout Section
Programming 
\begin_inset Flex Code
status open

\begin_layout Plain Layout
snapm
\end_layout

\end_inset


\end_layout

\begin_layout Section
The 
\begin_inset Flex Code
status open

\begin_layout Plain Layout
snapm.command
\end_layout

\end_inset

 procedural API
\end_layout

\begin_layout Subsection
Initialising a 
\begin_inset Flex Code
status open

\begin_layout Plain Layout
Manager
\end_layout

\end_inset

 context
\end_layout

\begin_layout Subsection
Snapshot Set Functions
\end_layout

\begin_layout Subsubsection
\begin_inset Flex Code
status open

\begin_layout Plain Layout
create_snapset()
\end_layout

\end_inset


\end_layout

\begin_layout Subsubsection
\begin_inset Flex Code
status open

\begin_layout Plain Layout
delete_snapset()
\end_layout

\end_inset


\end_layout

\begin_layout Subsubsection
\begin_inset Flex Code
status open

\begin_layout Plain Layout
rename_snapset()
\end_layout

\end_inset


\end_layout

\begin_layout Subsubsection
\begin_inset Flex Code
status open

\begin_layout Plain Layout
resize_snapset()
\end_layout

\end_inset


\end_layout

\begin_layout Subsubsection
\begin_inset Flex Code
status open

\begin_layout Plain Layout
revert_snapset()
\end_layout

\end_inset


\end_layout

\begin_layout Subsubsection
\begin_inset Flex Code
status open

\begin_layout Plain Layout
split_snapset()
\end_layout

\end_inset


\end_layout

\begin_layout Subsubsection
\begin_inset Flex Code
status open

\begin_layout Plain Layout
prune_snapset()
\end_layout

\end_inset


\end_layout

\begin_layout Subsubsection
\begin_inset Flex Code
status open

\begin_layout Plain Layout
print_snapsets()
\end_layout

\end_inset


\end_layout

\begin_layout Subsubsection
\begin_inset Flex Code
status open

\begin_layout Plain Layout
diff_snapsets()
\end_layout

\end_inset


\end_layout

\begin_layout Subsection
Snapshot Functions
\end_layout

\begin_layout Subsubsection
\begin_inset Flex Code
status open

\begin_layout Plain Layout
show_snapshots()
\end_layout

\end_inset


\end_layout

\begin_layout Subsubsection
\begin_inset Flex Code
status open

\begin_layout Plain Layout
print_snapshots()
\end_layout

\end_inset


\end_layout

\begin_layout Subsection
Schedule Functions
\end_layout

\begin_layout Subsubsection
\begin_inset Flex Code
status open

\begin_layout Plain Layout
create_schedule()
\end_layout

\end_inset


\end_layout

\begin_layout Subsubsection
\begin_inset Flex Code
status open

\begin_layout Plain Layout
delete_schedule()
\end_layout

\end_inset


\end_layout

\begin_layout Subsubsection
\begin_inset Flex Code
status open

\begin_layout Plain Layout
edit_schedule()
\end_layout

\end_inset


\end_layout

\begin_layout Subsubsection
\begin_inset Flex Code
status open

\begin_layout Plain Layout
enable_schedule()
\end_layout

\end_inset


\end_layout

\begin_layout Subsubsection
\begin_inset Flex Code
status open

\begin_layout Plain Layout
disable_schedule()
\end_layout

\end_inset


\end_layout

\begin_layout Subsubsection
\begin_inset Flex Code
status open

\begin_layout Plain Layout
gc_schedule()
\end_layout

\end_inset


\end_layout

\begin_layout Subsubsection
\begin_inset Flex Code
status open

\begin_layout Plain Layout
print_schedules()
\end_layout

\end_inset


\end_layout

\begin_layout Subsection
Using 
\begin_inset Flex Code
status open

\begin_layout Plain Layout
snapm
\end_layout

\end_inset

 in the Python Shell
\end_layout

\begin_layout Section
Key Classes
\end_layout

\begin_layout Subsection
\begin_inset Flex Code
status open

\begin_layout Plain Layout
Manager
\end_layout

\end_inset


\end_layout

\begin_layout Subsection
\begin_inset Flex Code
status open

\begin_layout Plain Layout
SnapSet
\end_layout

\end_inset


\end_layout

\begin_layout Subsection
\begin_inset Flex Code
status open

\begin_layout Plain Layout
Snapshot
\end_layout

\end_inset


\end_layout

\begin_layout Subsection
\begin_inset Flex Code
status open

\begin_layout Plain Layout
Schedule
\end_layout

\end_inset

,
 
\begin_inset Flex Code
status open

\begin_layout Plain Layout
Scheduler
\end_layout

\end_inset

,
 
\begin_inset Flex Code
status open

\begin_layout Plain Layout
GcPolicy
\end_layout

\end_inset

,
 
\begin_inset Flex Code
status open

\begin_layout Plain Layout
GcPolicyParams*
\end_layout

\end_inset


\end_layout

\begin_layout Subsection
\begin_inset Flex Code
status open

\begin_layout Plain Layout
Mounts
\end_layout

\end_inset

,
 
\begin_inset Flex Code
status open

\begin_layout Plain Layout
Mount
\end_layout

\end_inset


\end_layout

\begin_layout Subsection
\begin_inset Flex Code
status open

\begin_layout Plain Layout
FsDiffer
\end_layout

\end_inset

,
 
\begin_inset Flex Code
status open

\begin_layout Plain Layout
FsDiffResults
\end_layout

\end_inset

,
 
\begin_inset Flex Code
status open

\begin_layout Plain Layout
FsDiffRecord
\end_layout

\end_inset

,
 
\begin_inset Flex Code
status open

\begin_layout Plain Layout
DiffOptions
\end_layout

\end_inset

,
 & friends
\end_layout

\begin_layout Section
Practical Examples
\end_layout

\begin_layout Chapter
Shell Scripting with Snapm
\end_layout

\begin_layout Quotation

\nospellcheck on
\begin_inset Quotes bld
\end_inset

Οἶκος
\nospellcheck default
 
\nospellcheck on
φίλος
\nospellcheck default
,
 
\nospellcheck on
οἶκος
\nospellcheck default
 
\nospellcheck on
ἄριστος
\nospellcheck default

\begin_inset Quotes brd
\end_inset

 (
\begin_inset Quotes bld
\end_inset

The home you love is the best.
\begin_inset Quotes brd
\end_inset

),
 Zeus and the Tortoise,
 Aesop's Fables,
 Ca.
 300 BCE.
\end_layout

\begin_layout Section
Parsing Output - JSON,
 
\begin_inset Flex Code
status open

\begin_layout Plain Layout
–-no-headings
\end_layout

\end_inset

,
 
\begin_inset Flex Code
status open

\begin_layout Plain Layout
--rows
\end_layout

\end_inset


\end_layout

\begin_layout Section
Using 
\begin_inset Flex Code
status open

\begin_layout Plain Layout
paths
\end_layout

\end_inset

 Format in Pipelines
\end_layout

\begin_layout Section
Integration With Other Tools
\end_layout

\begin_layout Section
Automation Recipes
\end_layout

\begin_layout Chapter
Under the Hood
\end_layout

\begin_layout Quotation
\begin_inset Quotes bld
\end_inset

Pay no attention to that man behind the curtain!
\begin_inset Quotes brd
\end_inset

 —
 The Great and Powerful Oz,
 The Wizard of Oz,
 1939.
\end_layout

\begin_layout Standard
HERE FOLLOWS SOME COMPSCI-METAPHYSICS!
 If you're not hot for that,
 best just skip it.
\end_layout

\begin_layout Section
Overview
\end_layout

\begin_layout Standard
This chapter explains the algorithms and internals of the Difference Engine:
 
\begin_inset Formula $O(n)$
\end_inset

 diff generation,
 move detection,
 and tree construction and rendering.
\end_layout

\begin_layout Standard
The Difference Engine is implemented in the 
\begin_inset Flex Code
status open

\begin_layout Plain Layout
snapm.fsdiff
\end_layout

\end_inset

 package and consists of ten Python modules:
\end_layout

\begin_layout Itemize
\begin_inset Flex Code
status open

\begin_layout Plain Layout
cache
\end_layout

\end_inset

 —
 The 
\begin_inset Flex Code
status open

\begin_layout Plain Layout
diffcache
\end_layout

\end_inset

:
 improves performance of consecutive runs with the same targets and options.
\end_layout

\begin_layout Itemize
\begin_inset Flex Code
status open

\begin_layout Plain Layout
changes
\end_layout

\end_inset

 —
 File changes and change detection
\end_layout

\begin_layout Itemize
\begin_inset Flex Code
status open

\begin_layout Plain Layout
contentdiff
\end_layout

\end_inset

 —
 Content diffing for different file types (binary,
 text,
 JSON,
 etc.).
\end_layout

\begin_layout Itemize
\begin_inset Flex Code
status open

\begin_layout Plain Layout
difftypes
\end_layout

\end_inset

 —
 The 
\begin_inset Flex Code
status open

\begin_layout Plain Layout
DiffType
\end_layout

\end_inset

 
\begin_inset Flex Code
status open

\begin_layout Plain Layout
Enum
\end_layout

\end_inset

 class:
 
\begin_inset Flex Code
status open

\begin_layout Plain Layout
ADDED
\end_layout

\end_inset

,
 
\begin_inset Flex Code
status open

\begin_layout Plain Layout
REMOVED
\end_layout

\end_inset

,
 
\begin_inset Flex Code
status open

\begin_layout Plain Layout
MODIFIED
\end_layout

\end_inset

,
 
\begin_inset Flex Code
status open

\begin_layout Plain Layout
MOVED
\end_layout

\end_inset

,
 
\begin_inset Flex Code
status open

\begin_layout Plain Layout
TYPE_CHANGED
\end_layout

\end_inset

.
\end_layout

\begin_layout Itemize
\begin_inset Flex Code
status open

\begin_layout Plain Layout
engine
\end_layout

\end_inset

—
 Implements the core 
\begin_inset Flex Code
status open

\begin_layout Plain Layout
DiffEngine.compute_diff()
\end_layout

\end_inset

 algorithm and hash-based move detection.
\end_layout

\begin_layout Itemize
\begin_inset Flex Code
status open

\begin_layout Plain Layout
filetypes
\end_layout

\end_inset

 —
 Static (path name and file extension based) and dynamic (using 
\begin_inset Flex Code
status open

\begin_layout Plain Layout
libmagic
\end_layout

\end_inset

) file type detection and categorisation.
\end_layout

\begin_layout Itemize
\begin_inset Flex Code
status open

\begin_layout Plain Layout
fsdiffer
\end_layout

\end_inset

 —
 The main interface to the Difference Engine:
 
\begin_inset Flex Code
status open

\begin_layout Plain Layout
FsDiffer.compare_roots()
\end_layout

\end_inset

.
\end_layout

\begin_layout Itemize
\begin_inset Flex Code
status open

\begin_layout Plain Layout
options
\end_layout

\end_inset

 —
 Options to control the comparison process:
 ignore certain change types,
 specify the start path,
 file patterns to include or exclude,
 etc.
\end_layout

\begin_layout Itemize
\begin_inset Flex Code
status open

\begin_layout Plain Layout
tree
\end_layout

\end_inset

 —
 Code for building tree structures from a flat 
\begin_inset Flex Code
status open

\begin_layout Plain Layout
FsDiffResults
\end_layout

\end_inset

 list and rendering the results as an ASCII or Unicode tree visualisation.
\end_layout

\begin_layout Itemize
\begin_inset Flex Code
status open

\begin_layout Plain Layout
treewalk
\end_layout

\end_inset

 —
 The 
\begin_inset Flex Code
status open

\begin_layout Plain Layout
TreeWalker.walk_tree()
\end_layout

\end_inset

 method that generates lists of paths for the Difference Engine to visit.
\end_layout

\begin_layout Standard
This architecture allows 
\begin_inset Flex Code
status open

\begin_layout Plain Layout
snapm
\end_layout

\end_inset

 to compare two file system trees with reasonably good performance and to render the results in a variety of formats that present the underlying difference records in useful ways.
\end_layout

\begin_layout Standard
The performance in any given instance depends on the capabilities of the system and the options given to the difference generating process:
 for example,
 using 
\begin_inset Flex Code
status open

\begin_layout Plain Layout
libmagic
\end_layout

\end_inset

 (via the 
\begin_inset Flex Code
status open

\begin_layout Plain Layout
--file-types
\end_layout

\end_inset

 command line option,
 or the 
\begin_inset Flex Code
status open

\begin_layout Plain Layout
use_magic_file_type
\end_layout

\end_inset

 
\begin_inset Flex Code
status open

\begin_layout Plain Layout
DiffOptions
\end_layout

\end_inset

 attribute) imposes a performance penalty but has the benefit of more accurate file type detection than the builtin path based classification.
 This allows the user to trade runtime for more comprehensive difference information.
\end_layout

\begin_layout Paragraph
Key variables:
\end_layout

\begin_layout Itemize
\begin_inset Flex Code
status open

\begin_layout Plain Layout
tree_a
\end_layout

\end_inset

—
 The first file system tree to compare (the 
\begin_inset Quotes eld
\end_inset

left hand
\begin_inset Quotes erd
\end_inset

 of the comparison).
 A dictionary mapping paths to file system entry objects.
\end_layout

\begin_layout Itemize
\begin_inset Flex Code
status open

\begin_layout Plain Layout
tree_b
\end_layout

\end_inset

 —
 The second file system tree to compare (the 
\begin_inset Quotes eld
\end_inset

right hand
\begin_inset Quotes erd
\end_inset

 of the comparison).
 A dictionary mapping paths to file system entry objects.
\end_layout

\begin_layout Itemize
\begin_inset Flex Code
status open

\begin_layout Plain Layout
all_paths
\end_layout

\end_inset

—
 The total set of paths to consider:
 
\begin_inset Flex Code
status open

\begin_layout Plain Layout
keys(tree_a) ∪ keys(tree_b)
\end_layout

\end_inset

.
\end_layout

\begin_layout Section
Design Notes
\end_layout

\begin_layout Subsection
The Fallacy of the Inode
\end_layout

\begin_layout Standard
It is conventional in UNIX environments to use a file's device and inode numbers to determine whether or not two paths refer to the same file.
 The Difference Engine does not use inode numbers for tracking files.
 The reason for this is simple:
 modern file systems lie about their inode numbers 
\begin_inset Flex Emph
status open

\begin_layout Plain Layout
literally all the time
\end_layout

\end_inset

.
 Despite what POSIX says (“The 
\begin_inset Flex Code
status open

\begin_layout Plain Layout
st_ino
\end_layout

\end_inset

 and 
\begin_inset Flex Code
status open

\begin_layout Plain Layout
st_dev
\end_layout

\end_inset

 fields taken together 
\begin_inset Flex Strong
status open

\begin_layout Plain Layout
uniquely identify
\end_layout

\end_inset

 the file within the system.”) this isn't true any more,
 and hasn't been for a long time.
\end_layout

\begin_layout Standard
This particular horse has long since bolted:
 we don't need to shut the barn door,
 we need to equip the barn with RFID tags and biometric identity checks.
\end_layout

\begin_layout Subsection
Abstracting The Abstraction:
 The Universal Language of 
\begin_inset Flex Code
status open

\begin_layout Plain Layout
MountBase
\end_layout

\end_inset


\end_layout

\begin_layout Standard
The 
\begin_inset Flex Code
status open

\begin_layout Plain Layout
DiffEngine.compute_diff()
\end_layout

\end_inset

 method accepts two objects of type 
\begin_inset Flex Code
status open

\begin_layout Plain Layout
MountBase
\end_layout

\end_inset

 (defined in 
\begin_inset Flex Code
status open

\begin_layout Plain Layout
snapm.manager._mounts
\end_layout

\end_inset

) to select the file system trees for comparison.
 This abstraction is key to features like comparing against the live root file system (using the special snapshot set name 
\begin_inset Quotes eld
\end_inset

.
\begin_inset Quotes erd
\end_inset

),
 and for future support for Btrfs and arbitrary directory path comparisons.
\end_layout

\begin_layout Standard
In the common case of a real snapshot set the argument is simply the 
\begin_inset Flex Code
status open

\begin_layout Plain Layout
Mount
\end_layout

\end_inset

 instance for that snapshot set as returned by the mount manager (
\begin_inset Flex Code
status open

\begin_layout Plain Layout
Manager.mounts
\end_layout

\end_inset

).
 The 
\begin_inset Flex Code
status open

\begin_layout Plain Layout
Mount
\end_layout

\end_inset

 class is a child of 
\begin_inset Flex Code
status open

\begin_layout Plain Layout
MountBase
\end_layout

\end_inset

.
\end_layout

\begin_layout Standard
For the system comparison (
\begin_inset Quotes eld
\end_inset

.
\begin_inset Quotes erd
\end_inset

) case,
 the argument is the sole instance of 
\begin_inset Flex Code
status open

\begin_layout Plain Layout
SysMount
\end_layout

\end_inset

:
 a second child class of 
\begin_inset Flex Code
status open

\begin_layout Plain Layout
MountBase
\end_layout

\end_inset

 that implements the required interface while representing the system root file system mounted at 
\begin_inset Quotes eld
\end_inset


\begin_inset Flex Code
status open

\begin_layout Plain Layout
/
\end_layout

\end_inset


\begin_inset Quotes erd
\end_inset

.
\end_layout

\begin_layout Standard
A future 
\begin_inset Flex Code
status open

\begin_layout Plain Layout
FakeMount
\end_layout

\end_inset

 class will allow the possibility of passing in arbitrary paths (that need not even be mount points - for example,
 Btrfs subvolume paths).
\end_layout

\begin_layout Standard
For further information refer to the GitHub issue tracker:
\begin_inset Newline newline
\end_inset


\begin_inset Flex URL
status open

\begin_layout Plain Layout

https://github.com/snapshotmanager/snapm/issues/738
\end_layout

\end_inset


\end_layout

\begin_layout Subsection
Why Sort the Paths?
\end_layout

\begin_layout Standard
The algorithm sorts 
\begin_inset Flex Code
status open

\begin_layout Plain Layout
all_paths
\end_layout

\end_inset

 before iteration.
 This isn't strictly necessary for correctness,
 but it provides:
\end_layout

\begin_layout Enumerate
\begin_inset Flex Emph
status open

\begin_layout Plain Layout
Deterministic output
\end_layout

\end_inset

 —
 Given the same inputs,
 the diff records appear in the same order,
 making testing and debugging vastly easier.
\end_layout

\begin_layout Enumerate
\begin_inset Flex Emph
status open

\begin_layout Plain Layout
Human readable output
\end_layout

\end_inset

 —
 When rendered as a tree or list,
 paths appear in lexicographic order,
 matching user expectations.
\end_layout

\begin_layout Enumerate
\begin_inset Flex Emph
status open

\begin_layout Plain Layout
Locality of reference
\end_layout

\end_inset

 —
 Files in the same directory are processed consecutively,
 which can improve cache behaviour when generating content diffs that read from disk.
\end_layout

\begin_layout Subsection
Why Prune 
\begin_inset Flex Code
status open

\begin_layout Plain Layout
ADDED
\end_layout

\end_inset

/
\begin_inset Flex Code
status open

\begin_layout Plain Layout
REMOVED
\end_layout

\end_inset

 Records?
\end_layout

\begin_layout Standard
When a move is detected,
 the algorithm creates a new 
\begin_inset Flex Code
status open

\begin_layout Plain Layout
MOVED
\end_layout

\end_inset

 record and marks the original 
\begin_inset Flex Code
status open

\begin_layout Plain Layout
ADDED
\end_layout

\end_inset

 and 
\begin_inset Flex Code
status open

\begin_layout Plain Layout
REMOVED
\end_layout

\end_inset

 records for removal.
 This prevents the output from containing redundant information.
\end_layout

\begin_layout Standard
Without pruning:
\end_layout

\begin_layout Standard
\begin_inset VSpace defskip
\end_inset


\end_layout

\begin_layout Standard
\begin_inset Box Frameless
position "t"
hor_pos "c"
has_inner_box 1
inner_pos "t"
use_parbox 0
use_makebox 0
width "100col%"
special "none"
height "1in"
height_special "totalheight"
thickness "0.4pt"
separation "3pt"
shadowsize "4pt"
framecolor "default"
backgroundcolor "none"
status open

\begin_layout Plain Layout
\begin_inset Flex Code
status open

\begin_layout Plain Layout
REMOVED:
 /old/path/config.yaml
\begin_inset Newline newline
\end_inset

ADDED:
 /new/path/config.yaml
\begin_inset Newline newline
\end_inset

MOVED:
 /old/path/config.yaml → /new/path/config.yaml
\end_layout

\end_inset


\end_layout

\end_inset


\end_layout

\begin_layout Standard
\begin_inset VSpace defskip
\end_inset


\end_layout

\begin_layout Standard
With pruning:
\end_layout

\begin_layout Standard
\begin_inset VSpace defskip
\end_inset


\end_layout

\begin_layout Standard
\begin_inset Box Frameless
position "t"
hor_pos "c"
has_inner_box 1
inner_pos "t"
use_parbox 0
use_makebox 0
width "100col%"
special "none"
height "1in"
height_special "totalheight"
thickness "0.4pt"
separation "3pt"
shadowsize "4pt"
framecolor "default"
backgroundcolor "none"
status open

\begin_layout Plain Layout
\begin_inset Flex Code
status open

\begin_layout Plain Layout
MOVED:
 /old/path/config.yaml → /new/path/config.yaml
\end_layout

\end_inset


\end_layout

\end_inset


\end_layout

\begin_layout Standard
\begin_inset VSpace defskip
\end_inset


\end_layout

\begin_layout Standard
The pruned representation is more concise and more accurately reflects user intent.
\end_layout

\begin_layout Section
The difference engine:
 computing diffs
\end_layout

\begin_layout Subsection
\begin_inset Flex Code
status open

\begin_layout Plain Layout
DiffEngine.compute_diff()
\end_layout

\end_inset

:
 Detailed Explanation
\end_layout

\begin_layout Standard
The 
\begin_inset Flex Code
status open

\begin_layout Plain Layout
DiffEngine.compute_diff()
\end_layout

\end_inset

 method is the heart of the Difference Engine.
 Given two file system tree snapshots,
 it produces a complete manifest of what changed between them:
 files added,
 removed,
 modified,
 moved,
 or transformed into a different type entirely.
\end_layout

\begin_layout Paragraph
Formally:
\end_layout

\begin_layout Paragraph
\begin_inset Formula $compute\textunderscore\mathit{{diff}}:(Tree_{a}\times Tree_{b}\times0)→R$
\end_inset


\end_layout

\begin_layout Paragraph
Where:
\end_layout

\begin_layout Paragraph
Trees are partial functions from paths to entries:
\end_layout

\begin_layout Paragraph
\begin_inset Formula $Tree_{a},Tree_{b}∈P⇀E$
\end_inset

 
\end_layout

\begin_layout Paragraph
\begin_inset Formula $P=\left\{ p:\mathit{{isFsPath}}(p)\right\} $
\end_inset


\end_layout

\begin_layout Paragraph
\begin_inset Formula $E=\left\{ e:\mathit{{isFsEntry}}(e)\right\} $
\end_inset


\end_layout

\begin_layout Paragraph
\begin_inset Formula $O=\mathit{{DiffOptions}}$
\end_inset


\end_layout

\begin_layout Paragraph
\begin_inset Formula $R=\left\{ r_{1},r_{2},...,r_{n}\right\} $
\end_inset


\end_layout

\begin_layout Paragraph
\begin_inset Formula $r_{i}∈\mathit{{FsDiffRecord}}$
\end_inset


\end_layout

\begin_layout Paragraph
Each 
\begin_inset Flex Code
status open

\begin_layout Plain Layout
FsDiffRecord
\end_layout

\end_inset

 is a tuple:
\end_layout

\begin_layout Standard
\begin_inset Formula $r=(p,\delta,e_{old},e_{new},C)$
\end_inset


\end_layout

\begin_layout Paragraph
Where:
\end_layout

\begin_layout Paragraph
\begin_inset Formula $p∈P$
\end_inset

 The path.
\end_layout

\begin_layout Paragraph
\begin_inset Formula $\delta=\left\{ ADDED,REMOVED,MODIFIED,MOVED,TYPE\textunderscore CHANGED\right\} $
\end_inset


\end_layout

\begin_layout Paragraph
\begin_inset Formula $e_{old}∈E∪\left\{ ∅\right\} $
\end_inset

 Entry from 
\begin_inset Formula $Tree_{a}$
\end_inset

(or null)
\end_layout

\begin_layout Paragraph
\begin_inset Formula $e_{old}∈E∪\left\{ ∅\right\} $
\end_inset

 Entry from 
\begin_inset Formula $Tree_{b}$
\end_inset

(or null)
\end_layout

\begin_layout Paragraph
\begin_inset Formula $C⊆FileChange$
\end_inset

 Set of detected changes
\end_layout

\begin_layout Paragraph
\begin_inset Formula $\mathit{{FileChange}=(change\textunderscore type,}old\textunderscore value,new\textunderscore value,description)$
\end_inset

 A change tuple
\end_layout

\begin_layout Paragraph
\begin_inset Formula $\mathit{ChangeType}=\left\{ CONTENT,PERMISSION,OWNER,TIME,XATTRS,SYMLINK\right\} $
\end_inset


\end_layout

\begin_layout Subsection
Inputs
\end_layout

\begin_layout Standard
The algorithm accepts two file system trees,
 each represented as a dictionary mapping path names to 
\begin_inset Flex Code
status open

\begin_layout Plain Layout
FsEntry
\end_layout

\end_inset

 objects,
 and a 
\begin_inset Flex Code
status open

\begin_layout Plain Layout
DiffOptions
\end_layout

\end_inset

 instance to control the process:
\end_layout

\begin_layout Itemize
\begin_inset Flex Code
status open

\begin_layout Plain Layout
tree_a
\end_layout

\end_inset

 —
 The "before" state (e.g.,
 snapshot at time T₀)
\end_layout

\begin_layout Itemize
\begin_inset Flex Code
status open

\begin_layout Plain Layout
tree_b
\end_layout

\end_inset

 —
 The "after" state (e.g.,
 snapshot at time T₁)
\end_layout

\begin_layout Itemize
\begin_inset Flex Code
status open

\begin_layout Plain Layout
options
\end_layout

\end_inset

 —
 Configuration controlling what constitutes a "change" (ignore timestamps?
 ignore ownership?
 content-only mode?) and other parameters (for e.g.
 the start path for the comparison within the file system roots,
 and the lists of include/exclude glob patterns).
\end_layout

\begin_layout Standard
Each 
\begin_inset Flex Code
status open

\begin_layout Plain Layout
FsEntry
\end_layout

\end_inset

 encapsulates the metadata and (optionally) content hash of a file system object:
 its type (file,
 directory,
 symbolic link,
 block device,
 etc.),
 size,
 mode,
 ownership,
 timestamps,
 and a cryptographic hash of its contents.
 Since the hash values are not used for security purposes it is acceptable to use a weaker cryptographic hash (for e.g.
 
\begin_inset Flex Code
status open

\begin_layout Plain Layout
md5
\end_layout

\end_inset

):
 the default is 
\begin_inset Flex Code
status open

\begin_layout Plain Layout
sha256
\end_layout

\end_inset

 which matches many contemporary packaging and verification systems (for e.g.
 
\begin_inset Flex Code
status open

\begin_layout Plain Layout
RPM
\end_layout

\end_inset

).
\end_layout

\begin_layout Subsection
Outputs
\end_layout

\begin_layout Standard
An 
\begin_inset Flex Code
status open

\begin_layout Plain Layout
FsDiffResults
\end_layout

\end_inset

 container holding a list of 
\begin_inset Flex Code
status open

\begin_layout Plain Layout
FsDiffRecord
\end_layout

\end_inset

 objects.
 Each record describes a single path and its change type:
\end_layout

\begin_layout Quotation
\begin_inset VSpace defskip
\end_inset


\end_layout

\begin_layout Standard
\begin_inset Tabular
<lyxtabular version="3" rows="5" columns="2">
<features tabularvalignment="middle">
<column alignment="center" valignment="top" width="0pt">
<column alignment="center" valignment="top" width="0pt">
<row>
<cell alignment="center" valignment="top" topline="true" bottomline="true" leftline="true" usebox="none">
\begin_inset Text

\begin_layout Plain Layout
\begin_inset Flex Code
status open

\begin_layout Plain Layout
DiffType
\end_layout

\end_inset


\end_layout

\end_inset
</cell>
<cell alignment="center" valignment="top" topline="true" bottomline="true" leftline="true" rightline="true" usebox="none">
\begin_inset Text

\begin_layout Plain Layout
Meaning
\end_layout

\end_inset
</cell>
</row>
<row>
<cell alignment="center" valignment="top" topline="true" leftline="true" usebox="none">
\begin_inset Text

\begin_layout Plain Layout
\begin_inset Flex Code
status open

\begin_layout Plain Layout
ADDED
\end_layout

\end_inset


\end_layout

\end_inset
</cell>
<cell alignment="center" valignment="top" topline="true" leftline="true" rightline="true" usebox="none">
\begin_inset Text

\begin_layout Plain Layout
Path exists only in tree_b
\end_layout

\end_inset
</cell>
</row>
<row>
<cell alignment="center" valignment="top" topline="true" leftline="true" usebox="none">
\begin_inset Text

\begin_layout Plain Layout
\begin_inset Flex Code
status open

\begin_layout Plain Layout
REMOVED
\end_layout

\end_inset


\end_layout

\end_inset
</cell>
<cell alignment="center" valignment="top" topline="true" leftline="true" rightline="true" usebox="none">
\begin_inset Text

\begin_layout Plain Layout
Path exists only in tree_a
\end_layout

\end_inset
</cell>
</row>
<row>
<cell alignment="center" valignment="top" topline="true" leftline="true" usebox="none">
\begin_inset Text

\begin_layout Plain Layout
\begin_inset Flex Code
status open

\begin_layout Plain Layout
MODIFIED
\end_layout

\end_inset


\end_layout

\end_inset
</cell>
<cell alignment="center" valignment="top" topline="true" leftline="true" rightline="true" usebox="none">
\begin_inset Text

\begin_layout Plain Layout
Path exists in both,
 with detected changes
\end_layout

\end_inset
</cell>
</row>
<row>
<cell alignment="center" valignment="top" topline="true" bottomline="true" leftline="true" usebox="none">
\begin_inset Text

\begin_layout Plain Layout
\begin_inset Flex Code
status open

\begin_layout Plain Layout
TYPE_CHANGED
\end_layout

\end_inset


\end_layout

\end_inset
</cell>
<cell alignment="center" valignment="top" topline="true" bottomline="true" leftline="true" rightline="true" usebox="none">
\begin_inset Text

\begin_layout Plain Layout
The file system object type changed (e.g.,
 file → directory)
\end_layout

\end_inset
</cell>
</row>
</lyxtabular>

\end_inset


\end_layout

\begin_layout Subsection
Goals and Trade-offs
\end_layout

\begin_layout Standard
The algorithm balances several competing concerns:
\end_layout

\begin_layout Enumerate
\begin_inset Flex Emph
status open

\begin_layout Plain Layout
Correctness over speed
\end_layout

\end_inset

 —
 Every genuine change must be detected.
 A missed change could mean silent data loss during a rollback.
\end_layout

\begin_layout Enumerate
\begin_inset Flex Emph
status open

\begin_layout Plain Layout
Move detection as a first-class citizen 
\end_layout

\end_inset

—
 Many "delete + create" pairs are actually renames or relocations.
 Detecting these provides clearer,
 more actionable output.
 However,
 move detection requires additional work beyond simple set-difference.
\end_layout

\begin_layout Enumerate
\begin_inset Flex Emph
status open

\begin_layout Plain Layout
Memory vs.
 time
\end_layout

\end_inset

 —
 The naive approach to move detection (compare every removed file against every added file) is O(n²).
 We trade memory for time by building hash-indexed lookup structures.
\end_layout

\begin_layout Enumerate
\begin_inset Flex Emph
status open

\begin_layout Plain Layout
Configurability
\end_layout

\end_inset

 —
 Not every change is interesting in every context.
 System administrators may want to ignore ownership changes;
 package verifiers may care only about content.
 Options allow filtering at detection time rather than in post-processing.
\end_layout

\begin_layout Subsection
Algorithm in pseudo code
\end_layout

\begin_layout Standard
The following uses mathematical notation where helpful.
 Conventions:
\end_layout

\begin_layout Itemize
∅ —
 the empty set
\end_layout

\begin_layout Itemize
∈ —
 set membership ("is element of")
\end_layout

\begin_layout Itemize
∉ —
 not a member
\end_layout

\begin_layout Itemize
∪ —
 set union
\end_layout

\begin_layout Itemize
∃ —
 there exists
\end_layout

\begin_layout Itemize
→ —
 maps to / produces
\end_layout

\begin_layout Itemize
← —
 let / assignment
\end_layout

\begin_layout Itemize
H(x) —
 content hash function applied to entry x
\end_layout

\begin_layout Standard
\begin_inset ERT
status open

\begin_layout Plain Layout


\backslash
verbatiminput{source/compute_diff.pseudo}
\end_layout

\end_inset


\end_layout

\begin_layout Subsection
Complexity Analysis
\end_layout

\begin_layout Subsubsection
\begin_inset Flex Emph
status open

\begin_layout Plain Layout
Phase 1
\end_layout

\end_inset

:
 Path Comparison
\end_layout

\begin_layout Standard
Let 
\begin_inset Formula $n=|tree_{a}|+|tree_{b}|$
\end_inset

(total entries across both trees).
\end_layout

\begin_layout Quotation
\begin_inset VSpace defskip
\end_inset


\end_layout

\begin_layout Standard
\begin_inset Tabular
<lyxtabular version="3" rows="6" columns="2">
<features tabularvalignment="middle">
<column alignment="center" valignment="top" width="0pt">
<column alignment="center" valignment="top" width="0pt">
<row>
<cell alignment="center" valignment="top" topline="true" bottomline="true" leftline="true" usebox="none">
\begin_inset Text

\begin_layout Plain Layout
Operation
\end_layout

\end_inset
</cell>
<cell alignment="center" valignment="top" topline="true" bottomline="true" leftline="true" rightline="true" usebox="none">
\begin_inset Text

\begin_layout Plain Layout
Complexity
\end_layout

\end_inset
</cell>
</row>
<row>
<cell alignment="center" valignment="top" topline="true" leftline="true" usebox="none">
\begin_inset Text

\begin_layout Plain Layout
Computing 
\begin_inset Formula $all\textunderscore paths=keys(tree_{a})∪keys(tree_{b})$
\end_inset


\end_layout

\end_inset
</cell>
<cell alignment="center" valignment="top" topline="true" leftline="true" rightline="true" usebox="none">
\begin_inset Text

\begin_layout Plain Layout
\begin_inset Formula $O(n)$
\end_inset


\end_layout

\end_inset
</cell>
</row>
<row>
<cell alignment="center" valignment="top" topline="true" leftline="true" usebox="none">
\begin_inset Text

\begin_layout Plain Layout
Sorting 
\begin_inset Flex Code
status open

\begin_layout Plain Layout
all_paths
\end_layout

\end_inset


\end_layout

\end_inset
</cell>
<cell alignment="center" valignment="top" topline="true" leftline="true" rightline="true" usebox="none">
\begin_inset Text

\begin_layout Plain Layout
\begin_inset Formula $O(n\log n)$
\end_inset


\end_layout

\end_inset
</cell>
</row>
<row>
<cell alignment="center" valignment="top" topline="true" leftline="true" usebox="none">
\begin_inset Text

\begin_layout Plain Layout
Iterating sorted paths
\end_layout

\end_inset
</cell>
<cell alignment="center" valignment="top" topline="true" leftline="true" rightline="true" usebox="none">
\begin_inset Text

\begin_layout Plain Layout
\begin_inset Formula $O(n)$
\end_inset


\end_layout

\end_inset
</cell>
</row>
<row>
<cell alignment="center" valignment="top" topline="true" leftline="true" usebox="none">
\begin_inset Text

\begin_layout Plain Layout
Dictionary look-ups (
\begin_inset Flex Code
status open

\begin_layout Plain Layout
tree_a.get(path)
\end_layout

\end_inset

,
 
\begin_inset Flex Code
status open

\begin_layout Plain Layout
tree_b.get(path)
\end_layout

\end_inset

)
\end_layout

\end_inset
</cell>
<cell alignment="center" valignment="top" topline="true" leftline="true" rightline="true" usebox="none">
\begin_inset Text

\begin_layout Plain Layout
\begin_inset Formula $O(1)$
\end_inset


\end_layout

\end_inset
</cell>
</row>
<row>
<cell alignment="center" valignment="top" topline="true" bottomline="true" leftline="true" usebox="none">
\begin_inset Text

\begin_layout Plain Layout
Change detection per path (fixed number of field comparisons)
\end_layout

\end_inset
</cell>
<cell alignment="center" valignment="top" topline="true" bottomline="true" leftline="true" rightline="true" usebox="none">
\begin_inset Text

\begin_layout Plain Layout
\begin_inset Formula $O(1)$
\end_inset


\end_layout

\end_inset
</cell>
</row>
</lyxtabular>

\end_inset


\end_layout

\begin_layout Standard
\begin_inset Flex Emph
status open

\begin_layout Plain Layout
Phase 1
\end_layout

\end_inset

 total:
 
\begin_inset Formula $O(n\log n)$
\end_inset

 —
 dominated by the sort.
\end_layout

\begin_layout Subsubsection
\begin_inset Flex Emph
status open

\begin_layout Plain Layout
Phase 2
\end_layout

\end_inset

:
 Move Detection
\end_layout

\begin_layout Standard
Without 
\lang coptic
optimisation
\lang british
,
 detecting moves would require comparing every removed file against every added file.
 If 
\begin_inset Formula $r$
\end_inset

 files were removed and 
\begin_inset Formula $a$
\end_inset

 files were added,
 this naive approach is 
\begin_inset Formula $O(r\times a)$
\end_inset

,
 which degenerates to 
\begin_inset Formula $O(n^{2})$
\end_inset

 in the worst case (e.g.,
 renaming an entire directory tree).
\end_layout

\begin_layout Paragraph
The Hash Index Optimisation
\end_layout

\begin_layout Standard
The algorithm builds a move destination cache indexed by content hash:
\end_layout

\begin_layout Standard
\begin_inset CommandInset include
LatexCommand lstinputlisting
filename "source/hash_optimisation.py"
lstparams "breaklines=true,language=Python,numbers=left"
literal "false"

\end_inset


\begin_inset VSpace defskip
\end_inset


\end_layout

\begin_layout Standard
\begin_inset Tabular
<lyxtabular version="3" rows="6" columns="2">
<features tabularvalignment="middle">
<column alignment="center" valignment="top" width="0pt">
<column alignment="center" valignment="top" width="0pt">
<row>
<cell alignment="center" valignment="top" topline="true" bottomline="true" leftline="true" usebox="none">
\begin_inset Text

\begin_layout Plain Layout
Operation
\end_layout

\end_inset
</cell>
<cell alignment="center" valignment="top" topline="true" bottomline="true" leftline="true" rightline="true" usebox="none">
\begin_inset Text

\begin_layout Plain Layout
Complexity
\end_layout

\end_inset
</cell>
</row>
<row>
<cell alignment="center" valignment="top" topline="true" leftline="true" usebox="none">
\begin_inset Text

\begin_layout Plain Layout
Building 
\begin_inset Flex Code
status open

\begin_layout Plain Layout
dest_hashes
\end_layout

\end_inset

(single pass over 
\begin_inset Flex Code
status open

\begin_layout Plain Layout
tree_b
\end_layout

\end_inset

)
\end_layout

\end_inset
</cell>
<cell alignment="center" valignment="top" topline="true" leftline="true" rightline="true" usebox="none">
\begin_inset Text

\begin_layout Plain Layout
\begin_inset Formula $O(n)$
\end_inset


\end_layout

\end_inset
</cell>
</row>
<row>
<cell alignment="center" valignment="top" topline="true" leftline="true" usebox="none">
\begin_inset Text

\begin_layout Plain Layout
Building 
\begin_inset Flex Code
status open

\begin_layout Plain Layout
added_paths
\end_layout

\end_inset

,
 
\begin_inset Flex Code
status open

\begin_layout Plain Layout
removed_paths
\end_layout

\end_inset

,
 
\begin_inset Flex Code
status open

\begin_layout Plain Layout
changed_paths
\end_layout

\end_inset

(single pass over 
\begin_inset Flex Code
status open

\begin_layout Plain Layout
diffs
\end_layout

\end_inset

)
\end_layout

\end_inset
</cell>
<cell alignment="center" valignment="top" topline="true" leftline="true" rightline="true" usebox="none">
\begin_inset Text

\begin_layout Plain Layout
\begin_inset Formula $O(n)$
\end_inset


\end_layout

\end_inset
</cell>
</row>
<row>
<cell alignment="center" valignment="top" topline="true" leftline="true" usebox="none">
\begin_inset Text

\begin_layout Plain Layout
Building d
\begin_inset Flex Code
status open

\begin_layout Plain Layout
iff_map
\end_layout

\end_inset

 (single pass over 
\begin_inset Flex Code
status open

\begin_layout Plain Layout
diffs
\end_layout

\end_inset

)
\end_layout

\end_inset
</cell>
<cell alignment="center" valignment="top" topline="true" leftline="true" rightline="true" usebox="none">
\begin_inset Text

\begin_layout Plain Layout
\begin_inset Formula $O(n)$
\end_inset


\end_layout

\end_inset
</cell>
</row>
<row>
<cell alignment="center" valignment="top" topline="true" leftline="true" usebox="none">
\begin_inset Text

\begin_layout Plain Layout
Looking up candidates by hash
\end_layout

\end_inset
</cell>
<cell alignment="center" valignment="top" topline="true" leftline="true" rightline="true" usebox="none">
\begin_inset Text

\begin_layout Plain Layout
\begin_inset Formula $O(1)$
\end_inset

 average
\end_layout

\end_inset
</cell>
</row>
<row>
<cell alignment="center" valignment="top" topline="true" bottomline="true" leftline="true" usebox="none">
\begin_inset Text

\begin_layout Plain Layout
Iterating 
\begin_inset Flex Code
status open

\begin_layout Plain Layout
tree_a
\end_layout

\end_inset

 entries
\end_layout

\end_inset
</cell>
<cell alignment="center" valignment="top" topline="true" bottomline="true" leftline="true" rightline="true" usebox="none">
\begin_inset Text

\begin_layout Plain Layout
\begin_inset Formula $O(n)$
\end_inset


\end_layout

\end_inset
</cell>
</row>
</lyxtabular>

\end_inset


\end_layout

\begin_layout Standard
\begin_inset Flex Emph
status open

\begin_layout Plain Layout
Phase 2
\end_layout

\end_inset

 total:
 
\begin_inset Formula $O(n)$
\end_inset

 —
 linear in the number of file system entries.
\end_layout

\begin_layout Subsubsection
Overall Complexity
\end_layout

\begin_layout Standard
\begin_inset Formula $O(n\log n)$
\end_inset

 —
 dominated by the path sort in 
\begin_inset Flex Emph
status open

\begin_layout Plain Layout
Phase 1
\end_layout

\end_inset

.
\end_layout

\begin_layout Subsubsection
Memory Trade-offs
\end_layout

\begin_layout Standard
The 
\begin_inset Formula $O(n)$
\end_inset

 time complexity for the move detection comes at a cost.
 Let 
\begin_inset Formula $m=|moves|$
\end_inset

 (total number of moves,
 where 
\begin_inset Formula $m\leqslant$
\end_inset

n):
\end_layout

\begin_layout Quotation
\begin_inset VSpace defskip
\end_inset


\end_layout

\begin_layout Quotation
\begin_inset Tabular
<lyxtabular version="3" rows="8" columns="3">
<features tabularvalignment="middle">
<column alignment="center" valignment="top" width="0pt">
<column alignment="center" valignment="top" width="0pt">
<column alignment="center" valignment="top" width="0pt">
<row>
<cell alignment="center" valignment="top" topline="true" bottomline="true" leftline="true" usebox="none">
\begin_inset Text

\begin_layout Plain Layout
Structure
\end_layout

\end_inset
</cell>
<cell alignment="center" valignment="top" topline="true" bottomline="true" leftline="true" usebox="none">
\begin_inset Text

\begin_layout Plain Layout
Space
\end_layout

\end_inset
</cell>
<cell alignment="center" valignment="top" topline="true" bottomline="true" leftline="true" rightline="true" usebox="none">
\begin_inset Text

\begin_layout Plain Layout
Purpose
\end_layout

\end_inset
</cell>
</row>
<row>
<cell alignment="center" valignment="top" topline="true" leftline="true" usebox="none">
\begin_inset Text

\begin_layout Plain Layout
\begin_inset Flex Code
status open

\begin_layout Plain Layout
dest_hashes
\end_layout

\end_inset


\end_layout

\end_inset
</cell>
<cell alignment="center" valignment="top" topline="true" leftline="true" usebox="none">
\begin_inset Text

\begin_layout Plain Layout
\begin_inset Formula $O(n)$
\end_inset


\end_layout

\end_inset
</cell>
<cell alignment="center" valignment="top" topline="true" leftline="true" rightline="true" usebox="none">
\begin_inset Text

\begin_layout Plain Layout
Hash → destination path lookup
\end_layout

\end_inset
</cell>
</row>
<row>
<cell alignment="center" valignment="top" topline="true" leftline="true" usebox="none">
\begin_inset Text

\begin_layout Plain Layout
\begin_inset Flex Code
status open

\begin_layout Plain Layout
added_paths
\end_layout

\end_inset


\end_layout

\end_inset
</cell>
<cell alignment="center" valignment="top" topline="true" leftline="true" usebox="none">
\begin_inset Text

\begin_layout Plain Layout
\begin_inset Formula $O(n)$
\end_inset


\end_layout

\end_inset
</cell>
<cell alignment="center" valignment="top" topline="true" leftline="true" rightline="true" usebox="none">
\begin_inset Text

\begin_layout Plain Layout
Quick membership test for valid move destinations
\end_layout

\end_inset
</cell>
</row>
<row>
<cell alignment="center" valignment="top" topline="true" leftline="true" usebox="none">
\begin_inset Text

\begin_layout Plain Layout
\begin_inset Flex Code
status open

\begin_layout Plain Layout
removed_paths
\end_layout

\end_inset


\end_layout

\end_inset
</cell>
<cell alignment="center" valignment="top" topline="true" leftline="true" usebox="none">
\begin_inset Text

\begin_layout Plain Layout
\begin_inset Formula $O(n)$
\end_inset


\end_layout

\end_inset
</cell>
<cell alignment="center" valignment="top" topline="true" leftline="true" rightline="true" usebox="none">
\begin_inset Text

\begin_layout Plain Layout
Quick membership test for valid move sources
\end_layout

\end_inset
</cell>
</row>
<row>
<cell alignment="center" valignment="top" topline="true" leftline="true" usebox="none">
\begin_inset Text

\begin_layout Plain Layout
\begin_inset Flex Code
status open

\begin_layout Plain Layout
changed_paths
\end_layout

\end_inset


\end_layout

\end_inset
</cell>
<cell alignment="center" valignment="top" topline="true" leftline="true" usebox="none">
\begin_inset Text

\begin_layout Plain Layout
\begin_inset Formula $O(n)$
\end_inset


\end_layout

\end_inset
</cell>
<cell alignment="center" valignment="top" topline="true" leftline="true" rightline="true" usebox="none">
\begin_inset Text

\begin_layout Plain Layout
Handle modified files that may also be move sources
\end_layout

\end_inset
</cell>
</row>
<row>
<cell alignment="center" valignment="top" topline="true" leftline="true" usebox="none">
\begin_inset Text

\begin_layout Plain Layout
\begin_inset Flex Code
status open

\begin_layout Plain Layout
diff_map
\end_layout

\end_inset


\end_layout

\end_inset
</cell>
<cell alignment="center" valignment="top" topline="true" leftline="true" usebox="none">
\begin_inset Text

\begin_layout Plain Layout
\begin_inset Formula $O(n)$
\end_inset


\end_layout

\end_inset
</cell>
<cell alignment="center" valignment="top" topline="true" leftline="true" rightline="true" usebox="none">
\begin_inset Text

\begin_layout Plain Layout
Path → diff record lookup for pruning
\end_layout

\end_inset
</cell>
</row>
<row>
<cell alignment="center" valignment="top" topline="true" leftline="true" usebox="none">
\begin_inset Text

\begin_layout Plain Layout
\begin_inset Flex Code
status open

\begin_layout Plain Layout
used_dests
\end_layout

\end_inset


\end_layout

\end_inset
</cell>
<cell alignment="center" valignment="top" topline="true" leftline="true" usebox="none">
\begin_inset Text

\begin_layout Plain Layout
\begin_inset Formula $O(m)$
\end_inset


\end_layout

\end_inset
</cell>
<cell alignment="center" valignment="top" topline="true" leftline="true" rightline="true" usebox="none">
\begin_inset Text

\begin_layout Plain Layout
Prevent double matching
\end_layout

\end_inset
</cell>
</row>
<row>
<cell alignment="center" valignment="top" topline="true" bottomline="true" leftline="true" usebox="none">
\begin_inset Text

\begin_layout Plain Layout
\begin_inset Flex Code
status open

\begin_layout Plain Layout
to_prune
\end_layout

\end_inset


\end_layout

\end_inset
</cell>
<cell alignment="center" valignment="top" topline="true" bottomline="true" leftline="true" usebox="none">
\begin_inset Text

\begin_layout Plain Layout
\begin_inset Formula $O(m)$
\end_inset


\end_layout

\end_inset
</cell>
<cell alignment="center" valignment="top" topline="true" bottomline="true" leftline="true" rightline="true" usebox="none">
\begin_inset Text

\begin_layout Plain Layout
Track records to remove post-detection
\end_layout

\end_inset
</cell>
</row>
</lyxtabular>

\end_inset


\end_layout

\begin_layout Quotation
Total auxiliary space:
 
\begin_inset Formula $O(n)$
\end_inset

.
\begin_inset Newline newline
\end_inset


\end_layout

\begin_layout Standard
This is the classic time vs.
 memory trade-off:
 we accept linear memory overhead to avoid quadratic time complexity.
 For a file system tree with millions of entries,
 the difference between 
\begin_inset Formula $O(n)$
\end_inset

 and 
\begin_inset Formula $O(n^{2})$
\end_inset

 is the difference between "completes in seconds" and "heat death of the universe."
\end_layout

\begin_layout Subsubsection
When The Trade-off Matters
\end_layout

\begin_layout Standard
Consider a package upgrade that renames a configuration directory:
\begin_inset VSpace defskip
\end_inset


\end_layout

\begin_layout Standard
\begin_inset Box Frameless
position "t"
hor_pos "c"
has_inner_box 1
inner_pos "t"
use_parbox 0
use_makebox 0
width "100col%"
special "none"
height "1in"
height_special "totalheight"
thickness "0.4pt"
separation "3pt"
shadowsize "4pt"
framecolor "default"
backgroundcolor "none"
status open

\begin_layout Plain Layout
\begin_inset Flex Code
status open

\begin_layout Plain Layout
/etc/myapp/config.d/ → /etc/myapp/conf.d/
\end_layout

\end_inset


\end_layout

\end_inset


\end_layout

\begin_layout Standard
\begin_inset VSpace defskip
\end_inset

If this directory contains 10,000 configuration files,
 the naive approach would perform 
\begin_inset Formula $10,000\times10,000=100,000,000$
\end_inset

 comparisons.
 The hash-indexed approach performs approximately 30,000 operations (three passes of 10,000 each,
 plus the 
\begin_inset Flex Code
status open

\begin_layout Plain Layout
tree_a
\end_layout

\end_inset

 iteration).
\end_layout

\begin_layout Standard
The practical speedup factor approaches 
\begin_inset Formula $n/3$
\end_inset

 —
 for large trees,
 this is the difference between interactive performance and overnight batch jobs.
\end_layout

\begin_layout Subsection
The Sibling Proximity Heuristic
\end_layout

\begin_layout Standard
Move detection decides among multiple possible candidates for a move destination using a 
\begin_inset Flex Emph
status open

\begin_layout Plain Layout
sibling proximity heuristic
\end_layout

\end_inset

:
 if more than two files have the same hash,
 then the move detector should favour the one that stayed in the same subdirectory,
 resides on the same file system or mount point,
 or that has a lexically similar name.
\end_layout

\begin_layout Standard
We use a simple and approximate string similarity metric to achieve these goals using substring comparisons and the 
\begin_inset Flex Emph
status open

\begin_layout Plain Layout
Jaccard index
\end_layout

\end_inset

.
 This is cheaper and more compact than a formal edit distance algorithm such as the 
\begin_inset Flex Emph
status open

\begin_layout Plain Layout
Levenshtein distance
\end_layout

\end_inset

 or even the 
\begin_inset Flex Emph
status open

\begin_layout Plain Layout
Jaro–Winkler
\end_layout

\end_inset

 distance and does not introduce external library dependencies.
\end_layout

\begin_layout Standard
The similarity score ranges from 0.0 (completely different) to 1.0 (identical or substring match),
 with the candidate having the highest score selected as the move destination.
\end_layout

\begin_layout Standard
The full sibling proximity algorithm is implemented in roughly fifteen lines of Python:
 the docstrings are slightly longer than the code:
\end_layout

\begin_layout Standard
\begin_inset CommandInset include
LatexCommand lstinputlisting
filename "source/sibling_proximity.py"
lstparams "breaklines=true,language=Python,numbers=left"
literal "false"

\end_inset


\end_layout

\begin_layout Section
Tree Building and Rendering
\end_layout

\begin_layout Standard
The 
\begin_inset Flex Code
status open

\begin_layout Plain Layout
snapm.fsdiff.tree
\end_layout

\end_inset

 module implements classes for building difference trees (
\begin_inset Flex Code
status open

\begin_layout Plain Layout
DiffTree
\end_layout

\end_inset

) and rendering the results as an ASCII or Unicode tree visualisation.
 In the rendered visualisation nodes are prefixed with a character inside square brackets to indicate the type of change.
 Colour coding of nodes is possible if the terminal supports colour codes (or if
\begin_inset Flex Code
status open

\begin_layout Plain Layout
--color=always
\end_layout

\end_inset

is given) using the following legend:
\end_layout

\begin_layout Itemize
\begin_inset Flex Code
status open

\begin_layout Plain Layout
[+]
\end_layout

\end_inset

 Green —
 File added
\end_layout

\begin_layout Itemize
\begin_inset Flex Code
status open

\begin_layout Plain Layout
[-]
\end_layout

\end_inset

 Red —
 File removed
\end_layout

\begin_layout Itemize
\begin_inset Flex Code
status open

\begin_layout Plain Layout
[*]
\end_layout

\end_inset

 Yellow —
 File modified
\end_layout

\begin_layout Itemize
\begin_inset Flex Code
status open

\begin_layout Plain Layout
[<]
\end_layout

\end_inset

 Cyan —
 File moved from
\end_layout

\begin_layout Itemize
\begin_inset Flex Code
status open

\begin_layout Plain Layout
[>]
\end_layout

\end_inset

 Cyan —
 File moved to
\end_layout

\begin_layout Itemize
\begin_inset Flex Code
status open

\begin_layout Plain Layout
[!]
\end_layout

\end_inset

 Blue —
 File type changed
\end_layout

\begin_layout Subsection
Tree building
\end_layout

\begin_layout Standard
Internally the tree is constructed by calling the 
\begin_inset Flex Code
status open

\begin_layout Plain Layout
DiffTree.build_tree()
\end_layout

\end_inset

 method with an 
\begin_inset Flex Code
status open

\begin_layout Plain Layout
FsDiffResults
\end_layout

\end_inset

 object argument.
 Further arguments control colour or quiet output modes,
 and allow passing an existing 
\begin_inset Flex Code
status open

\begin_layout Plain Layout
TermControl
\end_layout

\end_inset

 object to be used for constructing terminal rendering strings.
 This is an application of the 
\begin_inset Flex Emph
status open

\begin_layout Plain Layout
builder
\end_layout

\end_inset

 pattern:
 the method accepts a flat list of difference records and returns a tree-structured representation reflecting the file system directory hierarchy.
\end_layout

\begin_layout Standard
The algorithm iterates over the 
\begin_inset Flex Code
status open

\begin_layout Plain Layout
FsDiffResults
\end_layout

\end_inset

 constructing the tree using the internal 
\begin_inset Flex Code
status open

\begin_layout Plain Layout
TreeNode
\end_layout

\end_inset

 class to represent each discovered node (directory or file),
 attaching changes (
\begin_inset Flex Code
status open

\begin_layout Plain Layout
FsDiffRecord
\end_layout

\end_inset

) to nodes where they exist (unchanged nodes that are part of the tree have empty change records).
\end_layout

\begin_layout Standard
Move changes are handled specially in that they trigger bifurcation of the tree structure:
 unlike the other change types,
 a move is represented by 
\begin_inset Flex Emph
status open

\begin_layout Plain Layout
two
\end_layout

\end_inset

 nodes:
 this gives a clearer visualisation since both the source and destination of the move are displayed independently at their corresponding points in the tree.
\end_layout

\begin_layout Standard
Since the destination of a detected move may may be in another directory entirely this also required special treatment:
 if the move is within the same containing directory we can immediately attach the 
\begin_inset Flex Code
status open

\begin_layout Plain Layout
moved_to
\end_layout

\end_inset

 node to the tree.
 If it is not then we save it in a cache named 
\begin_inset Flex Code
status open

\begin_layout Plain Layout
orphan_moves
\end_layout

\end_inset

 to be reparented to its corresponding destination directory at a future time.
\end_layout

\begin_layout Standard
This reparenting takes place in two passes:
 an 
\begin_inset Flex Emph
status open

\begin_layout Plain Layout
optimistic
\end_layout

\end_inset

 pass that takes place in-line with tree building,
 and a second 
\begin_inset Flex Emph
status open

\begin_layout Plain Layout
\begin_inset Flex Code
status open

\begin_layout Plain Layout
_reparent_all_orphans()
\end_layout

\end_inset


\end_layout

\end_inset

 pass that occurs before returning the completed tree structure.
 This is necessary because for 
\begin_inset Formula $N$
\end_inset

 
\begin_inset Flex Code
status open

\begin_layout Plain Layout
FsDiffRecord
\end_layout

\end_inset

 objects the probability of encountering the appropriate parent to which to adopt the orphan varies according to the value of the iteration counter,
 
\begin_inset Formula $i$
\end_inset

,
 the move at hand,
 and the structure of the 
\begin_inset Flex Code
status open

\begin_layout Plain Layout
FsDiffRecord
\end_layout

\end_inset

 list.
\end_layout

\begin_layout Standard
Let's formalise the probability function capturing the orphan move adoption challenge:
\end_layout

\begin_layout Standard
Let 
\begin_inset Formula $N$
\end_inset

 be the number of 
\begin_inset Flex Code
status open

\begin_layout Plain Layout
FsDiffRecord
\end_layout

\end_inset

 objects to process.
 Let 
\begin_inset Formula $i$
\end_inset

 be the current iteration counter.
 Let 
\begin_inset Formula $move$
\end_inset

 be a specific orphan move instance.
 Let 
\begin_inset Formula $P(i,N,move)$
\end_inset

 be the probability of successfully placing an orphan move at iteration 
\begin_inset Formula $i$
\end_inset

,
 where 
\begin_inset Formula $i∈\left\{ 0,1,...,N\right\} $
\end_inset

.
\end_layout

\begin_layout Standard
\begin_inset VSpace defskip
\end_inset

Boundary conditions:
\end_layout

\begin_layout Enumerate
At 
\begin_inset Formula $i=0$
\end_inset

:
 
\begin_inset Formula $P(0,N,move)=1$
\end_inset


\begin_inset Newline newline
\end_inset

Rationale:
 All potential parents are yet to be encountered,
 maximum potential for optimistic adoption.
\end_layout

\begin_layout Enumerate
At 
\begin_inset Formula $i=N$
\end_inset

:
 
\begin_inset Formula $P(1,N,move)=0$
\end_inset


\begin_inset Newline newline
\end_inset

Rationale:
 No further iterations remain to place the orphan with its proper parent.
\end_layout

\begin_layout Standard
\begin_inset VSpace defskip
\end_inset


\end_layout

\begin_layout Standard
Middle iterations (
\begin_inset Formula $1\leqslant i<N)$
\end_inset

:
\end_layout

\begin_layout Standard
\begin_inset VSpace defskip
\end_inset


\end_layout

\begin_layout Standard
\begin_inset Formula $P(i,N,move)=\Phi(tree,move,i)$
\end_inset


\end_layout

\begin_layout Standard
\begin_inset VSpace defskip
\end_inset


\end_layout

\begin_layout Standard
Where 
\family roman
\series medium
\shape up
\size normal
\emph off
\nospellcheck off
\bar no
\strikeout off
\xout off
\uuline off
\uwave off
\noun off
\color none
Φ is an opaque step function whose definition depends on:
\end_layout

\begin_layout Itemize
Current tree structure
\end_layout

\begin_layout Itemize
\begin_inset Formula $move$
\end_inset

's source and destination path
\end_layout

\begin_layout Itemize
Current iteration count
\end_layout

\begin_layout Itemize
The phase of the moon and the beneficence of Eris at that particular moment
\end_layout

\begin_layout Standard
Metaphorically:
\end_layout

\begin_layout Standard
\begin_inset Formula $\Phi(tree,move,i)=f(names,chaos,\mathit{whimsy},\mathit{filesystem\textunderscore topology)}$
\end_inset


\end_layout

\begin_layout Standard
The 
\begin_inset Flex Code
status open

\begin_layout Plain Layout
_reparent_all_orphans()
\end_layout

\end_inset

 pass serves to ensure that any un-adopted orphans still present at the end of tree construction are adopted to their corresponding parents before returning the completed data structure.
\end_layout

\begin_layout Subsection
Tree rendering
\end_layout

\begin_layout Standard
The tree rendering algorithm is a classic recursive tree descent implementation that builds a string list attached to the containing 
\begin_inset Flex Code
status open

\begin_layout Plain Layout
DiffTree
\end_layout

\end_inset

 (
\begin_inset Flex Code
status open

\begin_layout Plain Layout
DiffTree._rendered
\end_layout

\end_inset

).
 Tree rendering is non-reentrant:
 only one thread may render a tree at a time.
 It is an error to call 
\begin_inset Flex Code
status open

\begin_layout Plain Layout
DiffTree.render()
\end_layout

\end_inset

 for the root node while another render is already in progress (i.e.
 
\begin_inset Flex Code
status open

\begin_layout Plain Layout
self._render
\end_layout

\end_inset

 is not 
\begin_inset Flex Code
status open

\begin_layout Plain Layout
None
\end_layout

\end_inset

):
 
\begin_inset Flex Code
status open

\begin_layout Plain Layout
RunTimeError
\end_layout

\end_inset

 is raised in this case.
\end_layout

\begin_layout Standard
The string list generated by the rendering process is joined into a single string that is returned to the caller with all necessary terminal control codes embedded:
 clients can simply 
\begin_inset Flex Code
status open

\begin_layout Plain Layout
print(tree.render())
\end_layout

\end_inset

 to display the results on the terminal.
\end_layout

\begin_layout Standard
\begin_inset ERT
status open

\begin_layout Plain Layout


\backslash
setcounter{chapter}{22}
\end_layout

\end_inset


\end_layout

\begin_layout Chapter
\begin_inset CommandInset label
LatexCommand label
name "chap:Extending"

\end_inset

Extending 
\begin_inset Flex Code
status open

\begin_layout Plain Layout
snapm
\end_layout

\end_inset


\begin_inset Foot
status open

\begin_layout Plain Layout
The 
\begin_inset Flex Emph
status open

\begin_layout Plain Layout
Official Discordian Document Numbering System
\end_layout

\end_inset

 assigns this chapter the designation III(c)/5,iv;12:23:25.
 The correlation to 
\begin_inset Quotes bld
\end_inset

Chapter 23
\begin_inset Quotes brd
\end_inset

 is left as an exercise for the reader,
 or possibly the result of apophenia,
 or both,
 or neither (perhaps it is simply an error in typesetting).
\end_layout

\end_inset


\end_layout

\begin_layout Quotation
\begin_inset Quotes bld
\end_inset

The movement grew,
 and grew,
 and grew.
 And all who could see the designs knew that they had to have been put there by a Great Force.
 
\begin_inset Quotes bls
\end_inset

Nothing but a Great Force,
\begin_inset Quotes brs
\end_inset

 said the philosophers,
 
\begin_inset Quotes bls
\end_inset

could create this immense beauty!
\begin_inset Quotes brs
\end_inset


\begin_inset Quotes brd
\end_inset

 —
 The Myth of Starbuck (The Myth of Ichabod),
 Malaclypse The Younger,
 1970.
\end_layout

\begin_layout Section
Hacking on 
\begin_inset Flex Code
status open

\begin_layout Plain Layout
snapm
\end_layout

\end_inset


\end_layout

\begin_layout Standard
The 
\begin_inset Flex Code
status open

\begin_layout Plain Layout
snapm
\end_layout

\end_inset

 code base aims to be well structured,
 commented,
 and generally pleasant to work on.
 There are relatively few 
\begin_inset Quotes bld
\end_inset

Here Be Dragons!
\begin_inset Quotes brd
\end_inset

 areas of code - and those are hopefully clearly demarcated,
 and certainly no 
\begin_inset Flex Code
status open

\begin_layout Plain Layout
/* You are not expected to understand this */
\end_layout

\end_inset

 comments.
 Our 
\begin_inset Flex Code
status open

\begin_layout Plain Layout
Scheduler
\end_layout

\end_inset

 is mercifully free from the need to perform task swapping on a PDP7.
\end_layout

\begin_layout Section
\begin_inset CommandInset label
LatexCommand label
name "sec:-Package-Logging"

\end_inset


\begin_inset Flex Code
status open

\begin_layout Plain Layout
snapm
\end_layout

\end_inset

 Package Logging
\end_layout

\begin_layout Standard
The entire 
\begin_inset Flex Code
status open

\begin_layout Plain Layout
snapm
\end_layout

\end_inset

 package (and its test suites) use the standard Python 
\begin_inset Flex Code
status open

\begin_layout Plain Layout
logging
\end_layout

\end_inset

 package.
 By convention each module imports 
\begin_inset Flex Code
status open

\begin_layout Plain Layout
logging
\end_layout

\end_inset

 independently and initialises a module-level logger by the standard 
\begin_inset Flex Code
status open

\begin_layout Plain Layout
logging.getLogger(__name__)
\end_layout

\end_inset

 incantation.
 Modules typically define local 
\begin_inset Flex Code
status open

\begin_layout Plain Layout
_log_LEVEL()
\end_layout

\end_inset

→ 
\begin_inset Flex Code
status open

\begin_layout Plain Layout
_log.LEVEL()
\end_layout

\end_inset

 aliases to alleviate some of the repetitive typing when adding log messages.
 Use the levels wisely:
\end_layout

\begin_layout Itemize
\begin_inset Flex Code
status open

\begin_layout Plain Layout
debug
\end_layout

\end_inset

 —
 low level debug output.
\end_layout

\begin_layout Itemize
\begin_inset Flex Code
status open

\begin_layout Plain Layout
info
\end_layout

\end_inset

 —
 informational messages the user might be interested in when using 
\begin_inset Flex Code
status open

\begin_layout Plain Layout
--verbose
\end_layout

\end_inset

 output.
\end_layout

\begin_layout Itemize
\begin_inset Flex Code
status open

\begin_layout Plain Layout
warn
\end_layout

\end_inset

 —
 warning messages:
 something is amiss,
 and the user should know about it,
 but it is not fatal to the current operation.
\end_layout

\begin_layout Itemize
\begin_inset Flex Code
status open

\begin_layout Plain Layout
error
\end_layout

\end_inset

 —
 Bad Things Happened:
 
\begin_inset Flex Code
status open

\begin_layout Plain Layout
snapm
\end_layout

\end_inset

 may not be able to complete the requested operation.
\end_layout

\begin_layout Subsection
\begin_inset CommandInset label
LatexCommand label
name "subsec:Subsystem-Specific-Logging"

\end_inset

Subsystem Specific Logging
\end_layout

\begin_layout Standard
There are a lot of moving parts in 
\begin_inset Flex Code
status open

\begin_layout Plain Layout
snapm
\end_layout

\end_inset

 and the logs would get rather chatty if everyone just had at it all the time.
 For this reason,
 the 
\begin_inset Flex Code
status open

\begin_layout Plain Layout
snapm
\end_layout

\end_inset

 and 
\begin_inset Flex Code
status open

\begin_layout Plain Layout
boom
\end_layout

\end_inset

 packages implement an additional layer of log filtering using 
\begin_inset Flex Emph
status open

\begin_layout Plain Layout
subsystem names
\end_layout

\end_inset

 (formerly,
 hexadecimal subsystem masks:
 see below - 
\begin_inset CommandInset ref
LatexCommand ref
reference "subsec:A-Brief-Note"
plural "false"
caps "false"
noprefix "false"
nolink "false"

\end_inset

 - for more on this).
 This allows the user to specify what subsystems they are interested in on the command line using the 
\begin_inset Flex Code
status open

\begin_layout Plain Layout
--debug
\end_layout

\end_inset

 argument:
\end_layout

\begin_layout Standard
\begin_inset VSpace defskip
\end_inset


\end_layout

\begin_layout Standard
\begin_inset Box Frameless
position "t"
hor_pos "c"
has_inner_box 1
inner_pos "t"
use_parbox 0
use_makebox 0
width "100col%"
special "none"
height "1in"
height_special "totalheight"
thickness "0.4pt"
separation "3pt"
shadowsize "4pt"
framecolor "default"
backgroundcolor "none"
status open

\begin_layout Plain Layout
\begin_inset Flex Code
status open

\begin_layout Plain Layout
-d | --debug debug_flags
\begin_inset Newline newline
\end_inset

A comma-separated list of subsystem names to enable debugging output for,
 or 'all' to enable all debugging.
 The available debug classes are:
 manager,
 command,
 report,
 schedule,
 mounts,
 fsdiff.
\end_layout

\end_inset


\end_layout

\end_inset


\end_layout

\begin_layout Standard
\begin_inset VSpace defskip
\end_inset


\end_layout

\begin_layout Standard
This reduces log clutter and allows more focused debugging when a problem is isolated to a particular subsystem or subsystems.
\end_layout

\begin_layout Standard
The subsystem specific logging function is typically named like 
\begin_inset Flex Code
status open

\begin_layout Plain Layout
_log_debug_SUBSYSTEM()
\end_layout

\end_inset

,
 for example,
 
\begin_inset Flex Code
status open

\begin_layout Plain Layout
_log_debug_command()
\end_layout

\end_inset

.
 They typically look like:
\end_layout

\begin_layout Standard
\begin_inset CommandInset include
LatexCommand lstinputlisting
filename "source/subsystem_logging.py"
lstparams "breaklines=true,language=Python,numbers=left"
literal "false"

\end_inset


\end_layout

\begin_layout Subsubsection
\begin_inset CommandInset label
LatexCommand label
name "subsec:A-Brief-Note"

\end_inset

A Brief Note About Subsystem Masks
\end_layout

\begin_layout Standard
In the beginning was 
\begin_inset Flex Code
status open

\begin_layout Plain Layout
boom
\end_layout

\end_inset

,
 and 
\begin_inset Flex Code
status open

\begin_layout Plain Layout
boom
\end_layout

\end_inset

 used power-of-two hexadecimal masks with symbolic constants in the 
\begin_inset Flex Code
status open

\begin_layout Plain Layout
boom
\end_layout

\end_inset

 package to filter log messages.
 A custom 
\begin_inset Flex Code
status open

\begin_layout Plain Layout
Logger
\end_layout

\end_inset

 subclass was defined that implemented the 
\begin_inset Flex Code
status open

\begin_layout Plain Layout
_log_debug_masked()
\end_layout

\end_inset

 method that provided the filtering.
\end_layout

\begin_layout Standard
And all was well in the world.
\end_layout

\begin_layout Standard
Then along came 
\begin_inset Flex Code
status open

\begin_layout Plain Layout
snapm
\end_layout

\end_inset

 with the same great idea.
 It turns out that when you have 
\begin_inset Flex Emph
status open

\begin_layout Plain Layout
two
\end_layout

\end_inset

 custom 
\begin_inset Flex Code
status open

\begin_layout Plain Layout
Logger
\end_layout

\end_inset

 subclasses that both packages attempt to install,
 they fight over the (process global) 
\begin_inset Flex Code
status open

\begin_layout Plain Layout
logging.setLoggerClass()
\end_layout

\end_inset

 call,
 and everything goes to heck in a handcart.
\end_layout

\begin_layout Standard
If you're lucky,
 you just lose some messages you wanted to see.
 If you're unlucky,
 the entire logging module halts and catches fire when someone tries to use a subsystem log mask that the winning 
\begin_inset Flex Code
status open

\begin_layout Plain Layout
Logger
\end_layout

\end_inset

 class doesn't know about.
 It was a mess.
 Read all the gory and awful details at 
\begin_inset Flex URL
status open

\begin_layout Plain Layout

https://github.com/snapshotmanager/snapm/issues/83
\end_layout

\end_inset

 (if you must).
\end_layout

\begin_layout Standard
Anyhow:
 this is all now thankfully fixed and both 
\begin_inset Flex Code
status open

\begin_layout Plain Layout
snapm
\end_layout

\end_inset

 and 
\begin_inset Flex Code
status open

\begin_layout Plain Layout
boom
\end_layout

\end_inset

 use a sane architecture based on individual 
\begin_inset Flex Code
status open

\begin_layout Plain Layout
logging.Filter
\end_layout

\end_inset

 subclasses that prune messages that are not selected by the current package-specific subsystem filtering list.
 See 
\begin_inset Flex URL
status open

\begin_layout Plain Layout

https://github.com/snapshotmanager/snapm/issues/521
\end_layout

\end_inset

 for more details on the implementation.
\end_layout

\begin_layout Standard
The masks are retained for backwards compatibility and the new logging code translates between the old and new representation as needed.
 Some day we will tire of maintaining all that and a major release will include a breaking change to drop all the cruft once and for all.
 Some day.
\end_layout

\begin_layout Subsubsection
Defining new subsystems
\end_layout

\begin_layout Standard
First of all:
 think really hard before doing this.
 Question the life choices that brought you to this point.
 Adding a new subsystem is a multistage process that is moderately tedious,
 and once it's done,
 we are pretty much stuck with it until the heat death of the universe.
 Choose wisely and pick good names!
\end_layout

\begin_layout Standard
The procedure is roughly as follows:
\end_layout

\begin_layout Enumerate
Pick a name for your subsystem,
 say 
\begin_inset Quotes eld
\end_inset

Quux
\begin_inset Quotes erd
\end_inset

 for this example.
 (
\begin_inset Flex Strong
status open

\begin_layout Plain Layout
DO NOT UNDER ANY CIRCUMSTANCES CALL YOUR NEW SUBSYSTEM 
\begin_inset Quotes eld
\end_inset

QUUX
\begin_inset Quotes erd
\end_inset

!
\end_layout

\end_inset

)
\end_layout

\begin_layout Enumerate
Add a new subsystem debug mask constant named like 
\begin_inset Flex Code
status open

\begin_layout Plain Layout
SNAPM_DEBUG_QUUX
\end_layout

\end_inset

 to the 
\begin_inset Flex Code
status open

\begin_layout Plain Layout
snapm._snapm
\end_layout

\end_inset

 module with a value that is double that of the previous last mask value.
 Add the new mask to the OR statement in the definition of 
\begin_inset Flex Code
status open

\begin_layout Plain Layout
SNAPM_DEBUG_ALL
\end_layout

\end_inset

.
\end_layout

\begin_layout Enumerate
Add a new subsystem name constant named like 
\begin_inset Flex Code
status open

\begin_layout Plain Layout
SNAPM_SUBSYSTEM_QUUX
\end_layout

\end_inset

 with the value 
\begin_inset Quotes eld
\end_inset


\begin_inset Flex Code
status open

\begin_layout Plain Layout
snapm.quux
\end_layout

\end_inset


\begin_inset Quotes erd
\end_inset

 to the 
\begin_inset Flex Code
status open

\begin_layout Plain Layout
snapm._snapm
\end_layout

\end_inset

 module.
\end_layout

\begin_layout Enumerate
Add both those constants to the 
\begin_inset Flex Code
status open

\begin_layout Plain Layout
snapm._snapm
\end_layout

\end_inset

 module's 
\begin_inset Flex Code
status open

\begin_layout Plain Layout
__all__
\end_layout

\end_inset

 list.
\end_layout

\begin_layout Enumerate
Import your new debug mask in 
\begin_inset Flex Code
status open

\begin_layout Plain Layout
snapm.command
\end_layout

\end_inset

.
\end_layout

\begin_layout Enumerate
Extend the 
\begin_inset Flex Code
status open

\begin_layout Plain Layout
mask_map
\end_layout

\end_inset

 dictionary in the function 
\begin_inset Flex Code
status open

\begin_layout Plain Layout
snapm.command.set_debug()
\end_layout

\end_inset

 to recognise your new subsystem.
 Make the user visible string be the same as the 
\begin_inset Flex Code
status open

\begin_layout Plain Layout
SUBSYSTEM
\end_layout

\end_inset

 constant minus the 
\begin_inset Quotes eld
\end_inset


\begin_inset Flex Code
status open

\begin_layout Plain Layout
snapm.
\end_layout

\end_inset


\begin_inset Quotes erd
\end_inset

 prefix;
 otherwise nobody will like you,
 and they will curse your new subsystem until the end of time.
\end_layout

\begin_layout Enumerate
Define your own 
\begin_inset Flex Code
status open

\begin_layout Plain Layout
_log_debug_quux()
\end_layout

\end_inset

 wrapper in your subsystem's module(s),
 using the example in 
\begin_inset CommandInset ref
LatexCommand ref
reference "subsec:Subsystem-Specific-Logging"
plural "false"
caps "false"
noprefix "false"
nolink "false"

\end_inset

 as a template.
\end_layout

\begin_layout Enumerate
Sprinkle thine subsystem with calls to 
\begin_inset Flex Code
status open

\begin_layout Plain Layout
_log_debug_quux()
\end_layout

\end_inset

 according to taste.
\end_layout

\begin_layout Enumerate
Add your new subsystem to the 
\begin_inset Flex Code
status open

\begin_layout Plain Layout
args.debug
\end_layout

\end_inset

 list in
\begin_inset Newline newline
\end_inset


\begin_inset Flex Code
status open

\begin_layout Plain Layout
CommandTestsSimple.test_set_debug_list()
\end_layout

\end_inset

 (
\begin_inset Flex Code
status open

\begin_layout Plain Layout
tests/test_command.py
\end_layout

\end_inset

).
\end_layout

\begin_layout Enumerate
Make sure all the unit tests still pass,
 especially those in 
\begin_inset Flex Code
status open

\begin_layout Plain Layout
tests.test_command
\end_layout

\end_inset

.
\end_layout

\begin_layout Standard
See 
\begin_inset Flex URL
status open

\begin_layout Plain Layout

https://github.com/snapshotmanager/snapm/commit/078fdd8
\end_layout

\end_inset

 for a relatively clean example of doing this (for the 
\begin_inset Flex Code
status open

\begin_layout Plain Layout
fsdiff
\end_layout

\end_inset

 subsystem).
\end_layout

\begin_layout Enumerate-Resume
Don't forget to add your new debug subsystem to 
\begin_inset Flex Code
status open

\begin_layout Plain Layout
snapm(8)
\end_layout

\end_inset

 like I did in that commit!
\end_layout

\begin_layout Section
Plugin architecture
\end_layout

\begin_layout Standard
The plugin interface is extensive and in some places a little subtle,
 but that reflects the complexity of the domain - it needs to abstract different kinds of block device and file system snapshot capabilities,
 and to provide a uniform interface to the 
\begin_inset Flex Code
status open

\begin_layout Plain Layout
Manager
\end_layout

\end_inset

 orchestrator so that it is not cluttered with plugin specific kludges.
\end_layout

\begin_layout Section
Writing Provider Plugins
\end_layout

\begin_layout Standard
We're not going to sugar coat it:
 writing a new provider plugin is no small undertaking.
 Expect to set aside at least a week or two to cruft together something roughly workable,
 and then a few more weeks to polish it,
 establish effective unit and integration tests,
 and validate its behaviour.
\end_layout

\begin_layout Standard
The best guide to writing a new plugin is always the existing plugins in the
\begin_inset Newline newline
\end_inset


\begin_inset Flex Code
status open

\begin_layout Plain Layout
snapm.manager.plugins
\end_layout

\end_inset

 package:
 find an existing plugin that is most similar to your goals,
 and use that as a template.
 The 
\begin_inset Flex Code
status open

\begin_layout Plain Layout
Manager
\end_layout

\end_inset

 will automatically attempt to load any modules (
\begin_inset Quotes bld
\end_inset


\begin_inset Flex Code
status open

\begin_layout Plain Layout
*.py
\end_layout

\end_inset


\begin_inset Quotes brd
\end_inset

 files) in the plugins package directory that declare valid subclasses of the 
\begin_inset Flex Code
status open

\begin_layout Plain Layout
Plugin
\end_layout

\end_inset

 type,
 so you can just
\begin_inset Newline newline
\end_inset


\begin_inset Quotes bld
\end_inset


\begin_inset Flex Code
status open

\begin_layout Plain Layout
cp snapm/manager/plugins/foo.py snapm/manager/plugins/bar.py
\end_layout

\end_inset


\begin_inset Quotes brd
\end_inset

,
 toss in a few 
\begin_inset Quotes bld
\end_inset


\begin_inset Flex Code
status open

\begin_layout Plain Layout
sed -i 's/Baz/Quux/'
\end_layout

\end_inset


\begin_inset Quotes brd
\end_inset

 or 
\begin_inset Flex Code
status open

\begin_layout Plain Layout
vim
\end_layout

\end_inset

 
\begin_inset Quotes bld
\end_inset


\begin_inset Flex Code
status open

\begin_layout Plain Layout
:%s/.../.../
\end_layout

\end_inset


\begin_inset Quotes brd
\end_inset

 commands and get started right away.
 Or you can use a real IDE to do the refactoring:
 whatever floats your boat.
\end_layout

\begin_layout Standard
Spray your new plugin liberally with debug statements - you can always drop them before submitting your work for consideration upstream,
 or retain them behind the debug logging guards discussed in 
\begin_inset CommandInset ref
LatexCommand ref
reference "sec:-Package-Logging"
plural "false"
caps "false"
noprefix "false"
nolink "false"

\end_inset

.
\end_layout

\begin_layout Subsection
The Plugin base class
\end_layout

\begin_layout Standard
TBD.
\end_layout

\begin_layout Section
The snapm Test Suites
\end_layout

\begin_layout Standard
We have three (or four - it depends how you count them) test suites for the project.
 Each is focused on a different aspect:
 unit testing,
 integration testing,
 isolated tests for things that talk to 
\begin_inset Flex Code
status open

\begin_layout Plain Layout
systemd
\end_layout

\end_inset

 over DBus,
 and end-to-end tests.
\end_layout

\begin_layout Subsection
The Basic Unit and Integration Tests (
\begin_inset Flex Code
status open

\begin_layout Plain Layout
tests/
\end_layout

\end_inset

)
\end_layout

\begin_layout Subsection
The 
\begin_inset Flex Code
status open

\begin_layout Plain Layout
container_tests
\end_layout

\end_inset

 DBus Integration Tests
\end_layout

\begin_layout Subsection
The 
\begin_inset Flex Code
status open

\begin_layout Plain Layout
virt_tests
\end_layout

\end_inset

 End-to-End Testing Framework
\end_layout

\begin_layout Standard
\begin_inset ERT
status open

\begin_layout Plain Layout


\backslash
setcounter{chapter}{36}
\end_layout

\end_inset


\end_layout

\begin_layout Part
End Matter
\end_layout

\begin_layout Chapter
\begin_inset CommandInset label
LatexCommand label
name "chap:Contributing-to"

\end_inset

Contributing to 
\begin_inset Flex Code
status open

\begin_layout Plain Layout
snapm
\end_layout

\end_inset


\end_layout

\begin_layout Quotation
\begin_inset Quotes bld
\end_inset

Personally,
 I'm a big fan of the free and open source software movement.
 People giving their time and labour away for no reward,
 solely in the interest of the betterment of humanity,
 is right up my alley!" ― Ayn Rand,
 1978.
\end_layout

\begin_layout Section
How You Can Contribute
\end_layout

\begin_layout Subsection
Writing Code
\end_layout

\begin_layout Subsection
Documentation
\end_layout

\begin_layout Subsection
Translation
\end_layout

\begin_layout Subsection
Testing
\end_layout

\begin_layout Subsection
Packaging
\end_layout

\begin_layout Section
Project Conventions
\end_layout

\begin_layout Subsection
Code Formatting
\end_layout

\begin_layout Subsection
Commit Messages,
 Keywords and The DCO
\end_layout

\begin_layout Subsection
Docstring Comments
\end_layout

\begin_layout Subsection
Test suites
\end_layout

\begin_layout Subsection
Unit Tests
\end_layout

\begin_layout Subsection
Integration Tests
\end_layout

\begin_layout Subsection
DBus Tests
\end_layout

\begin_layout Subsection
End-to-End Tests
\end_layout

\begin_layout Section
Getting Your Changes Merged
\end_layout

\begin_layout Subsection
Opening a Pull Request
\end_layout

\begin_layout Subsection
Code Reviews:
 Humans and Robots
\end_layout

\begin_layout Subsection
Rebasing,
 Squashing,
 and Force Pushes
\end_layout

\begin_layout Chapter
This Book Did Not Answer My Question
\end_layout

\begin_layout Quotation
\begin_inset Quotes bld
\end_inset

I can has cheezburger?
\begin_inset Quotes brd
\end_inset

 ― Happycat/Eric Nakagawa,
 2007.
\end_layout

\begin_layout Standard
We are genuinely sorry about that.
 We aim to be comprehensive without being overwhelming,
 but if you feel there is something missing please file an issue at 
\begin_inset Flex URL
status open

\begin_layout Plain Layout

https://github.com/bmr-cymru/the-manual/issues
\end_layout

\end_inset

 and we will happily consider it for a future revision.
\end_layout

\begin_layout Chapter
\begin_inset CommandInset label
LatexCommand label
name "chap:Future-Plans"

\end_inset

Future Plans
\end_layout

\begin_layout Quotation
\begin_inset Quotes bld
\end_inset

But how do we know when 
\begin_inset Flex Emph
status open

\begin_layout Plain Layout
irrational exuberance
\end_layout

\end_inset

 has unduly escalated asset values,
 which then become subject to unexpected and prolonged contractions?
\begin_inset Quotes brd
\end_inset

 ― Alan Greenspan,
 1996.
\end_layout

\begin_layout Standard
These are just the 
\begin_inset Flex Emph
status open

\begin_layout Plain Layout
major 
\end_layout

\end_inset

plans:
 we have plenty more fixes,
 minor enhancements and cleanups in the pipeline.
 Browse our issue tracker with the 
\begin_inset Quotes bld
\end_inset

enhancement
\begin_inset Quotes brd
\end_inset

 tag,
 or the 
\begin_inset Quotes bld
\end_inset

Feature
\begin_inset Quotes brd
\end_inset

 type to discover more:
 
\begin_inset Flex URL
status open

\begin_layout Plain Layout

https://github.com/snapshotmanager/snapm/issues
\end_layout

\end_inset

.
\end_layout

\begin_layout Section
Btrfs plugin
\end_layout

\begin_layout Standard
This is coming 
\begin_inset Flex Emph
status open

\begin_layout Plain Layout
real soon now
\end_layout

\end_inset

.
 We promise.
 See 
\begin_inset Flex URL
status open

\begin_layout Plain Layout

https://fedoraproject.org/wiki/Changes/BtrfsWithFullSystemSnapshots
\end_layout

\end_inset

 for more information on the lofty goals we have set for ourselves.
 The upstream work is tracked in 
\begin_inset Flex URL
status open

\begin_layout Plain Layout

https://github.com/snapshotmanager/snapm/issues/382
\end_layout

\end_inset

.
\end_layout

\begin_layout Section
Friendly Names for 
\begin_inset Flex Code
status open

\begin_layout Plain Layout
snapm
\end_layout

\end_inset

 snapshots
\end_layout

\begin_layout Standard
A proposal exists to optionally shunt the 
\begin_inset Flex Code
status open

\begin_layout Plain Layout
snapm
\end_layout

\end_inset

 metadata into a dark corner (LVM2 tags in the case of the 
\begin_inset Flex Code
status open

\begin_layout Plain Layout
lvm2-cow
\end_layout

\end_inset

 and 
\begin_inset Flex Code
status open

\begin_layout Plain Layout
lvm2-thin
\end_layout

\end_inset

 plugins),
 thus relieving users from the horror of the current snapshot naming convention (which is still shorter than many subsystem's device-mapper names).
 See 
\begin_inset Flex URL
status open

\begin_layout Plain Layout

https://github.com/snapshotmanager/snapm/issues/325
\end_layout

\end_inset

 for further information.
\end_layout

\begin_layout Section
Integration with 
\begin_inset Flex Code
status open

\begin_layout Plain Layout
blk-archive
\end_layout

\end_inset

/
\begin_inset Flex Code
status open

\begin_layout Plain Layout
blk-stash
\end_layout

\end_inset


\end_layout

\begin_layout Standard
We are currently collaborating with the 
\begin_inset Flex Code
status open

\begin_layout Plain Layout
blk-archive
\end_layout

\end_inset

/
\begin_inset Flex Code
status open

\begin_layout Plain Layout
blk-stash
\end_layout

\end_inset

 maintainer to potentially implement archival and send/receive support in 
\begin_inset Flex Code
status open

\begin_layout Plain Layout
snapm
\end_layout

\end_inset

.
 Exciting times.
\end_layout

\begin_layout Section
Make Timeline Classification a First-Class Feature
\end_layout

\begin_layout Standard
The hourly/daily/weekly/monthly/quarterly/yearly classification algorithm implemented in the 
\begin_inset Flex Code
status open

\begin_layout Plain Layout
Timeline
\end_layout

\end_inset

 garbage collection policy is pretty nifty:
 it would be nice to have that available for 
\begin_inset Flex Emph
status open

\begin_layout Plain Layout
all
\end_layout

\end_inset

 snapshot sets as a first-class attribute,
 
\begin_inset Flex Code
status open

\begin_layout Plain Layout
SnapshotSet.classification
\end_layout

\end_inset

.
 This is primarily a lift-and-shift refactoring.
 We hope to address it soon.
 See 
\begin_inset Flex URL
status open

\begin_layout Plain Layout

https://github.com/snapshotmanager/snapm/issues/622
\end_layout

\end_inset

 for the full details.
\end_layout

\begin_layout Section
Application Coordination (Milestone IV)
\end_layout

\begin_layout Standard
This is a Big Problem.
 RPC and APIs and protocols,
 oh my!
 We intend to explore this in the next round of major feature development:
 stay tuned!
 The upstream issue tracker is 
\begin_inset Flex URL
status open

\begin_layout Plain Layout

https://github.com/snapshotmanager/snapm/issues/54
\end_layout

\end_inset

 - but it's pretty light on committed detail right now.
\end_layout

\begin_layout Chapter
Building This Book
\end_layout

\begin_layout Quotation
\begin_inset Quotes bld
\end_inset

We're happy and tired;
 confused and depressed.
 The songs that we sing are the songs of the blessed.
\begin_inset Quotes brd
\end_inset

 —
 William Ernest Drummond,
 
\begin_inset Quotes bld
\end_inset

Hey Hey We Are Not The Monkees
\begin_inset Quotes brd
\end_inset

,
 1987.
\end_layout

\begin_layout Standard
If you really need to build or edit the documentation for yourself (for e.g.
 to test a patch or local change),
 here is a list of thing you will need:
\end_layout

\begin_layout Itemize
LyX —
 This document was written using version 2.4.4 as packaged in Fedora.
 In a pinch you could use a text editor and sheer willpower (or,
 you know,
 just edit the inodes by hand.
 With a magnet.).
\end_layout

\begin_layout Itemize
A working TeX Live installation
\end_layout

\begin_layout Itemize
Many 
\begin_inset Flex Code
status open

\begin_layout Plain Layout
texlive
\end_layout

\end_inset

 packages
\end_layout

\begin_layout Itemize
Patience
\end_layout

\begin_layout Standard
Rather than list required 
\begin_inset Flex Code
status open

\begin_layout Plain Layout
texlive
\end_layout

\end_inset

 subpackages explicitly,
 we highly recommend that you simply install all of them.
 In fact,
 install every package your distribution of choice provides - conflicts be damned.
 Life is too short to spend eternally wondering what exactly provides 
\begin_inset Flex Code
status open

\begin_layout Plain Layout
mumblefoo.sty
\end_layout

\end_inset

 at 3AM when you just wanted to fix a darned typo (in all seriousness - don't do that.
 This will try to pull in over 7000 packages.
 There are a 
\begin_inset Flex Emph
status open

\begin_layout Plain Layout
lot
\end_layout

\end_inset

 of TeX Live packages)..
\end_layout

\begin_layout Standard
In fact,
 you should familiarise yourself with the rather wonderful 
\begin_inset Flex Code
status open

\begin_layout Plain Layout
kpsewhich(1)
\end_layout

\end_inset

 command,
 from the 
\begin_inset Flex Code
status open

\begin_layout Plain Layout
texlive-kpathsea
\end_layout

\end_inset

 package,
 which can answer all these questions and more.
 It really is indispensable.
 Fedora users should refer to the following section for a simple method to install the needed packages.
 Users of other distributions may use this as a hint to which packages may be needed in any given environment.
\end_layout

\begin_layout Section
Fedora Build Dependencies
\end_layout

\begin_layout Standard
Fedora 
\begin_inset Flex Code
status open

\begin_layout Plain Layout
texlive
\end_layout

\end_inset

 packages the author used to build this version can be found in the source distribution for The Manual,
 in the file 
\begin_inset Flex Code
status open

\begin_layout Plain Layout
texlive-packages
\end_layout

\end_inset

.
 To install the required dependencies run the command:
\begin_inset VSpace defskip
\end_inset


\end_layout

\begin_layout Standard
\begin_inset Box Frameless
position "t"
hor_pos "c"
has_inner_box 1
inner_pos "t"
use_parbox 0
use_makebox 0
width "100col%"
special "none"
height "1in"
height_special "totalheight"
thickness "0.4pt"
separation "3pt"
shadowsize "4pt"
framecolor "default"
backgroundcolor "none"
status open

\begin_layout Plain Layout
\begin_inset Flex Code
status open

\begin_layout Plain Layout
$ sudu dnf -y install lyx $(cat texlive-packages)
\end_layout

\end_inset


\end_layout

\end_inset


\end_layout

\begin_layout Standard
\begin_inset VSpace defskip
\end_inset


\end_layout

\begin_layout Section
Building a PDF
\end_layout

\begin_layout Standard
With the required packages in hand,
 offer prayers to 
\begin_inset Flex Code
status open

\begin_layout Plain Layout
$DEITY
\end_layout

\end_inset

 (for values of $DEITY in the set 
\begin_inset Formula $\left\{ \mathit{Donald\:}Knuth\right\} $
\end_inset

),
 and proceed to issue the requisite 
\begin_inset Flex Code
status open

\begin_layout Plain Layout
pdflatex
\end_layout

\end_inset

 incantation,
 or better:
 select the 
\begin_inset Flex Emph
status open

\begin_layout Plain Layout
Document → View
\end_layout

\end_inset

 command in the LyX GUI which will deal with all that nasty business for you.
\end_layout

\begin_layout Chapter
Afterword
\end_layout

\begin_layout Quotation
\begin_inset Quotes bld
\end_inset

But all good things come to an end,
 often a sad angry miserable end.
 The cause for such an end can usually be whittled down to one of three things:
 money,
 sickness,
 love lost.
\begin_inset Quotes brd
\end_inset

 ― James Frey,
 
\begin_inset Quotes bld
\end_inset

Bright Shiny Morning
\begin_inset Quotes brd
\end_inset

,
 2008.
\end_layout

\begin_layout Standard
We have been following a tangled and tentative,
 stubborn and systematic path these past five years.
 The last two of which have led us up onto something resembling stable ground - we are at a point where the path continues from these sunny uplands into a netherworld of we know not what.
 New features.
 New kernels.
 New file systems.
 New ways for storage to surprise us.
\end_layout

\begin_layout Standard
For the foreseeable future there will be further releases from 
\begin_inset Flex Code
status open

\begin_layout Plain Layout
snapm
\end_layout

\end_inset

,
 
\begin_inset Flex Code
status open

\begin_layout Plain Layout
boom
\end_layout

\end_inset

,
 and whatever other names we attach to our activities.
 The documentation will never be complete.
 The bugs will never be zero.
 The RFE queue will never be empty.
 Edge cases may multiply.
\end_layout

\begin_layout Standard
The sunny uplands were never that sunny.
 The netherworld is where the work happens.
\end_layout

\begin_layout Standard
If you meet us further along - in a bug report,
 a mailing list,
 a conference hallway - be prepared.
 Our disguises may be incomplete.
 We may be tired.
 We may not have had enough coffee yet.
 We will try to help anyway.
\end_layout

\begin_layout Standard
All our past releases remain available.
 We do not believe in deletion.
\end_layout

\begin_layout Part
\start_of_appendix
Appendices
\end_layout

\begin_layout Chapter
Directories and file formats
\end_layout

\begin_layout Quotation
\begin_inset Quotes bld
\end_inset

All statements are in some sense true,
 in some sense false,
 and in some sense meaningless.
\begin_inset Quotes brd
\end_inset

 —
 Sri Syadasti,
 The Syadastan Affirmation,
 1963.
\begin_inset VSpace defskip
\end_inset


\end_layout

\begin_layout Section
/etc/snapm/snapm.conf:
 global configuration options and syntax
\end_layout

\begin_layout Section
/etc/snapm/plugins.d/:
 per-plugin configuration files,
 naming convention,
 available options
\end_layout

\begin_layout Section
/etc/snapm/schedule.d/:
 schedule definition files,
 schema reference,
 required and optional fields
\end_layout

\begin_layout Section
/run/snapm/lock:
 the lock file preventing concurrent operations
\end_layout

\begin_layout Section
/run/snapm/mounts/:
 mount point hierarchy for mounted snapsets
\end_layout

\begin_layout Section
/var/cache/snapm/diffcache:
 difference engine cache location and format
\end_layout

\begin_layout Chapter
Output and reporting formats
\end_layout

\begin_layout Quotation
\begin_inset Quotes bld
\end_inset


\nospellcheck on
ΤΗΙ
\nospellcheck default
 
\nospellcheck on
ΚΑΛΛΙΣΤΗΙ
\nospellcheck default
!
\begin_inset Quotes brd
\end_inset

 (
\begin_inset Quotes bld
\end_inset

To the prettiest one!
\begin_inset Quotes brd
\end_inset

) —
 Eris,
 Greek goddess of discord,
 date unknown.
\begin_inset VSpace defskip
\end_inset


\end_layout

\begin_layout Section
Reports
\end_layout

\begin_layout Subsection
The 
\begin_inset Flex Code
status open

\begin_layout Plain Layout
snapset list
\end_layout

\end_inset

 report
\end_layout

\begin_layout Subsection
The 
\begin_inset Flex Code
status open

\begin_layout Plain Layout
snapshot list
\end_layout

\end_inset

 report
\end_layout

\begin_layout Subsection
The 
\begin_inset Flex Code
status open

\begin_layout Plain Layout
schedule list 
\end_layout

\end_inset

report
\end_layout

\begin_layout Subsection
The 
\begin_inset Flex Code
status open

\begin_layout Plain Layout
diffreport
\end_layout

\end_inset


\end_layout

\begin_layout Section
Output For Robots:
 The JSON formats
\end_layout

\begin_layout Section
On report commands and 
\begin_inset Flex Code
status open

\begin_layout Plain Layout
–-json
\end_layout

\end_inset


\end_layout

\begin_layout Subsection
The 
\begin_inset Flex Code
status open

\begin_layout Plain Layout
snapset list –-json
\end_layout

\end_inset

 format
\end_layout

\begin_layout Subsection
The 
\begin_inset Flex Code
status open

\begin_layout Plain Layout
snapshot list –-json
\end_layout

\end_inset

 format
\end_layout

\begin_layout Subsection
The 
\begin_inset Flex Code
status open

\begin_layout Plain Layout
schedule list –-json
\end_layout

\end_inset

 format
\end_layout

\begin_layout Subsection
The 
\begin_inset Flex Code
status open

\begin_layout Plain Layout
diffreport –-json
\end_layout

\end_inset

 format
\end_layout

\begin_layout Section
On show commands and 
\begin_inset Flex Code
status open

\begin_layout Plain Layout
–-json
\end_layout

\end_inset


\end_layout

\begin_layout Subsection
The 
\begin_inset Flex Code
status open

\begin_layout Plain Layout
snapset show --json
\end_layout

\end_inset

 format
\end_layout

\begin_layout Subsection
The 
\begin_inset Flex Code
status open

\begin_layout Plain Layout
snapshot show –-json
\end_layout

\end_inset


\end_layout

\begin_layout Subsection
The 
\begin_inset Flex Code
status open

\begin_layout Plain Layout
schedule show –-json
\end_layout

\end_inset

 format
\end_layout

\begin_layout Section
Diff Modes.
\end_layout

\begin_layout Subsection
\begin_inset Flex Code
status open

\begin_layout Plain Layout
paths
\end_layout

\end_inset


\end_layout

\begin_layout Subsection
\begin_inset Flex Code
status open

\begin_layout Plain Layout
full
\end_layout

\end_inset


\end_layout

\begin_layout Subsection
\begin_inset Flex Code
status open

\begin_layout Plain Layout
short
\end_layout

\end_inset


\end_layout

\begin_layout Subsection
\begin_inset Flex Code
status open

\begin_layout Plain Layout
json
\end_layout

\end_inset


\end_layout

\begin_layout Subsection
\begin_inset Flex Code
status open

\begin_layout Plain Layout
diff
\end_layout

\end_inset


\end_layout

\begin_layout Subsection
\begin_inset Flex Code
status open

\begin_layout Plain Layout
summary
\end_layout

\end_inset


\end_layout

\begin_layout Subsection
\begin_inset Flex Code
status open

\begin_layout Plain Layout
tree
\end_layout

\end_inset


\end_layout

\begin_layout Standard
\begin_inset ERT
status open

\begin_layout Plain Layout


\backslash
setcounter{chapter}{25}
\end_layout

\end_inset


\end_layout

\begin_layout Chapter
The LVM Disaster Survival Guide
\end_layout

\begin_layout Quotation
\begin_inset Quotes bld
\end_inset

Take car.
 Go to mum's.
 Kill Phil.
 Grab Liz.
 Go to the Winchester.
 Have a nice cold pint.
 And wait for all this to blow over
\begin_inset Quotes brd
\end_inset

 —
 Shaun,
 
\begin_inset Quotes bld
\end_inset

Shaun of the Dead
\begin_inset Quotes brd
\end_inset

,
 by Simon Pegg and Edgar Wright,
 2004.
\end_layout

\begin_layout Standard
This chapter is not a replacement for the excellent documentation provided by the LVM2 project in the form of README files,
 manual pages,
 and release notes,
 nor for the clear distribution documentation that explains how to use the tools in practical scenarios.
 It is an addendum to these resources intended to help the reader take on a defensive posture for LVM deployments,
 and to cleanly recover from potentially disastrous situations that may occur in production environments.
\end_layout

\begin_layout Section
Before Disaster Strikes
\end_layout

\begin_layout Section
When Metadata Goes Missing
\end_layout

\begin_layout Section
When Metadata Is Corrupted
\end_layout

\begin_layout Section
Thin Pool Recovery
\end_layout

\begin_layout Section
Nuclear Options
\end_layout

\begin_layout Section
Post-Recovery Validation
\end_layout

\end_body
\end_document
